<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="24">
<Class name="TCBI.Cubes.EPVisitTestSetData">
<Description>
</Description>
<ProcedureBlock>1</ProcedureBlock>
<Super>%DeepSee.CubeDefinition</Super>
<TimeCreated>62560,55139.321732</TimeCreated>
<DependsOn>User.EPVisitTestSetData,User.EPVisitTestSet</DependsOn>

<Parameter name="DOMAIN">
</Parameter>

<XData name="Cube">
<Description>
Cube definition from Architect.</Description>
<XMLNamespace>http://www.intersystems.com/deepsee</XMLNamespace>
<Data><![CDATA[
<cube xmlns="http://www.intersystems.com/deepsee" name="EPVisitTestSetData" displayName="EPVisitTestSetData" disabled="false" abstract="false" sourceClass="User.EPVisitTestSetData" nullReplacement="Не определено" countMeasureName="%COUNT" countMeasureCaption="# тестов" bucketSize="8" bitmapChunkInMemory="false" precompute="0">
  <dimension name="TestItems" displayName="Тесты" disabled="false" hasAll="false" allCaption="All VISTDTestCodeDR" allDisplayName="VISTDTestCodeDR" type="data" iKnowType="entity" hidden="false" showHierarchies="false">
    <hierarchy name="H1" disabled="false">
      <level sourceProperty="VISTDTestCodeDR.CTTCCode" factName="DxTestItemCode" name="TestItemCode" displayName="Код теста" disabled="false" list="false" useDisplayValue="true">
      </level>
    </hierarchy>
    <hierarchy name="H2" disabled="false">
      <level sourceProperty="VISTDTestCodeDR.CTTCDesc" factName="DxTestItemDesc" name="TestItemDescription" displayName="Тест" disabled="false" list="false" useDisplayValue="true">
      </level>
    </hierarchy>
  </dimension>
  <dimension name="TestItemDetails" displayName="Тест - подробности" disabled="false" hasAll="false" allCaption="All VISTDTestCodeDR" allDisplayName="VISTDTestCodeDR" type="data" iKnowType="entity" hidden="false" showHierarchies="false">
    <hierarchy name="H1" disabled="false">
      <level sourceProperty="VISTDTestCodeDR.CTTCDepartmentDR" factName="DxTestDepartment" name="TestDepartment" displayName="Отдел" disabled="false" list="false" nullReplacement="Не определено" useDisplayValue="true">
        <property sourceProperty="VISTDTestCodeDR.CTTCDepartmentDR.CTDEPName" name="TestDepartmentName" disabled="false" hidden="false" isName="true" isReference="true" useDisplayValue="false"></property>
      </level>
    </hierarchy>
  </dimension>
  <dimension name="TestSetDataDetails" displayName="Данные по тесту - подробности" disabled="false" hasAll="false" allCaption="All CTTCCode" allDisplayName="CTTCCode" type="data" iKnowType="entity" hidden="false" showHierarchies="false">
    <hierarchy name="H1" disabled="false">
      <level sourceExpression="%cube.GetAbnormalFlag(%source.%ID)" factName="DxAbnormalFlag" name="AbnormalFlag" displayName="Флаг " disabled="false" list="false" useDisplayValue="true">
      </level>
    </hierarchy>
  </dimension>
  <dimension name="Analyzer" displayName="Анализатор" disabled="false" hasAll="false" allCaption="All New_dataDimension1" allDisplayName="New_dataDimension1" type="data" iKnowType="entity" hidden="false" showHierarchies="default">
    <hierarchy name="H1" disabled="false">
      <level sourceProperty="VISTDMachineDR.MIMPCode" factName="DxAnalyzer" name="Analyzer" displayName="Анализатор" disabled="false" list="false" nullReplacement="Ручная обработка" useDisplayValue="true">
        <property sourceProperty="VISTDMachineDR.MIMPMachineName" name="MIMPMachineName" displayName="Наименование анализатора" disabled="false" hidden="false" isName="true" isReference="true" useDisplayValue="false"></property>
      </level>
    </hierarchy>
  </dimension>
  <dimension name="FlagCalculation" displayName="Флаг вычисляемого поля" disabled="false" hasAll="false" allCaption="All New_dataDimension1" allDisplayName="New_dataDimension1" type="data" iKnowType="entity" hidden="false" showHierarchies="default">
    <hierarchy name="H1" disabled="false">
      <level sourceExpression="##class(TCBI.UtilsRu).GetFlagTestCalc(%source.%ID)" factName="DxFlagCalculation" name="FlagCalculation" displayName="Флаг вычисляемого поля" disabled="false" list="false" useDisplayValue="true">
      </level>
    </hierarchy>
  </dimension>
  <dimension name="FlagChangeResultFromMachine" displayName="Флаг изменения результата с анализатора" disabled="false" hasAll="false" allCaption="All FlagChangeResultFromMachine" allDisplayName="FlagChangeResultFromMachine" type="data" iKnowType="entity" hidden="false" showHierarchies="default">
    <hierarchy name="H1" disabled="false">
      <level sourceExpression="##class(TCBI.UtilsRu).GetFlagChangeResultFromMachine(%source.%ID,3)" factName="DxFlagChangeResultFromMachine" name="FlagChangeResultFromMachine" displayName="Флаг изменения результата с анализатора" disabled="false" list="false" rangeExpression="0:Нет изменений;1:Изменение результата анализатора вручную;2:Ошибочное удаление кода анализатора;" useDisplayValue="true">
      </level>
    </hierarchy>
  </dimension>
  <dimension name="FlagResultExist" displayName="Флаг наличия результата" disabled="false" hasAll="false" allCaption="All New_dataDimension1" allDisplayName="New_dataDimension1" type="data" iKnowType="entity" hidden="false" showHierarchies="default">
    <hierarchy name="H1" disabled="false">
      <level sourceExpression="##class(TCBI.UtilsRu).GetFlagResultExist(%source.%ID)" factName="DxFlagResultExist" name="FlagResultExist" displayName="Флаг наличия результата" disabled="false" list="false" useDisplayValue="true">
      </level>
    </hierarchy>
  </dimension>
  <measure sourceExpression="%cube.GetAbnormalFlag(%source.%ID)=&quot;A&quot;" factName="MxNumberAbnormal" name="NumberAbnormal" displayName="# тестов вне нормы" disabled="false" aggregate="SUM" type="number" hidden="false" searchable="true" iKnowSource="string"></measure>
  <measure sourceExpression="##class(TCBI.UtilsRu).GetFlagChangeResultFromMachine(%source.%ID,1)" factName="MxQTestChangeResultFromAnalyzer" name="QTestChangeResultFromAnalyzer" displayName="Кол-во тестов с результатами анализатора, исправленными  вручную" disabled="false" aggregate="SUM" type="number" hidden="false" searchable="false" iKnowSource="string"></measure>
  <measure sourceExpression="##class(TCBI.UtilsRu).GetFlagChangeResultFromMachine(%source.%ID,2)" factName="MxQTestErrorChangeResultFromAnalyzer" name="QTestErrorChangeResultFromAnalyzer" displayName="Кол-во тестов, результат по которым был получен с анализатора, а потом удалена информация, что результат получен с анализатора" description="Кол-во тестов, результат по которым был получен с анализатора, а потом удалена информация, что результат получен с анализатора" disabled="false" aggregate="SUM" type="number" hidden="false" searchable="false" iKnowSource="string"></measure>
  <relationship sourceProperty="VISTDParRef" name="EPVisitTestSet" displayName="Набор тестов" disabled="false" relatedCube="EPVisitTestSet" cardinality="one"></relationship>
  <calculatedMember name="AbnormalRatio" displayName="% тестов вне нормы" disabled="false" dimension="Measures" valueExpression="[MEASURES].[NumberAbnormal]/[MEASURES].[%COUNT]" hidden="false"></calculatedMember>
  <calculatedMember name="ChangeResultFromAnalyzerRatio" displayName="% тестов с анализатора, исправленных вручную" disabled="false" dimension="Measures" valueExpression="[MEASURES].[QTestChangeResultFromAnalyzer]/[MEASURES].[%COUNT]" hidden="false"></calculatedMember>
  <listing name="listingID" displayName="Исходные данные" disabled="true" listingType="table" fieldList="%ID"></listing>
  <listing name="listingChangeResultFromAnalyzer" displayName="Данные с анализатора изменены вручную" disabled="false" listingType="table" sql="SELECT %ID,VISTD_TestCode_DR-&gt;CTTC_Desc As Test,VISTD_TestData,VISTD_ParRef-&gt;VISTS_UserEntered_DR-&gt;SSUSR_Name from EP_VisitTestSetData WHERE %SEARCH.&amp;[[FlagChangeResultFromMachine].[H1].[FlagChangeResultFromMachine]=&quot;Изменение результата анализатора вручную&quot;]"></listing>
</cube>
]]></Data>
</XData>

<Method name="GetAbnormalFlag">
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	s returnVal=""
 	s m1=$p($g(id),"||",1)
 	s m2=$p($g(id),"||",2)
 	s m3=$p($g(id),"||",3)
 	s m4=$p($g(id),"||",4)
	;1||C020||1||C0002
	s testdata=$p($g(^TEPI(m1,1,m2,m3,"DATA",m4)),"\",1)
	if testdata'="" d 
  	.s flag=$P($G(^TTAB("TC",m4,2,testdata)),"\",1) 
  	.;s stdcomm=$G(^TTAB("TC",m4,2,testdata),"T") 
 	.s returnVal=flag
 	quit returnVal
]]></Implementation>
</Method>
</Class>
</Export>
