<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="24">
<Class name="Utils.UpgradeTCL">
<Super>%RegisteredObject</Super>
<TimeCreated>63103,59481.383603</TimeCreated>

<Method name="LoadProgs">
<Description>
Загрузка всех программ из файлов rtn из заданной директории (включая вложенные директории)
Если программа уже есть в базе данных, то не загружаем ее</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pDir:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set ok=$$$OK
	try {
		if ##class(%File).DirectoryExists(pDir) {
		       Set rs=##class(%ResultSet).%New("%File:FileSet")
	           $$$ThrowOnError(rs.Execute(pDir,"*.*"))  
               While rs.%Next() {
	              set dir=$zcvt(rs.GetData(1),"U")
	              set name=$piece(dir,"\",$length(dir,"\"))
	              if (name="LVB")||(name="SS")||(name="MVB")||(name="MIF")||(name="LBACK")||(name="AT")||(name="LHOSP") {
		             Set rs1=##class(%ResultSet).%New("%File:FileSet")
		             $$$ThrowOnError(rs1.Execute(dir,"*.*"))  
		             While rs1.%Next() {
			             set prgname=rs1.GetData(1)
			              if ..ProgExists(prgname) {
				              continue
			              }
			              //set ok=$system.OBJ.Load(prgname,"c")
			              set ok=1
			              w !,"Загрузка "_prgname_" :"_ok
		             }
		             kill rs1
	              }
               }
              
               kill rs
               
	    }
	    
	} catch(e) {
		set ok=e.AsStatus()
	}
	quit ok
]]></Implementation>
</Method>

<Method name="ProgExists">
<ClassMethod>1</ClassMethod>
<FormalSpec>pProgName:%String</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set prog=$piece(pProgName,"\",$length(pProgName,"\"))
	set prog=$piece(prog,".",1,$length(prog,".")-1)
	if $data(^rMAC(prog)) quit 1
	if $data(^rINC(prog)) quit 1
	if $data(^ROUTINE(prog)) quit 1
	if '$data(^rOBJ(prog)) quit 1  // если программа и не была загружена, то не загружаем
	quit 0
]]></Implementation>
</Method>

<Method name="WriteCourierInPatientLocation">
<Description>
Прописать курьера в PatientLocation</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pCourier:%String</FormalSpec>
<Implementation><![CDATA[
	if $get(pCourier)="" {
		write !,"Нада задать код курьера" 
		quit
	}
	set pl=""
	for {
		set pl=$order(^TTAB("RH",pl),1,rec) if pl="" quit
		set $piece(rec,"\",44)="Y"  // CTHOS_PrintEnabled
		set $piece(rec,"\",12)=pCourier  // CTHOS_CourierRun_DR
		set $piece(rec,"\",9)=1  // CTHOS_NoOfCopies
		set $piece(rec,"\",10)="I"  // CTHOS_PrintFormat_DR
		b  
		set ^TTAB("RH",pl)=rec
	}
]]></Implementation>
</Method>

<Method name="WritePrintFormatInPatientLocation">
<ClassMethod>1</ClassMethod>
<FormalSpec>pPrintFormat:%String</FormalSpec>
<Implementation><![CDATA[
	if $get(pPrintFormat)="" {
		write !,"Нада задать код формата печати" 
		quit
	}
	if '$data(^TTAB("PF",pPrintFormat)) {
		write !,"Нет такого формата печати" 
		quit
	}
	set pl=""
	for {
		set pl=$order(^TTAB("RH",pl),1,rec) if pl="" quit
		set $piece(^TTAB("RH",pl),"\",10)=pPrintFormat // CTHOS_PrintFormat_DR
		b  
	}
]]></Implementation>
</Method>
</Class>
</Export>
