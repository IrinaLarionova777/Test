<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="24">
<Routine name="LVBBBP" type="INT" languagemode="0" generated="1"><![CDATA[
LVBBBP ; IG 29/4/98 ;MVB Control code access for BBP_PackDetails
 ;
 ; supported calls:
 ;
 ; $$new^LVBBBP(mode,type)
 ; $$barcode^LVBBBP(type,code,param)
 ; $$select^LVBBBP(ROWID,skip)
 ; $$seldata^LVBBBP(ROWID,data)
 ; $$quantity^LVBBBP(product,bg,mrn,skip,unitID,site,location,status,antig,extra)
 ; $$open^LVBBBP(product,bg,mrn,skip,unitID,site,location,status,antig,extra)
 ; $$fetch^LVBBBP(product,bg,mrn,skip,unitID,site,location,status,antig,extra)
 ; $$fetchbuffer^LVBBBP(product,bg,mrn,skip,unitID,site,location,status,antig,extra)
 ; $$fetchall^LVBBBP(product,bg,mrn,skip,unitID,site,location,status,antig,extra)
 ; $$close^LVBBBP()
 ; $$check^LVBBBP(unit,si,type)
 ; $$checkID^LVBBBP(unit,checkSum)
 ; $$save^LVBBBP(units)
 ; $$insert^LVBBBP()
 ; $$update^LVBBBP(ROWID)
 ; $$xdelete^LVBBBP(ROWID,Comments)
 ; $$getall^LVBBBP(product,bg,mrn,skip,unitID,Continue)
 ; $$getall1^LVBBBP(product,bg,mrn,skip,unitID,site,location,status,vtsRID,extra)
 ; $$getall2^LVBBBP(p0,p1,mrn,p3,p4,p5,p6,p7,vtsRID,extra)
 ; $$getall3^LVBBBP(par,mrn,type)
 ; $$getall5^LVBBBP(mrn)
 ;
  ;---&SQL(DECLARE BBP1 CURSOR FOR SELECT * FROM BBP_PackDetails
   ;---         WHERE (BBP_PackID %STARTSWITH :unitID) 
   ;---         AND ((BBP_BloodProduct_DR = :product) OR (:product IS NULL))
   ;---         AND ((BBP_BloodProduct_DR->BBBP_ProductGroup_DR = :group) OR (:group IS NULL))
   ;---         AND ((BBP_BloodGroup_DR = :bg) OR (:bg IS NULL))
   ;---         AND ((BBP_do_Location_DR->BBL_UserSite_DR = :site) OR (:site IS NULL))
   ;---         AND ((BBP_do_Location_DR = :location) OR (:location IS NULL))
   ;---         AND ((BBP_do_Status_DR = :status) OR (:status IS NULL))
   ;---         AND ((BBP_do_Status_DR->BBST_StatusStock = :statStock) OR (:statStock IS NULL))
   ;---         AND ((BBP_do_PatientDebtor_DR = :mrn) OR (:mrn IS NULL))
   ;---         AND ((BBP_do_StatusReserve = :statAR) OR (:statAR IS NULL))
   ;---         ORDER BY BBP_DateExpired)
   ;--- ** SQL PUBLIC Variables: SQLCODE, bg, group, location, mrn, product, site, statAR, statStock, status, unitID
  ;---&SQL(DECLARE BBP2 CURSOR FOR SELECT * FROM BBP_PackDetails
   ;---         WHERE (BBP_PackID %STARTSWITH :unitID) 
   ;---         AND ((BBP_BloodProduct_DR = :product) OR (:product IS NULL))
   ;---         AND ((BBP_BloodProduct_DR->BBBP_ProductGroup_DR = :group) OR (:group IS NULL))
   ;---         AND ((BBP_BloodGroup_DR = :bg) OR (:bg IS NULL))
   ;---         AND ((BBP_do_Location_DR->BBL_UserSite_DR = :site) OR (:site IS NULL))
   ;---         AND ((BBP_do_Location_DR = :location) OR (:location IS NULL))
   ;---         AND ((BBP_do_Status_DR = :status) OR (:status IS NULL))
   ;---         AND ((BBP_do_Status_DR->BBST_StatusStock = :statStock) OR (:statStock IS NULL))
   ;---         AND ((BBP_do_PatientDebtor_DR = :mrn) OR (:mrn IS NULL))
   ;---         AND ((BBP_do_StatusReserve = :statAR) OR (:statAR IS NULL)))
   ;--- ** SQL PUBLIC Variables: SQLCODE, bg, group, location, mrn, product, site, statAR, statStock, status, unitID
  ;---&SQL(DECLARE BBP3 CURSOR FOR SELECT * FROM BBP_PackDetails
   ;---         WHERE ((BBP_PackID = :unitID) OR (:unitID IS NULL))
   ;---         AND ((BBP_BloodProduct_DR = :product) OR (:product IS NULL))
   ;---         AND ((BBP_BloodProduct_DR->BBBP_ProductGroup_DR = :group) OR (:group IS NULL))
   ;---         AND ((BBP_BloodGroup_DR = :bg) OR (:bg IS NULL))
   ;---         AND ((BBP_do_Location_DR->BBL_UserSite_DR = :site) OR (:site IS NULL))
   ;---         AND ((BBP_do_Location_DR = :location) OR (:location IS NULL))
   ;---         AND ((BBP_do_Status_DR = :status) OR (:status IS NULL))
   ;---         AND ((BBP_do_Status_DR->BBST_StatusStock = :statStock) OR (:statStock IS NULL))
   ;---         AND ((BBP_do_PatientDebtor_DR = :mrn) OR (:mrn IS NULL))
   ;---         AND ((BBP_do_StatusReserve = :statAR) OR (:statAR IS NULL))
   ;---         ORDER BY BBP_DateExpired)
   ;--- ** SQL PUBLIC Variables: SQLCODE, bg, group, location, mrn, product, site, statAR, statStock, status, unitID
  ;---&SQL(DECLARE BBP4 CURSOR FOR SELECT * FROM BBP_PackDetails
   ;---         WHERE ((BBP_PackID = :unitID) OR (:unitID IS NULL))
   ;---         AND ((BBP_BloodProduct_DR = :product) OR (:product IS NULL))
   ;---         AND ((BBP_BloodProduct_DR->BBBP_ProductGroup_DR = :group) OR (:group IS NULL))
   ;---         AND ((BBP_BloodGroup_DR = :bg) OR (:bg IS NULL))
   ;---         AND ((BBP_do_Location_DR->BBL_UserSite_DR = :site) OR (:site IS NULL))
   ;---         AND ((BBP_do_Location_DR = :location) OR (:location IS NULL))
   ;---         AND ((BBP_do_Status_DR = :status) OR (:status IS NULL))
   ;---         AND ((BBP_do_Status_DR->BBST_StatusStock = :statStock) OR (:statStock IS NULL))
   ;---         AND ((BBP_do_PatientDebtor_DR = :mrn) OR (:mrn IS NULL))
   ;---         AND ((BBP_do_StatusReserve = :statAR) OR (:statAR IS NULL)))
   ;--- ** SQL PUBLIC Variables: SQLCODE, bg, group, location, mrn, product, site, statAR, statStock, status, unitID
child(parent) n (parent,PLIST) s result=100 k PLIST
 i $l(parent) s cnt=0 d
 .s x1="" f  s x1=$o(^TBBPi("PARENT",parent,x1)) q:x1=""  d
 ..s x2="" f  s x2=$o(^TBBPi("PARENT",parent,x1,x2)) q:x2=""  s cnt=cnt+1,PLIST(cnt)=x1_"||"_x2,result=0
 s PLIST=$o(PLIST(""),-1)
 q result
 ; mode : PE - Pack Entry
 ;        DE - Donor Entry
new(mode,type) n (mode,type) s mode=$g(mode),type=$g(type),result=""
 s %routine=$p($g(^TTAB("REPORT-GENERIC","BBPE")),"\",1)
 i $l(%routine) s LineRoutine="new^"_%routine i $l($t(@LineRoutine)) x "s result=$$new^"_%routine_"("""_mode_""","""_type_""")"
 q result
 ; type : BG - Blood Group
 ;        BP - Blood Product
barcode(type,code,param) n (type,code,param,PLIST) k PLIST s type=$g(type),code=$g(code),param=$g(param),ok=100
 i $l(code),type="BG" d
 .i ok,$l(param) s x="" f  s x=$o(^TTAB("BB-SUP",param,"BB-BG",x)) q:x=""  i $p(^(x),"\")=code s PLIST(9)=x,ok=0 q
 .i ok s x="" f  s x=$o(^TTAB("BB-BG",x)) q:x=""  i $p(^(x),"\",4)=code s PLIST(9)=x,ok=0 q
 .i ok,$d(^TTAB("BB-BG",code)) s PLIST(9)=code,ok=0
 i $l(code),type="BP" d
 .i ok,$l(param) s x="" f  s x=$o(^TTAB("BB-SUP",param,"BB-BP",x)) q:x=""  i $p(^(x),"\")=code s PLIST(8)=x,ok=0 q
 .i ok s x="" f  s x=$o(^TTAB("BB-BP",x)) q:x=""  i $p(^(x),"\",7)=code s PLIST(8)=x,ok=0 q
 .i ok,$d(^TTAB("BB-BP",code)) s PLIST(8)=code,ok=0
 s PLIST=$o(PLIST(""),-1)
 q ok
 ;
 ; Check units with SI
 ; type : PR1 - Pack Receive check for UnitID
 ;        PR2 - Pack Receive check for Secondary ID
 ;            - Other checks
check(unit,si,type) s unit=$g(unit),si=$g(si),type=$g(type) k PLIST s PLIST=0
 i $e(type,1,2)="PR" d
 .k ^TMP($zn,$j)
 .s cnt="" f  s cnt=$o(^TBBP(unit,cnt)) q:cnt=""  d
 ..i type="PR2",$p(cnt," ")'=si q
 ..s rowid=unit_"||"_cnt
 ..s st=$$seldata(rowid,17),descr=$$seldata^LVBBBST(st,3),stat=$$seldata^LVBBBST(st,4)
 ..i $p(stat,$c(1))["IN" s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=cnt_"\"_descr q
 ..i '$$sellast^LVBBBPT(unit_"||"_cnt),$h-PLIST(4)<365 s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=cnt_"\"_descr
 .k PLIST m PLIST=^TMP($zn,$j) s PLIST=$o(PLIST(""),-1) k ^TMP($zn,$j)
 i $e(type,1,2)'="PR" d
 .s cnt="" f  s cnt=$o(^TBBP(unit,cnt)) q:cnt=""  i $e(cnt,1,$l(si))=si s PLIST=PLIST+1,PLIST(PLIST)=cnt
 q 0
 ;
 ; Check unit ID with checkSum
checkID(unit,checkSum) s unit=$$ALPHAUP^SSUTIL4($g(unit)),checkSum=$g(checkSum),ok=0
 i $l(checkSum) d
 .s sum=0 f j=1:1:$l(unit) s sum=((sum+$s($e(unit,j)?1N:$e(unit,j),1:$a($e(unit,j))-55))*2)#37
 .s sum=(38-sum)#37,ok=$s(sum<10:sum,1:$c(sum+55))
 .s ok=$s(checkSum=ok:0,1:100)
 q ok
 ; Insert the data
save(units,tags) s units=$g(units),tags=$g(tags),Sequence=PLIST(3) k ^TMP($zn,$j,"save")
 f jj1=1:1:units d
 .s (cnt,x)="" f  s x=$o(^TBBP(PLIST(2),x)) q:x=""  i $p(x," ",1)=Sequence,cnt<$p(x," ",2) s cnt=$p(x," ",2)
 .s cnt=cnt+1,PLIST(3)=Sequence_" "_cnt
 .i '$$insert(tags) s x=$o(^TMP($zn,$j,"save",""),-1)+1,^TMP($zn,$j,"save",x)=%ROWID
 k PLIST m PLIST=^TMP($zn,$j,"save") s PLIST=$o(PLIST(""),-1)
 k ^TMP($zn,$j,"save")
 q 0
 ; Insert the data
insert(tags) d pre("N") s tags=$g(tags) K PLIST(1),ROWID
 i $p(PLIST(2),"-")="{New}" s PLIST(2)=$$new($p(PLIST(2),"-",2),"N")
  ;---&SQL(insert INTO BBP_PackDetails VALUES :PLIST())
   ;--- ** SQL PUBLIC Variables: PLIST, SQLCODE
 Do %0Io
 I 'SQLCODE d clean^LVBCOM04(%ROWID) d  Q $$select(%ROWID)
 .i $l(tags) d
 ..k PLIST f j=1:1:$l(tags,",") s PLIST(j)=$p(tags,",",j)
 ..s PLIST=$o(PLIST(""),-1)
 ..i $$save^LVBBBPA(%ROWID)
 .s PARAM="\"_%ROWID_"\"_$$user^MVBSSUSR()_"\R"
 .i $$START^PRTREP00($$user^MVBSSUSR(),"",PARAM,"BBL")
 q SQLCODE_$s('SQLCODE:"",SQLCODE'=100:" "_$g(%msg)_" "_$g(%mdiag(1)),1:"")
date(rowid) s rowid=$g(rowid),result=$$seldata(rowid,13)
 q $p(result,$c(1))
checkPack(rowid) n (rowid,unitID,product,group,bg,location,status,mrn,statAR,site,statStock)
 s rowid=$g(rowid),result=100
 i '$$select(rowid,"Y") d
 .f j=1:1:PLIST s PLIST(j)=$p(PLIST(j),$c(1))
 .s xx1=$$seldata(rowid,11),xx1=$$seldata^LVBBBL(xx1,4)
 .s xx2=$$seldata(rowid,17),xx2=$$seldata^LVBBBST(xx2,4)
 .s xx3=$$seldata(rowid,8),xx3=$$seldata^LVBBBBP(xx3,24)
 .i $l(unitID),PLIST(2)'=unitID q
 .i $l(product),PLIST(8)'=product q
 .i $l(group),xx3'=group q
 .i $l(bg),PLIST(9)'=bg q
 .i $l(location),PLIST(11)'=location q
 .i $l(status),PLIST(17)'=status q
 .i $l(mrn),PLIST(6)'=mrn q
 .i $l(statAR),PLIST(7)'=statAR q
 .i $l(site),xx1'=site q
 .i $l(statStock),xx2'=statStock q
 .s result=0
 q result
 ;
 ; Update the data
update(ROWID,tags) s tags=$g(tags),ROWID=$G(ROWID) D pre("Y")
  ;---&SQL(UPDATE BBP_PackDetails VALUES :PLIST() WHERE BBP_RowID=:ROWID)
   ;--- ** SQL PUBLIC Variables: PLIST, ROWID, SQLCODE
 Do %0Ko
 I 'SQLCODE d clean^LVBCOM04(%ROWID) d  Q $$select(%ROWID)
 .i $l(tags) d
 ..k PLIST f j=1:1:$l(tags,",") s PLIST(j)=$p(tags,",",j)
 ..s PLIST=$o(PLIST(""),-1)
 ..i $$save^LVBBBPA(%ROWID)
 q SQLCODE_$s('SQLCODE:"",SQLCODE'=100:" "_$G(%msg)_" "_$g(%mdiag(1)),1:"")
 ; Delete the data
xdelete(ROWID,Comments) s ROWID=$g(ROWID),Comments=$g(Comments)
 q $$xdelete^LVBCOM04(ROWID,Comments)
 ;
 ; Open the cursor
open(product,bg,mrn,skip,unitID,site,location,status,antig,extra) 
 s product=$g(product),group=$p(product,$c(1),2),product=$p(product,$c(1))
 s bg=$g(bg),mrn=$g(mrn),skip=$g(skip),unitID=$g(unitID)
 s site=$g(site),location=$g(location),status=$g(status),antig=$g(antig),extra=$g(extra)
 s order=$p(extra,$c(1),1),expired=$p(extra,$c(1),2),partialID=$p(extra,$c(1),3)
 s statAR=$p(extra,$c(1),5),statStock=$p(extra,$c(1),6),BTags=$p(extra,$c(1),7),XM=$p(extra,$c(1),8)
 i statAR="N" s mrn=""
 i '$l(mrn) s XM=""
 k ^TMP($zn,$j,"open"),^TMP($zn,$j,"bbp")
 ; display list of packs
 i $g(PLIST) d
 .f j=1:1:PLIST s x1=$p(PLIST(j),"||",1),x2=$p(PLIST(j),"||",2) s ^TMP($zn,$j,"open"," ",x1,x2)=""
 .i $d(^TMP($zn,$j,"open")) s ^TMP($zn,$j,"open")=""
 i '$d(^TMP($zn,$j,"open")) d
 .i $l(mrn) d  q
 ..s x1="" f  s x1=$o(^TBBPi("DEBTOR",mrn,x1)) q:x1=""  d
 ...s x2="" f  s x2=$o(^TBBPi("DEBTOR",mrn,x1,x2)) q:x2=""  d
 ....s x3="" f  s x3=$o(^TBBPi("DEBTOR",mrn,x1,x2,x3)) q:x3=""  d
 .....i $$checkPack(x2_"||"_x3) q
 .....s sort="" i order=1 s sort=$$date(x2_"||"_x3)
 .....s sort=$s($l(sort):sort,1:" "),^TMP($zn,$j,"open",sort,x2,x3)=""
 ..s ^TMP($zn,$j,"open")=""
 .i '$l(XM) d  q
 ..i partialID="Y" d
 ... ;---i order=1 &SQL(OPEN BBP1)
  ... ;--- ** SQL PUBLIC Variables: SQLCODE
 ...i order=1 Do %BBP10o
 ... ;---i order'=1 &SQL(OPEN BBP2)
  ... ;--- ** SQL PUBLIC Variables: SQLCODE
 ...i order'=1 Do %BBP20o
 ..i partialID'="Y" d
 ... ;---i order=1 &SQL(OPEN BBP3)
  ... ;--- ** SQL PUBLIC Variables: SQLCODE
 ...i order=1 Do %BBP30o
 ... ;---i order'=1 &SQL(OPEN BBP4)
  ... ;--- ** SQL PUBLIC Variables: SQLCODE
 ...i order'=1 Do %BBP40o
 .i $l(XM) d  q
 ..s x1="" f  s x1=$o(^TBBPi("XM-MRN",mrn,x1)) q:x1=""  d
 ...s x2="" f  s x2=$o(^TBBPi("XM-MRN",mrn,x1,x2)) q:x2=""  d
 ....s x3="" f  s x3=$o(^TBBPi("XM-MRN",mrn,x1,x2,x3)) q:x3=""  d
 .....s x4="" f  s x4=$o(^TBBPi("XM-MRN",mrn,x1,x2,x3,x4)) q:x4=""  d
 ......s x5="" f  s x5=$o(^TBBPi("XM-MRN",mrn,x1,x2,x3,x4,x5)) q:x5=""  d
 .......i $p($g(^TEPI(x3,1,x4,x5,"BBP",x1,x2)),"\",1)=XM,mrn=$$mrn^LVBEPVIS(x3) d
 ........i $$checkPack(x1_"||"_x2) q
 ........s sort="" i order=1 s sort=$$date(x1_"||"_x2)
 ........s sort=$s($l(sort):sort,1:" "),^TMP($zn,$j,"open",sort,x1,x2)=""
 ........s ^TMP($zn,$j,"bbp",x1,x2)=x3_"||"_x4_"||"_x5
 ..s ^TMP($zn,$j,"open")=""
 q 0
 ;
 ; Fetch the data
 ; extra : 1-order       : 1 - Expired date
 ;                         2 - Unit ID
 ;         2-expired     : Y     - Display all units
 ;                         Ydate - Do not display units expired after <date>
 ;                         date  - Do not display units expired before <date>
 ;         3-partialID   : Y - Search with partial unitID
 ;                         N - Search with full unitID
 ;         4-Number of units to display
 ;         5-Reserve Status : A - Autologous
 ;                            R - Reserved
 ;                            N - Not Allocated
 ;                              - All
 ;         6-Stock Status : IN-1 - In Stock and Available
 ;                          IN-0 - In Stock and NotAvailable
 ;                          OUT  - Out of Stock
 ;                               - All
 ;         7-List of Tags(<Tag1>,<Tag2>,..,<TagN>)
 ;         8-Include XM : C - Compatible
 ;                        A - Acceptable
 ;         9-Transfusion Event
 ;        10-Continue
 ;        11-MedTrak OrderRowID
 ;        12-Electronic XM
fetch(product,bg,mrn,skip,unitID,site,location,status,antig,extra) 
 K PLIST
 s product=$g(product),group=$p(product,$c(1),2),product=$p(product,$c(1))
 s bg=$g(bg),mrn=$g(mrn),skip=$g(skip),unitID=$g(unitID)
 s site=$g(site),location=$g(location),status=$g(status),antig=$g(antig)
 s order=$p($g(extra),$c(1),1),expired=$p($g(extra),$c(1),2),partialID=$p($g(extra),$c(1),3)
 s statAR=$p($g(extra),$c(1),5),statStock=$p($g(extra),$c(1),6),BTags=$p($g(extra),$c(1),7),XM=$p($g(extra),$c(1),8)
 i statAR="N" s mrn=""
 i '$l(mrn) s XM=""
 i $d(^TMP($zn,$j,"open")) d
 .s line=$g(^TMP($zn,$j,"open")),SQLCODE=100 f j=1:1:3 s @("x"_j)=$p(line,"\",j)
 .f  d:$l(x1)  q:'SQLCODE  s x1=$o(^TMP($zn,$j,"open",x1)) q:x1=""
 ..f  d:$l(x2)  q:'SQLCODE  s x2=$o(^TMP($zn,$j,"open",x1,x2)) q:x2=""
 ...f  s x3=$o(^TMP($zn,$j,"open",x1,x2,x3)) q:x3=""  s SQLCODE=0  q
 .s ^TMP($zn,$j,"open")=x1_"\"_x2_"\"_x3
 .i 'SQLCODE,$$select(x2_"||"_x3)
 i '$d(^TMP($zn,$j,"open")) d
 .i partialID="Y" d
 .. ;---i order=1 &SQL(FETCH BBP1 INTO :PLIST())
  .. ;--- ** SQL PUBLIC Variables: PLIST, SQLCODE
 ..i order=1 Do %0Qo
 .. ;---i order'=1 &SQL(FETCH BBP2 INTO :PLIST())
  .. ;--- ** SQL PUBLIC Variables: PLIST, SQLCODE
 ..i order'=1 Do %0Ro
 .i partialID'="Y" d
 .. ;---i order=1 &SQL(FETCH BBP3 INTO :PLIST())
  .. ;--- ** SQL PUBLIC Variables: PLIST, SQLCODE
 ..i order=1 Do %0So
 .. ;---i order'=1 &SQL(FETCH BBP4 INTO :PLIST())
  .. ;--- ** SQL PUBLIC Variables: PLIST, SQLCODE
 ..i order'=1 Do %0To
 s PLIST=$o(PLIST(""),-1) 
 i 'SQLCODE,$e(expired)'="Y",PLIST(13)<expired g fetch+1
 i 'SQLCODE,$e(expired)="Y",expired'="Y",PLIST(13)>$e(expired,2,9) g fetch+1
 i 'SQLCODE,$l(BTags) d  i SQLCODE g fetch+1
 .s x1=$p(PLIST(2),$c(1),1),x2=$p(PLIST(3),$c(1),1)
 .i $l(x1),$l(x2) f j=1:1:$l(BTags,",") s tag=$p(BTags,",",j) i $l(tag),'$d(^TBBP(x1,x2,"TAG",tag)) s SQLCODE=100 q
 i 'SQLCODE,$l(antig) d  i SQLCODE g fetch+1
 .s x1=$p(PLIST(2),$c(1),1),x2=$p(PLIST(3),$c(1),1)
 .i $l(x1),$l(x2) f j=1:1:$l(antig,",") s x=$p(antig,",",j) i $l(x),$p($g(^TBBP(x1,x2,"ANT",x)),"\")'="N" s SQLCODE=100 q
 i 'SQLCODE D adjust 
 q SQLCODE 
 ; Fetch all data
fetchbuffer(product,bg,mrn,skip,unitID,site,location,status,antig,extra) k ^TMP($zn,$j,1)
 s product=$g(product),bg=$g(bg),mrn=$g(mrn),skip=$g(skip),unitID=$g(unitID)
 s site=$g(site),location=$g(location),status=$g(status),antig=$g(antig),extra=$g(extra)
 s max=$s($g(PLIST(1)):PLIST(1),1:100) i max>100 s max=100
 f xxx=1:1:max s SQLCODE=$$fetch(product,bg,mrn,skip,unitID,site,location,status,antig,extra) q:SQLCODE  d
 .s cnt=$o(^TMP($zn,$j,1,""),-1)+1 f j=1:1:PLIST s $p(^TMP($zn,$j,1,cnt),$c(28),j)=$g(PLIST(j))
 k PLIST m PLIST=^TMP($zn,$j,1) k ^TMP($zn,$j,1)
 s PLIST=$o(PLIST(""),-1)
 q SQLCODE
fetchall(product,bg,mrn,skip,unitID,site,location,status,antig,extra) K ^TMP($zn,$j,1)
 N (product,bg,mrn,skip,unitID,site,location,status,antig,extra,PLIST) 
 s product=$g(product),bg=$g(bg),units=$g(units),mrn=$g(mrn),skip=$g(skip),unitID=$g(unitID)
 s site=$g(site),location=$g(location),status=$g(status),antig=$g(antig),extra=$g(extra)
 k PLIST
 i $$open(product,bg,mrn,skip,unitID,site,location,status,antig,extra)
 f cnt=1:1 Q:$$fetch(product,bg,mrn,skip,unitID,site,location,status,antig,extra)  s ^TMP($zn,$j,1,cnt)="" f j=1:1:PLIST s $p(^TMP($zn,$j,1,cnt),$c(28),j)=$g(PLIST(j))
 i $$close()
 k PLIST M PLIST=^TMP($zn,$j,1)
 s PLIST=$o(PLIST(""),-1)
 k ^TMP($zn,$j,1)
 q 0
quantity(product,bg,mrn,skip,unitID,site,location,status,antig,extra) N (product,bg,mrn,skip,unitID,site,location,status,antig,extra,PLIST)
 s product=$g(product),bg=$g(bg),units=$g(units),mrn=$g(mrn),skip=$g(skip),unitID=$g(unitID)
 s site=$g(site),location=$g(location),status=$g(status),antig=$g(antig),extra=$g(extra)
 k PLIST
 i $$open(product,bg,mrn,skip,unitID,site,location,status,antig,extra)
 f cnt=0:1 q:$$fetch(product,bg,mrn,skip,unitID,site,location,status,antig,extra)
 i $$close()
 q cnt
 ;
 ; Close the cursor 
close()  ;---&SQL(CLOSE BBP1) 
  ;--- ** SQL PUBLIC Variables: SQLCODE
 Do %BBP10c 
  ;---&SQL(CLOSE BBP2) 
   ;--- ** SQL PUBLIC Variables: SQLCODE
 Do %BBP20c 
  ;---&SQL(CLOSE BBP3) 
   ;--- ** SQL PUBLIC Variables: SQLCODE
 Do %BBP30c 
  ;---&SQL(CLOSE BBP4) 
   ;--- ** SQL PUBLIC Variables: SQLCODE
 Do %BBP40c 
 k ^TMP($zn,$j,"open")
 k ^TMP($zn,$j,"bbp")
 q 0
 ; select data by code and field No
seldata(ROWID,data) n (ROWID,data) s ROWID=$g(ROWID),data=$g(data),result=""
 i $l(ROWID) d  q result
 .f j=1:1:2 s x(j)=$p(ROWID,"||",j)
 .i $l(x(1)),$l(x(2)),data=1 s:$d(^TBBP(x(1),1,x(2))) result=x(1)_"||"_x(2) q
 .i $l(x(1)),$l(x(2)),data=4 s result=$p($g(^TBBP(x(1),x(2))),"\",6) q
 .i $l(x(1)),$l(x(2)),data=8 s result=$p($g(^TBBP(x(1),x(2))),"\",4) q
 .i $l(x(1)),$l(x(2)),data=9 s result=$p($g(^TBBP(x(1),x(2))),"\",5) q
 .i $l(x(1)),$l(x(2)),data=11 s result=$p($g(^TBBP(x(1),x(2))),"\",8) q
 .i $l(x(1)),$l(x(2)),data=13 s result=$p($g(^TBBP(x(1),x(2))),"\",7) q
 .i $l(x(1)),$l(x(2)),data=17 s result=$p($g(^TBBP(x(1),x(2))),"\",2) q
 .i $l(x(1)),$l(x(2)),data=18 s result=$p($g(^TBBP(x(1),x(2))),"\",3) q
 .i $l(x(1)),$l(x(2)),data=24 s result=$p($g(^TBBP(x(1),x(2))),"\",20) q
 .i '$$select(ROWID,"Y") s result=$g(PLIST(data))
 q result
 ;
 ; select data by code
select(ROWID,skip) K PLIST s skip=$g(skip)
  ;---&SQL(SELECT * INTO :PLIST() FROM BBP_PackDetails WHERE BBP_RowID=:ROWID)
   ;--- ** SQL PUBLIC Variables: PLIST, ROWID, SQLCODE
 Do %0Yo
 s PLIST=$o(PLIST(""),-1)
 i 'SQLCODE D adjust
 q SQLCODE
 ;
 ; Pre-filing adjustments
pre(xUpdate) d PreSQL^SSUTIL4("20","111")
 S PLIST(2)=$$UPPER^SSUTIL4(PLIST(2))
 q
 ;
 ; Post-filing adjustments
adjust d adjust^LVBCOM04
 q
getall(product,bg,mrn,skip,unitID,Continue) n (product,bg,mrn,skip,unitID,Continue,PLIST)
 s product=$g(product),bg=$g(bg),mrn=$g(mrn),skip=$g(skip),unitID=$g(unitID),Continue=$g(Continue)
 i Continue'="Y" d
 .k ^TMP($zn,$j,"getall")
 .i $$open(product,bg,mrn,skip,unitID)
 .f cnt=1:1 q:$$fetch(product,bg,mrn,skip,unitID)  d
 ..s str="" f j=1:1:PLIST s $p(str,$c(28),j)=PLIST(j)
 ..s ^TMP($zn,$j,"getall",cnt)=$p(PLIST(1),$c(1))_$c(2)_$p(PLIST(3),$c(1))_" "_$p(PLIST(17),$c(1),2)_$c(2)_$p(PLIST(2),$c(1))_$c(2)_str
 .i $$close()
 k PLIST
 s (sum,j2)="" f j1=1:1 s j2=$o(^TMP($zn,$j,"getall",j2)) q:j2=""  q:sum+$l(^(j2))>15000  s PLIST(j1)=^(j2),sum=sum+$l(^(j2)) k ^(j2)
 s PLIST=$o(PLIST(""),-1)
 q $s($d(^TMP($zn,$j,"getall")):0,1:100)
 ; populate VISTS grid
getall1(product,bg,mrn,skip,unitID,site,location,status,vtsRID,extra) 
 n (product,bg,mrn,skip,unitID,site,location,status,vtsRID,extra,PLIST)
 s product=$g(product),bg=$g(bg),mrn=$g(mrn),skip=$g(skip),unitID=$g(unitID)
 s site=$g(site),location=$g(location),status=$g(status),vtsRID=$g(vtsRID),extra=$g(extra)
 q $$getall1^LVBCOM04(product,bg,mrn,skip,unitID,site,location,status,vtsRID,extra)
 ; get units already assigned to vtsRID
getall2(p0,p1,mrn,p3,p4,p5,p6,p7,vtsRID,extra) n (mrn,vtsRID,extra,PLIST)
 s mrn=$g(mrn),vtsRID=$g(vtsRID),extra=$g(extra)
 q $$getall2^LVBCOM04(,,mrn,,,,,,vtsRID,extra)
 ; type : 1-MRN
 ;        2-Episode
getall3(par,mrn,type) n (par,mrn,type,PLIST)
 s par=$g(par),mrn=$g(mrn),type=$g(type)
 q $$getall3^LVBCOM04(par,mrn,type)
getall5(mrn) n (mrn,PLIST) s mrn=$g(mrn)
 q $$getall5^LVBCOM04(mrn)
%BBP10o s $zt="%BBP10E" s SQLCODE=$s($g(%BBP10c):-101,1:0) q:SQLCODE'=0  s %BBP10d(84)=0 s %BBP10d(85)=0,%BBP10d(86)="",%BBP10d(87)=0,%BBP10d(88)="",%BBP10d(89)=0,%BBP10d(90)="",%BBP10d(91)=0,%BBP10d(92)=""
 s %BBP10d(48)=$g(unitID),%BBP10d(49)=$g(product),%BBP10d(50)=$g(product),%BBP10d(53)=$g(group),%BBP10d(54)=$g(group),%BBP10d(55)=$g(bg),%BBP10d(56)=$g(bg),%BBP10d(59)=$g(site),%BBP10d(60)=$g(site),%BBP10d(61)=$g(location),%BBP10d(62)=$g(location),%BBP10d(63)=$g(status),%BBP10d(64)=$g(status),%BBP10d(67)=$g(statStock),%BBP10d(68)=$g(statStock),%BBP10d(69)=$g(mrn),%BBP10d(70)=$g(mrn),%BBP10d(71)=$g(statAR),%BBP10d(72)=$g(statAR)
 s %BBP10t(1)=$i(^||%sql.temp)
 s %BBP10d(75)=$zu(28,%BBP10d(67),7)
 s %BBP10d(77)=$zu(28,%BBP10d(71),7)
 s %BBP10c=1 q
%BBP10E s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) k %BBP10c,%BBP10d,%BBP10E,%BBP10l,%BBP10n,%BBP10R,%BBP10s,%BBP10t,%BBP10Z q
%0Afirst 
 k ^||%sql.temp(%BBP10t(1),0) s ^||%sql.temp(%BBP10t(1),0)=$H_"^"_$J_"^"_$zu(67,11,$j)_"^"_$zu(67,12,$j)_"^"_$zu(67,15,$j)_"^"_$ZN_"^"_$zu(67,6,$j)
 i $sortbegin(^||%sql.temp(%BBP10t(1),0))
 ; asl MOD# 3
 d %0ABMod
 i $sortend(^||%sql.temp(%BBP10t(1),0))
 s %BBP10s(13)=""
%0ACk1 s %BBP10s(13)=$o(^||%sql.temp(%BBP10t(1),0,%BBP10s(13)))
 i %BBP10s(13)="" g %0ACdun
 s %BBP10d(13)=$s(%BBP10s(13)=-1E14:"",1:%BBP10s(13))
 s %BBP10s(1)=""
%0ACk2 s %BBP10s(1)=$o(^||%sql.temp(%BBP10t(1),0,%BBP10s(13),%BBP10s(1)))
 i %BBP10s(1)="" g %0ACk1
 s %BBP10d(1)=$s(%BBP10s(1)=-1E14:"",1:%BBP10s(1))
 s %BBP10d(2)=$p(%BBP10d(1),"||"),%BBP10d(3)=$p(%BBP10d(1),"||",2)
 i %BBP10d(2)'="",%BBP10d(3)'="",$d(^TBBP(%BBP10d(2),%BBP10d(3)))
 e  g %0ACk2
 s %BBP10d(101)=$g(^TBBP(%BBP10d(2),%BBP10d(3)))
 s %BBP10d(4)=$p(%BBP10d(101),"\",6) s %BBP10d(5)=$p(%BBP10d(101),"\",12) s %BBP10d(8)=$p(%BBP10d(101),"\",4) s %BBP10d(9)=$p(%BBP10d(101),"\",5) s %BBP10d(10)=$p(%BBP10d(101),"\",9) s %BBP10d(14)=$p(%BBP10d(101),"\",13) s %BBP10d(15)=$p(%BBP10d(101),"\",14) s %BBP10d(16)=$p(%BBP10d(101),"\",15) s %BBP10d(19)=$p(%BBP10d(101),"\",16) s %BBP10d(21)=$p(%BBP10d(101),"\",17) s %BBP10d(22)=$p(%BBP10d(101),"\",18) s %BBP10d(23)=$p(%BBP10d(101),"\",19) s %BBP10d(24)=$p(%BBP10d(101),"\",20) s %BBP10d(25)=$p(%BBP10d(101),"\",21) s %BBP10d(26)=$p(%BBP10d(101),"\",22) s %BBP10d(27)=$p(%BBP10d(101),"\",23) s %BBP10d(28)=$p(%BBP10d(101),"\",24) s %BBP10d(29)=$p(%BBP10d(101),"\",25) s %BBP10d(30)=$p(%BBP10d(101),"\",26) s %BBP10d(31)=$p(%BBP10d(101),"\",27) s %BBP10d(32)=$p(%BBP10d(101),"\",28) s %BBP10d(33)=$p(%BBP10d(101),"\",29) s %BBP10d(34)=$p(%BBP10d(101),"\",30) s %BBP10d(35)=$p(%BBP10d(101),"\",31) s %BBP10d(36)=$p(%BBP10d(101),"\",32) s %BBP10d(37)=$p(%BBP10d(101),"\",33) s %BBP10d(38)=$p(%BBP10d(101),"\",34) s %BBP10d(39)=$p(%BBP10d(101),"\",35) s %BBP10d(40)=$p(%BBP10d(101),"\",36) s %BBP10d(41)=$p(%BBP10d(101),"\",37) s %BBP10d(42)=$p(%BBP10d(101),"\",38) s %BBP10d(43)=$p(%BBP10d(101),"\",39) s %BBP10d(44)=$p(%BBP10d(101),"\",40) s %BBP10d(45)=$p(%BBP10d(101),"\",41) s %BBP10d(46)=$p(%BBP10d(101),"\",42) s %BBP10d(47)=$p(%BBP10d(101),"\",43)
 s %BBP10d(20)="" f %irep=1:1:$g(^TBBP(%BBP10d(2),%BBP10d(3),"REM",0)) s $li(%BBP10d(20),%irep)=$g(^(%irep))
 s %BBP10d(11)=$$CT011^at500($g(%BBP10d(1))) s %BBP10d(6)=$$CT006^at500($g(%BBP10d(1))) s %BBP10d(7)=$$CT007^at500($g(%BBP10d(1))) s %BBP10d(18)=$$CT018^at500($g(%BBP10d(1))) s %BBP10d(17)=$$CT017^at500($g(%BBP10d(1))) s %BBP10d(12)=$$CT012^at500($g(%BBP10d(1))) s %BBP10d(76)=$zu(28,%BBP10d(7),7)
 g:$zu(115,2)=0 %0ACuncommitted i $zu(115,2)=1 l +^TBBP($p(%BBP10d(1),"||",1),$p(%BBP10d(1),"||",2))#"S":$zu(115,4) i $t { s %BBP10d(85)=1,%BBP10d(86)=$name(^TBBP($p(%BBP10d(1),"||",1),$p(%BBP10d(1),"||",2)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.BBP_PackDetails for RowID value: "_%BBP10d(1) ztrap "LOCK"  }
 ; asl MOD# 4
 s %BBP10d(2)=$p(%BBP10d(1),"||"),%BBP10d(3)=$p(%BBP10d(1),"||",2)
 i %BBP10d(2)'="",%BBP10d(3)'="",$d(^TBBP(%BBP10d(2),%BBP10d(3)))
 e  g %0ADdun
 s %BBP10d(105)=$g(^TBBP(%BBP10d(2),%BBP10d(3)))
 s %BBP10d(8)=$p(%BBP10d(105),"\",4)
 g:'(((%BBP10d(8)'="")&&(%BBP10d(8)=%BBP10d(49)))||(%BBP10d(50)="")) %0ADdun
 s %BBP10d(9)=$p(%BBP10d(105),"\",5)
 g:'(((%BBP10d(9)'="")&&(%BBP10d(9)=%BBP10d(55)))||(%BBP10d(56)="")) %0ADdun
 s %BBP10d(4)=$p(%BBP10d(105),"\",6) s %BBP10d(5)=$p(%BBP10d(105),"\",12) s %BBP10d(10)=$p(%BBP10d(105),"\",9) s %BBP10d(13)=$p(%BBP10d(105),"\",7) s %BBP10d(14)=$p(%BBP10d(105),"\",13) s %BBP10d(15)=$p(%BBP10d(105),"\",14) s %BBP10d(16)=$p(%BBP10d(105),"\",15) s %BBP10d(19)=$p(%BBP10d(105),"\",16) s %BBP10d(21)=$p(%BBP10d(105),"\",17) s %BBP10d(22)=$p(%BBP10d(105),"\",18) s %BBP10d(23)=$p(%BBP10d(105),"\",19) s %BBP10d(24)=$p(%BBP10d(105),"\",20) s %BBP10d(25)=$p(%BBP10d(105),"\",21) s %BBP10d(26)=$p(%BBP10d(105),"\",22) s %BBP10d(27)=$p(%BBP10d(105),"\",23) s %BBP10d(28)=$p(%BBP10d(105),"\",24) s %BBP10d(29)=$p(%BBP10d(105),"\",25) s %BBP10d(30)=$p(%BBP10d(105),"\",26) s %BBP10d(31)=$p(%BBP10d(105),"\",27) s %BBP10d(32)=$p(%BBP10d(105),"\",28) s %BBP10d(33)=$p(%BBP10d(105),"\",29) s %BBP10d(34)=$p(%BBP10d(105),"\",30) s %BBP10d(35)=$p(%BBP10d(105),"\",31) s %BBP10d(36)=$p(%BBP10d(105),"\",32) s %BBP10d(37)=$p(%BBP10d(105),"\",33) s %BBP10d(38)=$p(%BBP10d(105),"\",34) s %BBP10d(39)=$p(%BBP10d(105),"\",35) s %BBP10d(40)=$p(%BBP10d(105),"\",36) s %BBP10d(41)=$p(%BBP10d(105),"\",37) s %BBP10d(42)=$p(%BBP10d(105),"\",38) s %BBP10d(43)=$p(%BBP10d(105),"\",39) s %BBP10d(44)=$p(%BBP10d(105),"\",40) s %BBP10d(45)=$p(%BBP10d(105),"\",41) s %BBP10d(46)=$p(%BBP10d(105),"\",42) s %BBP10d(47)=$p(%BBP10d(105),"\",43)
 s %BBP10d(20)="" f %irep=1:1:$g(^TBBP(%BBP10d(2),%BBP10d(3),"REM",0)) s $li(%BBP10d(20),%irep)=$g(^(%irep))
 s %BBP10d(11)=$$CT011^at500($g(%BBP10d(1))) s %BBP10d(6)=$$CT006^at500($g(%BBP10d(1))) s %BBP10d(7)=$$CT007^at500($g(%BBP10d(1))) s %BBP10d(18)=$$CT018^at500($g(%BBP10d(1))) s %BBP10d(17)=$$CT017^at500($g(%BBP10d(1))) s %BBP10d(12)=$$CT012^at500($g(%BBP10d(1))) s %BBP10d(76)=$zu(28,%BBP10d(7),7)
 g:'(($c(0)[%BBP10d(48))||(%BBP10d(48)=$c(32,0)&&($e(%BBP10d(2))=$c(32)))||(%BBP10d(48)=$e(%BBP10d(2),1,$l(%BBP10d(48))))) %0ADdun
 g:'(((%BBP10d(11)'="")&&(%BBP10d(11)=%BBP10d(61)))||(%BBP10d(62)="")) %0ADdun
 g:'(((%BBP10d(17)'="")&&(%BBP10d(17)=%BBP10d(63)))||(%BBP10d(64)="")) %0ADdun
 g:'(((%BBP10d(6)'="")&&(%BBP10d(6)=%BBP10d(69)))||(%BBP10d(70)="")) %0ADdun
 g:'(((%BBP10d(76)'=" ")&&(%BBP10d(76)=%BBP10d(77)))||(%BBP10d(72)="")) %0ADdun
%0ACuncommitted ;
 s %BBP10d(51)=%BBP10d(8)
 i %BBP10d(51)'="",$d(^TTAB("BB-BP",%BBP10d(51)))
 e  s %BBP10d(52)="",%BBP10d(51)="" g %0ADp6
 s %BBP10d(110)=$g(^TTAB("BB-BP",%BBP10d(51)))
 s %BBP10d(52)=$p(%BBP10d(110),"\",21)
%0ADp6 
 g:'(((%BBP10d(52)'="")&&(%BBP10d(52)=%BBP10d(53)))||(%BBP10d(54)="")) %0ADdun
 g:$zu(115,2)=0 %0ADuncommitted i $zu(115,2)=1 l +^TTAB("BB-BP",$p(%BBP10d(51),"||",1))#"S":$zu(115,4) i $t { s %BBP10d(87)=1,%BBP10d(88)=$name(^TTAB("BB-BP",$p(%BBP10d(51),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.CTBB_BloodProduct for RowID value: "_%BBP10d(51) ztrap "LOCK"  }
 ; asl MOD# 5
 s %BBP10d(78)=$lb(""_%BBP10d(52))
 i %BBP10d(51)'="",$d(^TTAB("BB-BP",%BBP10d(51)))
 e  s %BBP10d(52)="",%BBP10d(51)="" g %0AEp2
 s %BBP10d(115)=$g(^TTAB("BB-BP",%BBP10d(51)))
 s %BBP10d(52)=$p(%BBP10d(115),"\",21)
%0AEp2 
 s %BBP10d(79)=$lb(""_%BBP10d(52))
 g:%BBP10d(78)'=%BBP10d(79) %0AEdun
%0ADuncommitted ;
 s %BBP10d(57)=%BBP10d(11)
 i %BBP10d(57)'="",$d(^TTAB("BB-LOC",%BBP10d(57)))
 e  s %BBP10d(57)="",%BBP10d(58)="" g %0AEp7
 s %BBP10d(120)=$g(^TTAB("BB-LOC",%BBP10d(57)))
 s %BBP10d(58)=$p(%BBP10d(120),"\",2)
%0AEp7 
 g:'(((%BBP10d(58)'="")&&(%BBP10d(58)=%BBP10d(59)))||(%BBP10d(60)="")) %0AEdun
 g:$zu(115,2)=0 %0AEuncommitted i $zu(115,2)=1 l +^TTAB("BB-LOC",$p(%BBP10d(57),"||",1))#"S":$zu(115,4) i $t { s %BBP10d(89)=1,%BBP10d(90)=$name(^TTAB("BB-LOC",$p(%BBP10d(57),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.CTBB_Location for RowID value: "_%BBP10d(57) ztrap "LOCK"  }
 ; asl MOD# 6
 s %BBP10d(80)=$lb(""_%BBP10d(58))
 i %BBP10d(57)'="",$d(^TTAB("BB-LOC",%BBP10d(57)))
 e  s %BBP10d(57)="",%BBP10d(58)="" g %0AFp2
 s %BBP10d(125)=$g(^TTAB("BB-LOC",%BBP10d(57)))
 s %BBP10d(58)=$p(%BBP10d(125),"\",2)
%0AFp2 
 s %BBP10d(81)=$lb(""_%BBP10d(58))
 g:%BBP10d(80)'=%BBP10d(81) %0AFdun
%0AEuncommitted ;
 s %BBP10d(65)=%BBP10d(17)
 i %BBP10d(65)'="",$d(^TTAB("BB-ST",%BBP10d(65)))
 e  s %BBP10d(65)="",%BBP10d(74)=" " g %0AFp7
 s %BBP10d(130)=$g(^TTAB("BB-ST",%BBP10d(65)))
 s %BBP10d(66)=$p(%BBP10d(130),"\",2)
 s %BBP10d(74)=$zu(28,%BBP10d(66),7)
%0AFp7 
 g:'(((%BBP10d(74)'=" ")&&(%BBP10d(74)=%BBP10d(75)))||(%BBP10d(68)="")) %0AFdun
 g:$zu(115,2)=0 %0AFuncommitted i $zu(115,2)=1 l +^TTAB("BB-ST",$p(%BBP10d(65),"||",1))#"S":$zu(115,4) i $t { s %BBP10d(91)=1,%BBP10d(92)=$name(^TTAB("BB-ST",$p(%BBP10d(65),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.CTBB_PackStatus for RowID value: "_%BBP10d(65) ztrap "LOCK"  }
 ; asl MOD# 7
 s %BBP10d(82)=$lb(""_%BBP10d(74))
 i %BBP10d(65)'="",$d(^TTAB("BB-ST",%BBP10d(65)))
 e  s %BBP10d(65)="",%BBP10d(74)=" " g %0AGp2
 s %BBP10d(135)=$g(^TTAB("BB-ST",%BBP10d(65)))
 s %BBP10d(66)=$p(%BBP10d(135),"\",2)
 s %BBP10d(74)=$zu(28,%BBP10d(66),7)
%0AGp2 
 s %BBP10d(83)=$lb(""_%BBP10d(74))
 g:%BBP10d(82)'=%BBP10d(83) %0AGdun
%0AFuncommitted ;
 s:$g(SQLCODE)'<0 SQLCODE=0 s %BBP10d(84)=%BBP10d(84)+1,%ROWCOUNT=%BBP10d(84),%ROWID=%BBP10d(1),%BBP10c=10 q
%BBP10f i '$g(%BBP10c) { s SQLCODE=-102 q  } i %BBP10c=100 { s SQLCODE=100 q  } s SQLCODE=0
 s $zt="%0Aerr" i $d(%0CacheRowLimit)#2,$g(%BBP10d(84))'<%0CacheRowLimit { s SQLCODE=100,%ROWCOUNT=%BBP10d(84),%BBP10c=100 q  } g %0Afirst:%BBP10c=1
%0AGdun i $zu(115,2)=1,$g(%BBP10d(91))=1 { l -@%BBP10d(92) s %BBP10d(91)=0 }
%0AFdun i $zu(115,2)=1,$g(%BBP10d(89))=1 { l -@%BBP10d(90) s %BBP10d(89)=0 }
%0AEdun i $zu(115,2)=1,$g(%BBP10d(87))=1 { l -@%BBP10d(88) s %BBP10d(87)=0 }
%0ADdun i $zu(115,2)=1,$g(%BBP10d(85))=1 { l -@%BBP10d(86) s %BBP10d(85)=0 }
 g %0ACk2
%0ACdun 
%0AAdun 
 s %ROWCOUNT=%BBP10d(84),SQLCODE=100,%BBP10c=100 q
%BBP10c i '$g(%BBP10c) { s SQLCODE=-102 q  } s %ROWCOUNT=$s($g(SQLCODE)'<0:+$g(%BBP10d(84)),1:0) f %BBP10d(93)=1 { i $sortend(^||%sql.temp(%BBP10t(%BBP10d(93)),0),0) } k ^||%sql.temp(%BBP10t(1))
 i $zu(115,2)=1,$g(%BBP10d(85))=1 { l -@%BBP10d(86) } i $zu(115,2)=1,$g(%BBP10d(87))=1 { l -@%BBP10d(88) } i $zu(115,2)=1,$g(%BBP10d(89))=1 { l -@%BBP10d(90) } i $zu(115,2)=1,$g(%BBP10d(91))=1 { l -@%BBP10d(92) } k %BBP10c,%BBP10d,%BBP10E,%BBP10l,%BBP10n,%BBP10R,%BBP10s,%BBP10t,%BBP10Z s SQLCODE=0 q
%0Aerr s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) s %BBP10c=100
 f %BBP10d(93)=1 i $sortend(^||%sql.temp(%BBP10t(%BBP10d(93)),0),0)
 q
%0ABMod ; asl MOD# 2
 s %BBP10d(2)=$s(%BBP10d(48)=$c(0):"",%BBP10d(48)=$c(32,0):" ",1:%BBP10d(48))
 i %BBP10d(2)'="",$d(^TBBP(%BBP10d(2))) g %0ABg1
%0ABk1 s %BBP10d(2)=$o(^TBBP(%BBP10d(2)))
 i %BBP10d(2)="" g %0ABdun
%0ABg1 i (%BBP10d(48)?1n.n),":"']%BBP10d(2) g %0ABdun
 i '(($c(0)[%BBP10d(48))||(($c(32,0)[%BBP10d(48))&&($e(%BBP10d(2))=" "))||(%BBP10d(48)=$e(%BBP10d(2),1,$l(%BBP10d(48))))) g:(%BBP10d(48)?1n.n) %0ABk1 g %0ABdun
 s %BBP10d(3)=""
%0ABk2 s %BBP10d(3)=$o(^TBBP(%BBP10d(2),%BBP10d(3)))
 i %BBP10d(3)="" g %0ABk1
 s %BBP10d(97)=$g(^TBBP(%BBP10d(2),%BBP10d(3)))
 s %BBP10d(8)=$p(%BBP10d(97),"\",4)
 g:'(((%BBP10d(8)'="")&&(%BBP10d(8)=%BBP10d(49)))||(%BBP10d(50)="")) %0ABk2
 s %BBP10d(9)=$p(%BBP10d(97),"\",5)
 g:'(((%BBP10d(9)'="")&&(%BBP10d(9)=%BBP10d(55)))||(%BBP10d(56)="")) %0ABk2
 s %BBP10d(4)=$p(%BBP10d(97),"\",6) s %BBP10d(5)=$p(%BBP10d(97),"\",12) s %BBP10d(10)=$p(%BBP10d(97),"\",9) s %BBP10d(13)=$p(%BBP10d(97),"\",7) s %BBP10d(14)=$p(%BBP10d(97),"\",13) s %BBP10d(15)=$p(%BBP10d(97),"\",14) s %BBP10d(16)=$p(%BBP10d(97),"\",15) s %BBP10d(19)=$p(%BBP10d(97),"\",16) s %BBP10d(21)=$p(%BBP10d(97),"\",17) s %BBP10d(22)=$p(%BBP10d(97),"\",18) s %BBP10d(23)=$p(%BBP10d(97),"\",19) s %BBP10d(24)=$p(%BBP10d(97),"\",20) s %BBP10d(25)=$p(%BBP10d(97),"\",21) s %BBP10d(26)=$p(%BBP10d(97),"\",22) s %BBP10d(27)=$p(%BBP10d(97),"\",23) s %BBP10d(28)=$p(%BBP10d(97),"\",24) s %BBP10d(29)=$p(%BBP10d(97),"\",25) s %BBP10d(30)=$p(%BBP10d(97),"\",26) s %BBP10d(31)=$p(%BBP10d(97),"\",27) s %BBP10d(32)=$p(%BBP10d(97),"\",28) s %BBP10d(33)=$p(%BBP10d(97),"\",29) s %BBP10d(34)=$p(%BBP10d(97),"\",30) s %BBP10d(35)=$p(%BBP10d(97),"\",31) s %BBP10d(36)=$p(%BBP10d(97),"\",32) s %BBP10d(37)=$p(%BBP10d(97),"\",33) s %BBP10d(38)=$p(%BBP10d(97),"\",34) s %BBP10d(39)=$p(%BBP10d(97),"\",35) s %BBP10d(40)=$p(%BBP10d(97),"\",36) s %BBP10d(41)=$p(%BBP10d(97),"\",37) s %BBP10d(42)=$p(%BBP10d(97),"\",38) s %BBP10d(43)=$p(%BBP10d(97),"\",39) s %BBP10d(44)=$p(%BBP10d(97),"\",40) s %BBP10d(45)=$p(%BBP10d(97),"\",41) s %BBP10d(46)=$p(%BBP10d(97),"\",42) s %BBP10d(47)=$p(%BBP10d(97),"\",43)
 s %BBP10d(20)="" f %irep=1:1:$g(^TBBP(%BBP10d(2),%BBP10d(3),"REM",0)) s $li(%BBP10d(20),%irep)=$g(^(%irep))
 s %BBP10d(1)=(%BBP10d(2))_"||"_(%BBP10d(3))
 s %BBP10d(11)=$$CT011^at500($g(%BBP10d(1))) s %BBP10d(6)=$$CT006^at500($g(%BBP10d(1))) s %BBP10d(7)=$$CT007^at500($g(%BBP10d(1))) s %BBP10d(18)=$$CT018^at500($g(%BBP10d(1))) s %BBP10d(17)=$$CT017^at500($g(%BBP10d(1))) s %BBP10d(12)=$$CT012^at500($g(%BBP10d(1))) s %BBP10d(76)=$zu(28,%BBP10d(7),7)
 g:'(((%BBP10d(11)'="")&&(%BBP10d(11)=%BBP10d(61)))||(%BBP10d(62)="")) %0ABk2
 g:'(((%BBP10d(17)'="")&&(%BBP10d(17)=%BBP10d(63)))||(%BBP10d(64)="")) %0ABk2
 g:'(((%BBP10d(6)'="")&&(%BBP10d(6)=%BBP10d(69)))||(%BBP10d(70)="")) %0ABk2
 g:'(((%BBP10d(76)'=" ")&&(%BBP10d(76)=%BBP10d(77)))||(%BBP10d(72)="")) %0ABk2
 s %BBP10s(13)=$s(%BBP10d(13)'="":%BBP10d(13),1:-1E14),%BBP10s(1)=$s(%BBP10d(1)'="":%BBP10d(1),1:-1E14),^||%sql.temp(%BBP10t(1),0,%BBP10s(13),%BBP10s(1))=""
 g %0ABk2
%0ABdun 
 q
%BBP20o s $zt="%BBP20E" s SQLCODE=$s($g(%BBP20c):-101,1:0) q:SQLCODE'=0  s %BBP20d(86)=0 s %BBP20d(87)=0,%BBP20d(88)="",%BBP20d(89)=0,%BBP20d(90)="",%BBP20d(91)=0,%BBP20d(92)="",%BBP20d(93)=0,%BBP20d(94)=""
 s %BBP20d(48)=$g(unitID),%BBP20d(49)=$g(product),%BBP20d(50)=$g(product),%BBP20d(53)=$g(group),%BBP20d(54)=$g(group),%BBP20d(55)=$g(bg),%BBP20d(56)=$g(bg),%BBP20d(59)=$g(site),%BBP20d(60)=$g(site),%BBP20d(61)=$g(location),%BBP20d(62)=$g(location),%BBP20d(63)=$g(status),%BBP20d(64)=$g(status),%BBP20d(67)=$g(statStock),%BBP20d(68)=$g(statStock),%BBP20d(69)=$g(mrn),%BBP20d(70)=$g(mrn),%BBP20d(71)=$g(statAR),%BBP20d(72)=$g(statAR)
 s %BBP20d(75)=$zu(28,%BBP20d(67),7)
 s %BBP20d(77)=$zu(28,%BBP20d(71),7)
 s %BBP20c=1 q
%BBP20E s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) k %BBP20c,%BBP20d,%BBP20E,%BBP20l,%BBP20n,%BBP20R,%BBP20Z q
%0Cfirst 
 ; asl MOD# 2
 s %BBP20d(2)=$s(%BBP20d(48)=$c(0):"",%BBP20d(48)=$c(32,0):" ",1:%BBP20d(48))
 i %BBP20d(2)'="",$d(^TBBP(%BBP20d(2))) g %0CBg1
%0CBk1 s %BBP20d(2)=$o(^TBBP(%BBP20d(2)))
 i %BBP20d(2)="" g %0CBdun
%0CBg1 i (%BBP20d(48)?1n.n),":"']%BBP20d(2) g %0CBdun
 i '(($c(0)[%BBP20d(48))||(($c(32,0)[%BBP20d(48))&&($e(%BBP20d(2))=" "))||(%BBP20d(48)=$e(%BBP20d(2),1,$l(%BBP20d(48))))) g:(%BBP20d(48)?1n.n) %0CBk1 g %0CBdun
 s %BBP20d(3)=""
%0CBk2 s %BBP20d(3)=$o(^TBBP(%BBP20d(2),%BBP20d(3)))
 i %BBP20d(3)="" g %0CBk1
 s %BBP20d(98)=$g(^TBBP(%BBP20d(2),%BBP20d(3)))
 s %BBP20d(8)=$p(%BBP20d(98),"\",4)
 g:'(((%BBP20d(8)'="")&&(%BBP20d(8)=%BBP20d(49)))||(%BBP20d(50)="")) %0CBk2
 s %BBP20d(9)=$p(%BBP20d(98),"\",5)
 g:'(((%BBP20d(9)'="")&&(%BBP20d(9)=%BBP20d(55)))||(%BBP20d(56)="")) %0CBk2
 s %BBP20d(4)=$p(%BBP20d(98),"\",6) s %BBP20d(5)=$p(%BBP20d(98),"\",12) s %BBP20d(10)=$p(%BBP20d(98),"\",9) s %BBP20d(13)=$p(%BBP20d(98),"\",7) s %BBP20d(14)=$p(%BBP20d(98),"\",13) s %BBP20d(15)=$p(%BBP20d(98),"\",14) s %BBP20d(16)=$p(%BBP20d(98),"\",15) s %BBP20d(19)=$p(%BBP20d(98),"\",16) s %BBP20d(21)=$p(%BBP20d(98),"\",17) s %BBP20d(22)=$p(%BBP20d(98),"\",18) s %BBP20d(23)=$p(%BBP20d(98),"\",19) s %BBP20d(24)=$p(%BBP20d(98),"\",20) s %BBP20d(25)=$p(%BBP20d(98),"\",21) s %BBP20d(26)=$p(%BBP20d(98),"\",22) s %BBP20d(27)=$p(%BBP20d(98),"\",23) s %BBP20d(28)=$p(%BBP20d(98),"\",24) s %BBP20d(29)=$p(%BBP20d(98),"\",25) s %BBP20d(30)=$p(%BBP20d(98),"\",26) s %BBP20d(31)=$p(%BBP20d(98),"\",27) s %BBP20d(32)=$p(%BBP20d(98),"\",28) s %BBP20d(33)=$p(%BBP20d(98),"\",29) s %BBP20d(34)=$p(%BBP20d(98),"\",30) s %BBP20d(35)=$p(%BBP20d(98),"\",31) s %BBP20d(36)=$p(%BBP20d(98),"\",32) s %BBP20d(37)=$p(%BBP20d(98),"\",33) s %BBP20d(38)=$p(%BBP20d(98),"\",34) s %BBP20d(39)=$p(%BBP20d(98),"\",35) s %BBP20d(40)=$p(%BBP20d(98),"\",36) s %BBP20d(41)=$p(%BBP20d(98),"\",37) s %BBP20d(42)=$p(%BBP20d(98),"\",38) s %BBP20d(43)=$p(%BBP20d(98),"\",39) s %BBP20d(44)=$p(%BBP20d(98),"\",40) s %BBP20d(45)=$p(%BBP20d(98),"\",41) s %BBP20d(46)=$p(%BBP20d(98),"\",42) s %BBP20d(47)=$p(%BBP20d(98),"\",43)
 s %BBP20d(20)="" f %irep=1:1:$g(^TBBP(%BBP20d(2),%BBP20d(3),"REM",0)) s $li(%BBP20d(20),%irep)=$g(^(%irep))
 s %BBP20d(1)=(%BBP20d(2))_"||"_(%BBP20d(3))
 s %BBP20d(11)=$$CT011^at500($g(%BBP20d(1))) s %BBP20d(6)=$$CT006^at500($g(%BBP20d(1))) s %BBP20d(7)=$$CT007^at500($g(%BBP20d(1))) s %BBP20d(18)=$$CT018^at500($g(%BBP20d(1))) s %BBP20d(17)=$$CT017^at500($g(%BBP20d(1))) s %BBP20d(12)=$$CT012^at500($g(%BBP20d(1))) s %BBP20d(76)=$zu(28,%BBP20d(7),7)
 g:'(((%BBP20d(11)'="")&&(%BBP20d(11)=%BBP20d(61)))||(%BBP20d(62)="")) %0CBk2
 g:'(((%BBP20d(17)'="")&&(%BBP20d(17)=%BBP20d(63)))||(%BBP20d(64)="")) %0CBk2
 g:'(((%BBP20d(6)'="")&&(%BBP20d(6)=%BBP20d(69)))||(%BBP20d(70)="")) %0CBk2
 g:'(((%BBP20d(76)'=" ")&&(%BBP20d(76)=%BBP20d(77)))||(%BBP20d(72)="")) %0CBk2
 g:$zu(115,2)=0 %0CBuncommitted i $zu(115,2)=1 l +^TBBP($p(%BBP20d(1),"||",1),$p(%BBP20d(1),"||",2))#"S":$zu(115,4) i $t { s %BBP20d(87)=1,%BBP20d(88)=$name(^TBBP($p(%BBP20d(1),"||",1),$p(%BBP20d(1),"||",2)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.BBP_PackDetails for RowID value: "_%BBP20d(1) ztrap "LOCK"  }
 ; asl MOD# 3
 s %BBP20d(78)=$lb(""_%BBP20d(8),""_%BBP20d(9),""_%BBP20d(11),""_%BBP20d(17),""_%BBP20d(6),""_%BBP20d(76))
 s %BBP20d(2)=$p(%BBP20d(1),"||"),%BBP20d(3)=$p(%BBP20d(1),"||",2)
 i %BBP20d(2)'="",%BBP20d(3)'="",$d(^TBBP(%BBP20d(2),%BBP20d(3)))
 e  g %0CCdun
 s %BBP20d(102)=$g(^TBBP(%BBP20d(2),%BBP20d(3)))
 s %BBP20d(4)=$p(%BBP20d(102),"\",6) s %BBP20d(5)=$p(%BBP20d(102),"\",12) s %BBP20d(8)=$p(%BBP20d(102),"\",4) s %BBP20d(9)=$p(%BBP20d(102),"\",5) s %BBP20d(10)=$p(%BBP20d(102),"\",9) s %BBP20d(13)=$p(%BBP20d(102),"\",7) s %BBP20d(14)=$p(%BBP20d(102),"\",13) s %BBP20d(15)=$p(%BBP20d(102),"\",14) s %BBP20d(16)=$p(%BBP20d(102),"\",15) s %BBP20d(19)=$p(%BBP20d(102),"\",16) s %BBP20d(21)=$p(%BBP20d(102),"\",17) s %BBP20d(22)=$p(%BBP20d(102),"\",18) s %BBP20d(23)=$p(%BBP20d(102),"\",19) s %BBP20d(24)=$p(%BBP20d(102),"\",20) s %BBP20d(25)=$p(%BBP20d(102),"\",21) s %BBP20d(26)=$p(%BBP20d(102),"\",22) s %BBP20d(27)=$p(%BBP20d(102),"\",23) s %BBP20d(28)=$p(%BBP20d(102),"\",24) s %BBP20d(29)=$p(%BBP20d(102),"\",25) s %BBP20d(30)=$p(%BBP20d(102),"\",26) s %BBP20d(31)=$p(%BBP20d(102),"\",27) s %BBP20d(32)=$p(%BBP20d(102),"\",28) s %BBP20d(33)=$p(%BBP20d(102),"\",29) s %BBP20d(34)=$p(%BBP20d(102),"\",30) s %BBP20d(35)=$p(%BBP20d(102),"\",31) s %BBP20d(36)=$p(%BBP20d(102),"\",32) s %BBP20d(37)=$p(%BBP20d(102),"\",33) s %BBP20d(38)=$p(%BBP20d(102),"\",34) s %BBP20d(39)=$p(%BBP20d(102),"\",35) s %BBP20d(40)=$p(%BBP20d(102),"\",36) s %BBP20d(41)=$p(%BBP20d(102),"\",37) s %BBP20d(42)=$p(%BBP20d(102),"\",38) s %BBP20d(43)=$p(%BBP20d(102),"\",39) s %BBP20d(44)=$p(%BBP20d(102),"\",40) s %BBP20d(45)=$p(%BBP20d(102),"\",41) s %BBP20d(46)=$p(%BBP20d(102),"\",42) s %BBP20d(47)=$p(%BBP20d(102),"\",43)
 s %BBP20d(20)="" f %irep=1:1:$g(^TBBP(%BBP20d(2),%BBP20d(3),"REM",0)) s $li(%BBP20d(20),%irep)=$g(^(%irep))
 s %BBP20d(11)=$$CT011^at500($g(%BBP20d(1))) s %BBP20d(6)=$$CT006^at500($g(%BBP20d(1))) s %BBP20d(7)=$$CT007^at500($g(%BBP20d(1))) s %BBP20d(18)=$$CT018^at500($g(%BBP20d(1))) s %BBP20d(17)=$$CT017^at500($g(%BBP20d(1))) s %BBP20d(12)=$$CT012^at500($g(%BBP20d(1))) s %BBP20d(76)=$zu(28,%BBP20d(7),7)
 s %BBP20d(79)=$lb(""_%BBP20d(8),""_%BBP20d(9),""_%BBP20d(11),""_%BBP20d(17),""_%BBP20d(6),""_%BBP20d(76))
 g:%BBP20d(78)'=%BBP20d(79) %0CCdun
%0CBuncommitted ;
 s %BBP20d(51)=%BBP20d(8)
 i %BBP20d(51)'="",$d(^TTAB("BB-BP",%BBP20d(51)))
 e  s %BBP20d(52)="",%BBP20d(51)="" g %0CCp8
 s %BBP20d(107)=$g(^TTAB("BB-BP",%BBP20d(51)))
 s %BBP20d(52)=$p(%BBP20d(107),"\",21)
%0CCp8 
 g:'(((%BBP20d(52)'="")&&(%BBP20d(52)=%BBP20d(53)))||(%BBP20d(54)="")) %0CCdun
 g:$zu(115,2)=0 %0CCuncommitted i $zu(115,2)=1 l +^TTAB("BB-BP",$p(%BBP20d(51),"||",1))#"S":$zu(115,4) i $t { s %BBP20d(89)=1,%BBP20d(90)=$name(^TTAB("BB-BP",$p(%BBP20d(51),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.CTBB_BloodProduct for RowID value: "_%BBP20d(51) ztrap "LOCK"  }
 ; asl MOD# 4
 s %BBP20d(80)=$lb(""_%BBP20d(52))
 i %BBP20d(51)'="",$d(^TTAB("BB-BP",%BBP20d(51)))
 e  s %BBP20d(52)="",%BBP20d(51)="" g %0CDp2
 s %BBP20d(112)=$g(^TTAB("BB-BP",%BBP20d(51)))
 s %BBP20d(52)=$p(%BBP20d(112),"\",21)
%0CDp2 
 s %BBP20d(81)=$lb(""_%BBP20d(52))
 g:%BBP20d(80)'=%BBP20d(81) %0CDdun
%0CCuncommitted ;
 s %BBP20d(57)=%BBP20d(11)
 i %BBP20d(57)'="",$d(^TTAB("BB-LOC",%BBP20d(57)))
 e  s %BBP20d(57)="",%BBP20d(58)="" g %0CDp7
 s %BBP20d(117)=$g(^TTAB("BB-LOC",%BBP20d(57)))
 s %BBP20d(58)=$p(%BBP20d(117),"\",2)
%0CDp7 
 g:'(((%BBP20d(58)'="")&&(%BBP20d(58)=%BBP20d(59)))||(%BBP20d(60)="")) %0CDdun
 g:$zu(115,2)=0 %0CDuncommitted i $zu(115,2)=1 l +^TTAB("BB-LOC",$p(%BBP20d(57),"||",1))#"S":$zu(115,4) i $t { s %BBP20d(91)=1,%BBP20d(92)=$name(^TTAB("BB-LOC",$p(%BBP20d(57),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.CTBB_Location for RowID value: "_%BBP20d(57) ztrap "LOCK"  }
 ; asl MOD# 5
 s %BBP20d(82)=$lb(""_%BBP20d(58))
 i %BBP20d(57)'="",$d(^TTAB("BB-LOC",%BBP20d(57)))
 e  s %BBP20d(57)="",%BBP20d(58)="" g %0CEp2
 s %BBP20d(122)=$g(^TTAB("BB-LOC",%BBP20d(57)))
 s %BBP20d(58)=$p(%BBP20d(122),"\",2)
%0CEp2 
 s %BBP20d(83)=$lb(""_%BBP20d(58))
 g:%BBP20d(82)'=%BBP20d(83) %0CEdun
%0CDuncommitted ;
 s %BBP20d(65)=%BBP20d(17)
 i %BBP20d(65)'="",$d(^TTAB("BB-ST",%BBP20d(65)))
 e  s %BBP20d(65)="",%BBP20d(74)=" " g %0CEp7
 s %BBP20d(127)=$g(^TTAB("BB-ST",%BBP20d(65)))
 s %BBP20d(66)=$p(%BBP20d(127),"\",2)
 s %BBP20d(74)=$zu(28,%BBP20d(66),7)
%0CEp7 
 g:'(((%BBP20d(74)'=" ")&&(%BBP20d(74)=%BBP20d(75)))||(%BBP20d(68)="")) %0CEdun
 g:$zu(115,2)=0 %0CEuncommitted i $zu(115,2)=1 l +^TTAB("BB-ST",$p(%BBP20d(65),"||",1))#"S":$zu(115,4) i $t { s %BBP20d(93)=1,%BBP20d(94)=$name(^TTAB("BB-ST",$p(%BBP20d(65),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.CTBB_PackStatus for RowID value: "_%BBP20d(65) ztrap "LOCK"  }
 ; asl MOD# 6
 s %BBP20d(84)=$lb(""_%BBP20d(74))
 i %BBP20d(65)'="",$d(^TTAB("BB-ST",%BBP20d(65)))
 e  s %BBP20d(65)="",%BBP20d(74)=" " g %0CFp2
 s %BBP20d(132)=$g(^TTAB("BB-ST",%BBP20d(65)))
 s %BBP20d(66)=$p(%BBP20d(132),"\",2)
 s %BBP20d(74)=$zu(28,%BBP20d(66),7)
%0CFp2 
 s %BBP20d(85)=$lb(""_%BBP20d(74))
 g:%BBP20d(84)'=%BBP20d(85) %0CFdun
%0CEuncommitted ;
 s:$g(SQLCODE)'<0 SQLCODE=0 s %BBP20d(86)=%BBP20d(86)+1,%ROWCOUNT=%BBP20d(86),%ROWID=%BBP20d(1),%BBP20c=10 q
%BBP20f i '$g(%BBP20c) { s SQLCODE=-102 q  } i %BBP20c=100 { s SQLCODE=100 q  } s SQLCODE=0
 s $zt="%0Cerr" i $d(%0CacheRowLimit)#2,$g(%BBP20d(86))'<%0CacheRowLimit { s SQLCODE=100,%ROWCOUNT=%BBP20d(86),%BBP20c=100 q  } g %0Cfirst:%BBP20c=1
%0CFdun i $zu(115,2)=1,$g(%BBP20d(93))=1 { l -@%BBP20d(94) s %BBP20d(93)=0 }
%0CEdun i $zu(115,2)=1,$g(%BBP20d(91))=1 { l -@%BBP20d(92) s %BBP20d(91)=0 }
%0CDdun i $zu(115,2)=1,$g(%BBP20d(89))=1 { l -@%BBP20d(90) s %BBP20d(89)=0 }
%0CCdun i $zu(115,2)=1,$g(%BBP20d(87))=1 { l -@%BBP20d(88) s %BBP20d(87)=0 }
 g %0CBk2
%0CBdun 
%0CAdun 
 s %ROWCOUNT=%BBP20d(86),SQLCODE=100,%BBP20c=100 q
%BBP20c i '$g(%BBP20c) { s SQLCODE=-102 q  } s %ROWCOUNT=$s($g(SQLCODE)'<0:+$g(%BBP20d(86)),1:0)
 i $zu(115,2)=1,$g(%BBP20d(87))=1 { l -@%BBP20d(88) } i $zu(115,2)=1,$g(%BBP20d(89))=1 { l -@%BBP20d(90) } i $zu(115,2)=1,$g(%BBP20d(91))=1 { l -@%BBP20d(92) } i $zu(115,2)=1,$g(%BBP20d(93))=1 { l -@%BBP20d(94) } k %BBP20c,%BBP20d,%BBP20E,%BBP20l,%BBP20n,%BBP20R,%BBP20Z s SQLCODE=0 q
%0Cerr s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) s %BBP20c=100 q
%BBP30o s $zt="%BBP30E" s SQLCODE=$s($g(%BBP30c):-101,1:0) q:SQLCODE'=0  s %BBP30d(85)=0 s %BBP30d(86)=0,%BBP30d(87)="",%BBP30d(88)=0,%BBP30d(89)="",%BBP30d(90)=0,%BBP30d(91)="",%BBP30d(92)=0,%BBP30d(93)=""
 s %BBP30d(48)=$g(unitID),%BBP30d(49)=$g(unitID),%BBP30d(50)=$g(product),%BBP30d(51)=$g(product),%BBP30d(54)=$g(group),%BBP30d(55)=$g(group),%BBP30d(56)=$g(bg),%BBP30d(57)=$g(bg),%BBP30d(60)=$g(site),%BBP30d(61)=$g(site),%BBP30d(62)=$g(location),%BBP30d(63)=$g(location),%BBP30d(64)=$g(status),%BBP30d(65)=$g(status),%BBP30d(68)=$g(statStock),%BBP30d(69)=$g(statStock),%BBP30d(70)=$g(mrn),%BBP30d(71)=$g(mrn),%BBP30d(72)=$g(statAR),%BBP30d(73)=$g(statAR)
 s %BBP30t(1)=$i(^||%sql.temp)
 s %BBP30d(76)=$zu(28,%BBP30d(68),7)
 s %BBP30d(78)=$zu(28,%BBP30d(72),7)
 s %BBP30c=1 q
%BBP30E s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) k %BBP30c,%BBP30d,%BBP30E,%BBP30l,%BBP30n,%BBP30R,%BBP30s,%BBP30t,%BBP30Z q
%0Efirst 
 k ^||%sql.temp(%BBP30t(1),0) s ^||%sql.temp(%BBP30t(1),0)=$H_"^"_$J_"^"_$zu(67,11,$j)_"^"_$zu(67,12,$j)_"^"_$zu(67,15,$j)_"^"_$ZN_"^"_$zu(67,6,$j)
 i $sortbegin(^||%sql.temp(%BBP30t(1),0))
 ; asl MOD# 3
 d %0EBMod
 i $sortend(^||%sql.temp(%BBP30t(1),0))
 s %BBP30s(13)=""
%0ECk1 s %BBP30s(13)=$o(^||%sql.temp(%BBP30t(1),0,%BBP30s(13)))
 i %BBP30s(13)="" g %0ECdun
 s %BBP30d(13)=$s(%BBP30s(13)=-1E14:"",1:%BBP30s(13))
 s %BBP30s(1)=""
%0ECk2 s %BBP30s(1)=$o(^||%sql.temp(%BBP30t(1),0,%BBP30s(13),%BBP30s(1)))
 i %BBP30s(1)="" g %0ECk1
 s %BBP30d(1)=$s(%BBP30s(1)=-1E14:"",1:%BBP30s(1))
 s %BBP30d(2)=$p(%BBP30d(1),"||"),%BBP30d(3)=$p(%BBP30d(1),"||",2)
 i %BBP30d(2)'="",%BBP30d(3)'="",$d(^TBBP(%BBP30d(2),%BBP30d(3)))
 e  g %0ECk2
 s %BBP30d(102)=$g(^TBBP(%BBP30d(2),%BBP30d(3)))
 s %BBP30d(4)=$p(%BBP30d(102),"\",6) s %BBP30d(5)=$p(%BBP30d(102),"\",12) s %BBP30d(8)=$p(%BBP30d(102),"\",4) s %BBP30d(9)=$p(%BBP30d(102),"\",5) s %BBP30d(10)=$p(%BBP30d(102),"\",9) s %BBP30d(14)=$p(%BBP30d(102),"\",13) s %BBP30d(15)=$p(%BBP30d(102),"\",14) s %BBP30d(16)=$p(%BBP30d(102),"\",15) s %BBP30d(19)=$p(%BBP30d(102),"\",16) s %BBP30d(21)=$p(%BBP30d(102),"\",17) s %BBP30d(22)=$p(%BBP30d(102),"\",18) s %BBP30d(23)=$p(%BBP30d(102),"\",19) s %BBP30d(24)=$p(%BBP30d(102),"\",20) s %BBP30d(25)=$p(%BBP30d(102),"\",21) s %BBP30d(26)=$p(%BBP30d(102),"\",22) s %BBP30d(27)=$p(%BBP30d(102),"\",23) s %BBP30d(28)=$p(%BBP30d(102),"\",24) s %BBP30d(29)=$p(%BBP30d(102),"\",25) s %BBP30d(30)=$p(%BBP30d(102),"\",26) s %BBP30d(31)=$p(%BBP30d(102),"\",27) s %BBP30d(32)=$p(%BBP30d(102),"\",28) s %BBP30d(33)=$p(%BBP30d(102),"\",29) s %BBP30d(34)=$p(%BBP30d(102),"\",30) s %BBP30d(35)=$p(%BBP30d(102),"\",31) s %BBP30d(36)=$p(%BBP30d(102),"\",32) s %BBP30d(37)=$p(%BBP30d(102),"\",33) s %BBP30d(38)=$p(%BBP30d(102),"\",34) s %BBP30d(39)=$p(%BBP30d(102),"\",35) s %BBP30d(40)=$p(%BBP30d(102),"\",36) s %BBP30d(41)=$p(%BBP30d(102),"\",37) s %BBP30d(42)=$p(%BBP30d(102),"\",38) s %BBP30d(43)=$p(%BBP30d(102),"\",39) s %BBP30d(44)=$p(%BBP30d(102),"\",40) s %BBP30d(45)=$p(%BBP30d(102),"\",41) s %BBP30d(46)=$p(%BBP30d(102),"\",42) s %BBP30d(47)=$p(%BBP30d(102),"\",43)
 s %BBP30d(20)="" f %irep=1:1:$g(^TBBP(%BBP30d(2),%BBP30d(3),"REM",0)) s $li(%BBP30d(20),%irep)=$g(^(%irep))
 s %BBP30d(11)=$$CT011^at500($g(%BBP30d(1))) s %BBP30d(6)=$$CT006^at500($g(%BBP30d(1))) s %BBP30d(7)=$$CT007^at500($g(%BBP30d(1))) s %BBP30d(18)=$$CT018^at500($g(%BBP30d(1))) s %BBP30d(17)=$$CT017^at500($g(%BBP30d(1))) s %BBP30d(12)=$$CT012^at500($g(%BBP30d(1))) s %BBP30d(77)=$zu(28,%BBP30d(7),7)
 g:$zu(115,2)=0 %0ECuncommitted i $zu(115,2)=1 l +^TBBP($p(%BBP30d(1),"||",1),$p(%BBP30d(1),"||",2))#"S":$zu(115,4) i $t { s %BBP30d(86)=1,%BBP30d(87)=$name(^TBBP($p(%BBP30d(1),"||",1),$p(%BBP30d(1),"||",2)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.BBP_PackDetails for RowID value: "_%BBP30d(1) ztrap "LOCK"  }
 ; asl MOD# 4
 s %BBP30d(2)=$p(%BBP30d(1),"||"),%BBP30d(3)=$p(%BBP30d(1),"||",2)
 i %BBP30d(2)'="",%BBP30d(3)'="",$d(^TBBP(%BBP30d(2),%BBP30d(3)))
 e  g %0EDdun
 s %BBP30d(106)=$g(^TBBP(%BBP30d(2),%BBP30d(3)))
 s %BBP30d(8)=$p(%BBP30d(106),"\",4)
 g:'(((%BBP30d(8)'="")&&(%BBP30d(8)=%BBP30d(50)))||(%BBP30d(51)="")) %0EDdun
 s %BBP30d(9)=$p(%BBP30d(106),"\",5)
 g:'(((%BBP30d(9)'="")&&(%BBP30d(9)=%BBP30d(56)))||(%BBP30d(57)="")) %0EDdun
 s %BBP30d(4)=$p(%BBP30d(106),"\",6) s %BBP30d(5)=$p(%BBP30d(106),"\",12) s %BBP30d(10)=$p(%BBP30d(106),"\",9) s %BBP30d(13)=$p(%BBP30d(106),"\",7) s %BBP30d(14)=$p(%BBP30d(106),"\",13) s %BBP30d(15)=$p(%BBP30d(106),"\",14) s %BBP30d(16)=$p(%BBP30d(106),"\",15) s %BBP30d(19)=$p(%BBP30d(106),"\",16) s %BBP30d(21)=$p(%BBP30d(106),"\",17) s %BBP30d(22)=$p(%BBP30d(106),"\",18) s %BBP30d(23)=$p(%BBP30d(106),"\",19) s %BBP30d(24)=$p(%BBP30d(106),"\",20) s %BBP30d(25)=$p(%BBP30d(106),"\",21) s %BBP30d(26)=$p(%BBP30d(106),"\",22) s %BBP30d(27)=$p(%BBP30d(106),"\",23) s %BBP30d(28)=$p(%BBP30d(106),"\",24) s %BBP30d(29)=$p(%BBP30d(106),"\",25) s %BBP30d(30)=$p(%BBP30d(106),"\",26) s %BBP30d(31)=$p(%BBP30d(106),"\",27) s %BBP30d(32)=$p(%BBP30d(106),"\",28) s %BBP30d(33)=$p(%BBP30d(106),"\",29) s %BBP30d(34)=$p(%BBP30d(106),"\",30) s %BBP30d(35)=$p(%BBP30d(106),"\",31) s %BBP30d(36)=$p(%BBP30d(106),"\",32) s %BBP30d(37)=$p(%BBP30d(106),"\",33) s %BBP30d(38)=$p(%BBP30d(106),"\",34) s %BBP30d(39)=$p(%BBP30d(106),"\",35) s %BBP30d(40)=$p(%BBP30d(106),"\",36) s %BBP30d(41)=$p(%BBP30d(106),"\",37) s %BBP30d(42)=$p(%BBP30d(106),"\",38) s %BBP30d(43)=$p(%BBP30d(106),"\",39) s %BBP30d(44)=$p(%BBP30d(106),"\",40) s %BBP30d(45)=$p(%BBP30d(106),"\",41) s %BBP30d(46)=$p(%BBP30d(106),"\",42) s %BBP30d(47)=$p(%BBP30d(106),"\",43)
 s %BBP30d(20)="" f %irep=1:1:$g(^TBBP(%BBP30d(2),%BBP30d(3),"REM",0)) s $li(%BBP30d(20),%irep)=$g(^(%irep))
 s %BBP30d(11)=$$CT011^at500($g(%BBP30d(1))) s %BBP30d(6)=$$CT006^at500($g(%BBP30d(1))) s %BBP30d(7)=$$CT007^at500($g(%BBP30d(1))) s %BBP30d(18)=$$CT018^at500($g(%BBP30d(1))) s %BBP30d(17)=$$CT017^at500($g(%BBP30d(1))) s %BBP30d(12)=$$CT012^at500($g(%BBP30d(1))) s %BBP30d(77)=$zu(28,%BBP30d(7),7)
 g:'((%BBP30d(2)=%BBP30d(48))||(%BBP30d(49)="")) %0EDdun
 g:'(((%BBP30d(11)'="")&&(%BBP30d(11)=%BBP30d(62)))||(%BBP30d(63)="")) %0EDdun
 g:'(((%BBP30d(17)'="")&&(%BBP30d(17)=%BBP30d(64)))||(%BBP30d(65)="")) %0EDdun
 g:'(((%BBP30d(6)'="")&&(%BBP30d(6)=%BBP30d(70)))||(%BBP30d(71)="")) %0EDdun
 g:'(((%BBP30d(77)'=" ")&&(%BBP30d(77)=%BBP30d(78)))||(%BBP30d(73)="")) %0EDdun
%0ECuncommitted ;
 s %BBP30d(52)=%BBP30d(8)
 i %BBP30d(52)'="",$d(^TTAB("BB-BP",%BBP30d(52)))
 e  s %BBP30d(53)="",%BBP30d(52)="" g %0EDp6
 s %BBP30d(111)=$g(^TTAB("BB-BP",%BBP30d(52)))
 s %BBP30d(53)=$p(%BBP30d(111),"\",21)
%0EDp6 
 g:'(((%BBP30d(53)'="")&&(%BBP30d(53)=%BBP30d(54)))||(%BBP30d(55)="")) %0EDdun
 g:$zu(115,2)=0 %0EDuncommitted i $zu(115,2)=1 l +^TTAB("BB-BP",$p(%BBP30d(52),"||",1))#"S":$zu(115,4) i $t { s %BBP30d(88)=1,%BBP30d(89)=$name(^TTAB("BB-BP",$p(%BBP30d(52),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.CTBB_BloodProduct for RowID value: "_%BBP30d(52) ztrap "LOCK"  }
 ; asl MOD# 5
 s %BBP30d(79)=$lb(""_%BBP30d(53))
 i %BBP30d(52)'="",$d(^TTAB("BB-BP",%BBP30d(52)))
 e  s %BBP30d(53)="",%BBP30d(52)="" g %0EEp2
 s %BBP30d(116)=$g(^TTAB("BB-BP",%BBP30d(52)))
 s %BBP30d(53)=$p(%BBP30d(116),"\",21)
%0EEp2 
 s %BBP30d(80)=$lb(""_%BBP30d(53))
 g:%BBP30d(79)'=%BBP30d(80) %0EEdun
%0EDuncommitted ;
 s %BBP30d(58)=%BBP30d(11)
 i %BBP30d(58)'="",$d(^TTAB("BB-LOC",%BBP30d(58)))
 e  s %BBP30d(58)="",%BBP30d(59)="" g %0EEp7
 s %BBP30d(121)=$g(^TTAB("BB-LOC",%BBP30d(58)))
 s %BBP30d(59)=$p(%BBP30d(121),"\",2)
%0EEp7 
 g:'(((%BBP30d(59)'="")&&(%BBP30d(59)=%BBP30d(60)))||(%BBP30d(61)="")) %0EEdun
 g:$zu(115,2)=0 %0EEuncommitted i $zu(115,2)=1 l +^TTAB("BB-LOC",$p(%BBP30d(58),"||",1))#"S":$zu(115,4) i $t { s %BBP30d(90)=1,%BBP30d(91)=$name(^TTAB("BB-LOC",$p(%BBP30d(58),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.CTBB_Location for RowID value: "_%BBP30d(58) ztrap "LOCK"  }
 ; asl MOD# 6
 s %BBP30d(81)=$lb(""_%BBP30d(59))
 i %BBP30d(58)'="",$d(^TTAB("BB-LOC",%BBP30d(58)))
 e  s %BBP30d(58)="",%BBP30d(59)="" g %0EFp2
 s %BBP30d(126)=$g(^TTAB("BB-LOC",%BBP30d(58)))
 s %BBP30d(59)=$p(%BBP30d(126),"\",2)
%0EFp2 
 s %BBP30d(82)=$lb(""_%BBP30d(59))
 g:%BBP30d(81)'=%BBP30d(82) %0EFdun
%0EEuncommitted ;
 s %BBP30d(66)=%BBP30d(17)
 i %BBP30d(66)'="",$d(^TTAB("BB-ST",%BBP30d(66)))
 e  s %BBP30d(66)="",%BBP30d(75)=" " g %0EFp7
 s %BBP30d(131)=$g(^TTAB("BB-ST",%BBP30d(66)))
 s %BBP30d(67)=$p(%BBP30d(131),"\",2)
 s %BBP30d(75)=$zu(28,%BBP30d(67),7)
%0EFp7 
 g:'(((%BBP30d(75)'=" ")&&(%BBP30d(75)=%BBP30d(76)))||(%BBP30d(69)="")) %0EFdun
 g:$zu(115,2)=0 %0EFuncommitted i $zu(115,2)=1 l +^TTAB("BB-ST",$p(%BBP30d(66),"||",1))#"S":$zu(115,4) i $t { s %BBP30d(92)=1,%BBP30d(93)=$name(^TTAB("BB-ST",$p(%BBP30d(66),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.CTBB_PackStatus for RowID value: "_%BBP30d(66) ztrap "LOCK"  }
 ; asl MOD# 7
 s %BBP30d(83)=$lb(""_%BBP30d(75))
 i %BBP30d(66)'="",$d(^TTAB("BB-ST",%BBP30d(66)))
 e  s %BBP30d(66)="",%BBP30d(75)=" " g %0EGp2
 s %BBP30d(136)=$g(^TTAB("BB-ST",%BBP30d(66)))
 s %BBP30d(67)=$p(%BBP30d(136),"\",2)
 s %BBP30d(75)=$zu(28,%BBP30d(67),7)
%0EGp2 
 s %BBP30d(84)=$lb(""_%BBP30d(75))
 g:%BBP30d(83)'=%BBP30d(84) %0EGdun
%0EFuncommitted ;
 s:$g(SQLCODE)'<0 SQLCODE=0 s %BBP30d(85)=%BBP30d(85)+1,%ROWCOUNT=%BBP30d(85),%ROWID=%BBP30d(1),%BBP30c=10 q
%BBP30f i '$g(%BBP30c) { s SQLCODE=-102 q  } i %BBP30c=100 { s SQLCODE=100 q  } s SQLCODE=0
 s $zt="%0Eerr" i $d(%0CacheRowLimit)#2,$g(%BBP30d(85))'<%0CacheRowLimit { s SQLCODE=100,%ROWCOUNT=%BBP30d(85),%BBP30c=100 q  } g %0Efirst:%BBP30c=1
%0EGdun i $zu(115,2)=1,$g(%BBP30d(92))=1 { l -@%BBP30d(93) s %BBP30d(92)=0 }
%0EFdun i $zu(115,2)=1,$g(%BBP30d(90))=1 { l -@%BBP30d(91) s %BBP30d(90)=0 }
%0EEdun i $zu(115,2)=1,$g(%BBP30d(88))=1 { l -@%BBP30d(89) s %BBP30d(88)=0 }
%0EDdun i $zu(115,2)=1,$g(%BBP30d(86))=1 { l -@%BBP30d(87) s %BBP30d(86)=0 }
 g %0ECk2
%0ECdun 
%0EAdun 
 s %ROWCOUNT=%BBP30d(85),SQLCODE=100,%BBP30c=100 q
%BBP30c i '$g(%BBP30c) { s SQLCODE=-102 q  } s %ROWCOUNT=$s($g(SQLCODE)'<0:+$g(%BBP30d(85)),1:0) f %BBP30d(94)=1 { i $sortend(^||%sql.temp(%BBP30t(%BBP30d(94)),0),0) } k ^||%sql.temp(%BBP30t(1))
 i $zu(115,2)=1,$g(%BBP30d(86))=1 { l -@%BBP30d(87) } i $zu(115,2)=1,$g(%BBP30d(88))=1 { l -@%BBP30d(89) } i $zu(115,2)=1,$g(%BBP30d(90))=1 { l -@%BBP30d(91) } i $zu(115,2)=1,$g(%BBP30d(92))=1 { l -@%BBP30d(93) } k %BBP30c,%BBP30d,%BBP30E,%BBP30l,%BBP30n,%BBP30R,%BBP30s,%BBP30t,%BBP30Z s SQLCODE=0 q
%0Eerr s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) s %BBP30c=100
 f %BBP30d(94)=1 i $sortend(^||%sql.temp(%BBP30t(%BBP30d(94)),0),0)
 q
%0EBMod ; asl MOD# 2
 s %BBP30d(2)=""
%0EBk1 s %BBP30d(2)=$o(^TBBP(%BBP30d(2)))
 i %BBP30d(2)="" g %0EBdun
 i '((%BBP30d(2)=%BBP30d(48))||(%BBP30d(49)="")) g %0EBk1
 s %BBP30d(3)=""
%0EBk2 s %BBP30d(3)=$o(^TBBP(%BBP30d(2),%BBP30d(3)))
 i %BBP30d(3)="" g %0EBk1
 s %BBP30d(98)=$g(^TBBP(%BBP30d(2),%BBP30d(3)))
 s %BBP30d(8)=$p(%BBP30d(98),"\",4)
 g:'(((%BBP30d(8)'="")&&(%BBP30d(8)=%BBP30d(50)))||(%BBP30d(51)="")) %0EBk2
 s %BBP30d(9)=$p(%BBP30d(98),"\",5)
 g:'(((%BBP30d(9)'="")&&(%BBP30d(9)=%BBP30d(56)))||(%BBP30d(57)="")) %0EBk2
 s %BBP30d(4)=$p(%BBP30d(98),"\",6) s %BBP30d(5)=$p(%BBP30d(98),"\",12) s %BBP30d(10)=$p(%BBP30d(98),"\",9) s %BBP30d(13)=$p(%BBP30d(98),"\",7) s %BBP30d(14)=$p(%BBP30d(98),"\",13) s %BBP30d(15)=$p(%BBP30d(98),"\",14) s %BBP30d(16)=$p(%BBP30d(98),"\",15) s %BBP30d(19)=$p(%BBP30d(98),"\",16) s %BBP30d(21)=$p(%BBP30d(98),"\",17) s %BBP30d(22)=$p(%BBP30d(98),"\",18) s %BBP30d(23)=$p(%BBP30d(98),"\",19) s %BBP30d(24)=$p(%BBP30d(98),"\",20) s %BBP30d(25)=$p(%BBP30d(98),"\",21) s %BBP30d(26)=$p(%BBP30d(98),"\",22) s %BBP30d(27)=$p(%BBP30d(98),"\",23) s %BBP30d(28)=$p(%BBP30d(98),"\",24) s %BBP30d(29)=$p(%BBP30d(98),"\",25) s %BBP30d(30)=$p(%BBP30d(98),"\",26) s %BBP30d(31)=$p(%BBP30d(98),"\",27) s %BBP30d(32)=$p(%BBP30d(98),"\",28) s %BBP30d(33)=$p(%BBP30d(98),"\",29) s %BBP30d(34)=$p(%BBP30d(98),"\",30) s %BBP30d(35)=$p(%BBP30d(98),"\",31) s %BBP30d(36)=$p(%BBP30d(98),"\",32) s %BBP30d(37)=$p(%BBP30d(98),"\",33) s %BBP30d(38)=$p(%BBP30d(98),"\",34) s %BBP30d(39)=$p(%BBP30d(98),"\",35) s %BBP30d(40)=$p(%BBP30d(98),"\",36) s %BBP30d(41)=$p(%BBP30d(98),"\",37) s %BBP30d(42)=$p(%BBP30d(98),"\",38) s %BBP30d(43)=$p(%BBP30d(98),"\",39) s %BBP30d(44)=$p(%BBP30d(98),"\",40) s %BBP30d(45)=$p(%BBP30d(98),"\",41) s %BBP30d(46)=$p(%BBP30d(98),"\",42) s %BBP30d(47)=$p(%BBP30d(98),"\",43)
 s %BBP30d(20)="" f %irep=1:1:$g(^TBBP(%BBP30d(2),%BBP30d(3),"REM",0)) s $li(%BBP30d(20),%irep)=$g(^(%irep))
 s %BBP30d(1)=(%BBP30d(2))_"||"_(%BBP30d(3))
 s %BBP30d(11)=$$CT011^at500($g(%BBP30d(1))) s %BBP30d(6)=$$CT006^at500($g(%BBP30d(1))) s %BBP30d(7)=$$CT007^at500($g(%BBP30d(1))) s %BBP30d(18)=$$CT018^at500($g(%BBP30d(1))) s %BBP30d(17)=$$CT017^at500($g(%BBP30d(1))) s %BBP30d(12)=$$CT012^at500($g(%BBP30d(1))) s %BBP30d(77)=$zu(28,%BBP30d(7),7)
 g:'(((%BBP30d(11)'="")&&(%BBP30d(11)=%BBP30d(62)))||(%BBP30d(63)="")) %0EBk2
 g:'(((%BBP30d(17)'="")&&(%BBP30d(17)=%BBP30d(64)))||(%BBP30d(65)="")) %0EBk2
 g:'(((%BBP30d(6)'="")&&(%BBP30d(6)=%BBP30d(70)))||(%BBP30d(71)="")) %0EBk2
 g:'(((%BBP30d(77)'=" ")&&(%BBP30d(77)=%BBP30d(78)))||(%BBP30d(73)="")) %0EBk2
 s %BBP30s(13)=$s(%BBP30d(13)'="":%BBP30d(13),1:-1E14),%BBP30s(1)=$s(%BBP30d(1)'="":%BBP30d(1),1:-1E14),^||%sql.temp(%BBP30t(1),0,%BBP30s(13),%BBP30s(1))=""
 g %0EBk2
%0EBdun 
 q
%BBP40o s $zt="%BBP40E" s SQLCODE=$s($g(%BBP40c):-101,1:0) q:SQLCODE'=0  s %BBP40d(87)=0 s %BBP40d(88)=0,%BBP40d(89)="",%BBP40d(90)=0,%BBP40d(91)="",%BBP40d(92)=0,%BBP40d(93)="",%BBP40d(94)=0,%BBP40d(95)=""
 s %BBP40d(48)=$g(unitID),%BBP40d(49)=$g(unitID),%BBP40d(50)=$g(product),%BBP40d(51)=$g(product),%BBP40d(54)=$g(group),%BBP40d(55)=$g(group),%BBP40d(56)=$g(bg),%BBP40d(57)=$g(bg),%BBP40d(60)=$g(site),%BBP40d(61)=$g(site),%BBP40d(62)=$g(location),%BBP40d(63)=$g(location),%BBP40d(64)=$g(status),%BBP40d(65)=$g(status),%BBP40d(68)=$g(statStock),%BBP40d(69)=$g(statStock),%BBP40d(70)=$g(mrn),%BBP40d(71)=$g(mrn),%BBP40d(72)=$g(statAR),%BBP40d(73)=$g(statAR)
 s %BBP40d(76)=$zu(28,%BBP40d(68),7)
 s %BBP40d(78)=$zu(28,%BBP40d(72),7)
 s %BBP40c=1 q
%BBP40E s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) k %BBP40c,%BBP40d,%BBP40E,%BBP40l,%BBP40n,%BBP40R,%BBP40Z q
%0Gfirst 
 ; asl MOD# 2
 s %BBP40d(2)=""
%0GBk1 s %BBP40d(2)=$o(^TBBP(%BBP40d(2)))
 i %BBP40d(2)="" g %0GBdun
 i '((%BBP40d(2)=%BBP40d(48))||(%BBP40d(49)="")) g %0GBk1
 s %BBP40d(3)=""
%0GBk2 s %BBP40d(3)=$o(^TBBP(%BBP40d(2),%BBP40d(3)))
 i %BBP40d(3)="" g %0GBk1
 s %BBP40d(99)=$g(^TBBP(%BBP40d(2),%BBP40d(3)))
 s %BBP40d(8)=$p(%BBP40d(99),"\",4)
 g:'(((%BBP40d(8)'="")&&(%BBP40d(8)=%BBP40d(50)))||(%BBP40d(51)="")) %0GBk2
 s %BBP40d(9)=$p(%BBP40d(99),"\",5)
 g:'(((%BBP40d(9)'="")&&(%BBP40d(9)=%BBP40d(56)))||(%BBP40d(57)="")) %0GBk2
 s %BBP40d(4)=$p(%BBP40d(99),"\",6) s %BBP40d(5)=$p(%BBP40d(99),"\",12) s %BBP40d(10)=$p(%BBP40d(99),"\",9) s %BBP40d(13)=$p(%BBP40d(99),"\",7) s %BBP40d(14)=$p(%BBP40d(99),"\",13) s %BBP40d(15)=$p(%BBP40d(99),"\",14) s %BBP40d(16)=$p(%BBP40d(99),"\",15) s %BBP40d(19)=$p(%BBP40d(99),"\",16) s %BBP40d(21)=$p(%BBP40d(99),"\",17) s %BBP40d(22)=$p(%BBP40d(99),"\",18) s %BBP40d(23)=$p(%BBP40d(99),"\",19) s %BBP40d(24)=$p(%BBP40d(99),"\",20) s %BBP40d(25)=$p(%BBP40d(99),"\",21) s %BBP40d(26)=$p(%BBP40d(99),"\",22) s %BBP40d(27)=$p(%BBP40d(99),"\",23) s %BBP40d(28)=$p(%BBP40d(99),"\",24) s %BBP40d(29)=$p(%BBP40d(99),"\",25) s %BBP40d(30)=$p(%BBP40d(99),"\",26) s %BBP40d(31)=$p(%BBP40d(99),"\",27) s %BBP40d(32)=$p(%BBP40d(99),"\",28) s %BBP40d(33)=$p(%BBP40d(99),"\",29) s %BBP40d(34)=$p(%BBP40d(99),"\",30) s %BBP40d(35)=$p(%BBP40d(99),"\",31) s %BBP40d(36)=$p(%BBP40d(99),"\",32) s %BBP40d(37)=$p(%BBP40d(99),"\",33) s %BBP40d(38)=$p(%BBP40d(99),"\",34) s %BBP40d(39)=$p(%BBP40d(99),"\",35) s %BBP40d(40)=$p(%BBP40d(99),"\",36) s %BBP40d(41)=$p(%BBP40d(99),"\",37) s %BBP40d(42)=$p(%BBP40d(99),"\",38) s %BBP40d(43)=$p(%BBP40d(99),"\",39) s %BBP40d(44)=$p(%BBP40d(99),"\",40) s %BBP40d(45)=$p(%BBP40d(99),"\",41) s %BBP40d(46)=$p(%BBP40d(99),"\",42) s %BBP40d(47)=$p(%BBP40d(99),"\",43)
 s %BBP40d(20)="" f %irep=1:1:$g(^TBBP(%BBP40d(2),%BBP40d(3),"REM",0)) s $li(%BBP40d(20),%irep)=$g(^(%irep))
 s %BBP40d(1)=(%BBP40d(2))_"||"_(%BBP40d(3))
 s %BBP40d(11)=$$CT011^at500($g(%BBP40d(1))) s %BBP40d(6)=$$CT006^at500($g(%BBP40d(1))) s %BBP40d(7)=$$CT007^at500($g(%BBP40d(1))) s %BBP40d(18)=$$CT018^at500($g(%BBP40d(1))) s %BBP40d(17)=$$CT017^at500($g(%BBP40d(1))) s %BBP40d(12)=$$CT012^at500($g(%BBP40d(1))) s %BBP40d(77)=$zu(28,%BBP40d(7),7)
 g:'(((%BBP40d(11)'="")&&(%BBP40d(11)=%BBP40d(62)))||(%BBP40d(63)="")) %0GBk2
 g:'(((%BBP40d(17)'="")&&(%BBP40d(17)=%BBP40d(64)))||(%BBP40d(65)="")) %0GBk2
 g:'(((%BBP40d(6)'="")&&(%BBP40d(6)=%BBP40d(70)))||(%BBP40d(71)="")) %0GBk2
 g:'(((%BBP40d(77)'=" ")&&(%BBP40d(77)=%BBP40d(78)))||(%BBP40d(73)="")) %0GBk2
 g:$zu(115,2)=0 %0GBuncommitted i $zu(115,2)=1 l +^TBBP($p(%BBP40d(1),"||",1),$p(%BBP40d(1),"||",2))#"S":$zu(115,4) i $t { s %BBP40d(88)=1,%BBP40d(89)=$name(^TBBP($p(%BBP40d(1),"||",1),$p(%BBP40d(1),"||",2)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.BBP_PackDetails for RowID value: "_%BBP40d(1) ztrap "LOCK"  }
 ; asl MOD# 3
 s %BBP40d(79)=$lb(""_%BBP40d(8),""_%BBP40d(9),""_%BBP40d(11),""_%BBP40d(17),""_%BBP40d(6),""_%BBP40d(77))
 s %BBP40d(2)=$p(%BBP40d(1),"||"),%BBP40d(3)=$p(%BBP40d(1),"||",2)
 i %BBP40d(2)'="",%BBP40d(3)'="",$d(^TBBP(%BBP40d(2),%BBP40d(3)))
 e  g %0GCdun
 s %BBP40d(103)=$g(^TBBP(%BBP40d(2),%BBP40d(3)))
 s %BBP40d(4)=$p(%BBP40d(103),"\",6) s %BBP40d(5)=$p(%BBP40d(103),"\",12) s %BBP40d(8)=$p(%BBP40d(103),"\",4) s %BBP40d(9)=$p(%BBP40d(103),"\",5) s %BBP40d(10)=$p(%BBP40d(103),"\",9) s %BBP40d(13)=$p(%BBP40d(103),"\",7) s %BBP40d(14)=$p(%BBP40d(103),"\",13) s %BBP40d(15)=$p(%BBP40d(103),"\",14) s %BBP40d(16)=$p(%BBP40d(103),"\",15) s %BBP40d(19)=$p(%BBP40d(103),"\",16) s %BBP40d(21)=$p(%BBP40d(103),"\",17) s %BBP40d(22)=$p(%BBP40d(103),"\",18) s %BBP40d(23)=$p(%BBP40d(103),"\",19) s %BBP40d(24)=$p(%BBP40d(103),"\",20) s %BBP40d(25)=$p(%BBP40d(103),"\",21) s %BBP40d(26)=$p(%BBP40d(103),"\",22) s %BBP40d(27)=$p(%BBP40d(103),"\",23) s %BBP40d(28)=$p(%BBP40d(103),"\",24) s %BBP40d(29)=$p(%BBP40d(103),"\",25) s %BBP40d(30)=$p(%BBP40d(103),"\",26) s %BBP40d(31)=$p(%BBP40d(103),"\",27) s %BBP40d(32)=$p(%BBP40d(103),"\",28) s %BBP40d(33)=$p(%BBP40d(103),"\",29) s %BBP40d(34)=$p(%BBP40d(103),"\",30) s %BBP40d(35)=$p(%BBP40d(103),"\",31) s %BBP40d(36)=$p(%BBP40d(103),"\",32) s %BBP40d(37)=$p(%BBP40d(103),"\",33) s %BBP40d(38)=$p(%BBP40d(103),"\",34) s %BBP40d(39)=$p(%BBP40d(103),"\",35) s %BBP40d(40)=$p(%BBP40d(103),"\",36) s %BBP40d(41)=$p(%BBP40d(103),"\",37) s %BBP40d(42)=$p(%BBP40d(103),"\",38) s %BBP40d(43)=$p(%BBP40d(103),"\",39) s %BBP40d(44)=$p(%BBP40d(103),"\",40) s %BBP40d(45)=$p(%BBP40d(103),"\",41) s %BBP40d(46)=$p(%BBP40d(103),"\",42) s %BBP40d(47)=$p(%BBP40d(103),"\",43)
 s %BBP40d(20)="" f %irep=1:1:$g(^TBBP(%BBP40d(2),%BBP40d(3),"REM",0)) s $li(%BBP40d(20),%irep)=$g(^(%irep))
 s %BBP40d(11)=$$CT011^at500($g(%BBP40d(1))) s %BBP40d(6)=$$CT006^at500($g(%BBP40d(1))) s %BBP40d(7)=$$CT007^at500($g(%BBP40d(1))) s %BBP40d(18)=$$CT018^at500($g(%BBP40d(1))) s %BBP40d(17)=$$CT017^at500($g(%BBP40d(1))) s %BBP40d(12)=$$CT012^at500($g(%BBP40d(1))) s %BBP40d(77)=$zu(28,%BBP40d(7),7)
 s %BBP40d(80)=$lb(""_%BBP40d(8),""_%BBP40d(9),""_%BBP40d(11),""_%BBP40d(17),""_%BBP40d(6),""_%BBP40d(77))
 g:%BBP40d(79)'=%BBP40d(80) %0GCdun
%0GBuncommitted ;
 s %BBP40d(52)=%BBP40d(8)
 i %BBP40d(52)'="",$d(^TTAB("BB-BP",%BBP40d(52)))
 e  s %BBP40d(53)="",%BBP40d(52)="" g %0GCp8
 s %BBP40d(108)=$g(^TTAB("BB-BP",%BBP40d(52)))
 s %BBP40d(53)=$p(%BBP40d(108),"\",21)
%0GCp8 
 g:'(((%BBP40d(53)'="")&&(%BBP40d(53)=%BBP40d(54)))||(%BBP40d(55)="")) %0GCdun
 g:$zu(115,2)=0 %0GCuncommitted i $zu(115,2)=1 l +^TTAB("BB-BP",$p(%BBP40d(52),"||",1))#"S":$zu(115,4) i $t { s %BBP40d(90)=1,%BBP40d(91)=$name(^TTAB("BB-BP",$p(%BBP40d(52),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.CTBB_BloodProduct for RowID value: "_%BBP40d(52) ztrap "LOCK"  }
 ; asl MOD# 4
 s %BBP40d(81)=$lb(""_%BBP40d(53))
 i %BBP40d(52)'="",$d(^TTAB("BB-BP",%BBP40d(52)))
 e  s %BBP40d(53)="",%BBP40d(52)="" g %0GDp2
 s %BBP40d(113)=$g(^TTAB("BB-BP",%BBP40d(52)))
 s %BBP40d(53)=$p(%BBP40d(113),"\",21)
%0GDp2 
 s %BBP40d(82)=$lb(""_%BBP40d(53))
 g:%BBP40d(81)'=%BBP40d(82) %0GDdun
%0GCuncommitted ;
 s %BBP40d(58)=%BBP40d(11)
 i %BBP40d(58)'="",$d(^TTAB("BB-LOC",%BBP40d(58)))
 e  s %BBP40d(58)="",%BBP40d(59)="" g %0GDp7
 s %BBP40d(118)=$g(^TTAB("BB-LOC",%BBP40d(58)))
 s %BBP40d(59)=$p(%BBP40d(118),"\",2)
%0GDp7 
 g:'(((%BBP40d(59)'="")&&(%BBP40d(59)=%BBP40d(60)))||(%BBP40d(61)="")) %0GDdun
 g:$zu(115,2)=0 %0GDuncommitted i $zu(115,2)=1 l +^TTAB("BB-LOC",$p(%BBP40d(58),"||",1))#"S":$zu(115,4) i $t { s %BBP40d(92)=1,%BBP40d(93)=$name(^TTAB("BB-LOC",$p(%BBP40d(58),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.CTBB_Location for RowID value: "_%BBP40d(58) ztrap "LOCK"  }
 ; asl MOD# 5
 s %BBP40d(83)=$lb(""_%BBP40d(59))
 i %BBP40d(58)'="",$d(^TTAB("BB-LOC",%BBP40d(58)))
 e  s %BBP40d(58)="",%BBP40d(59)="" g %0GEp2
 s %BBP40d(123)=$g(^TTAB("BB-LOC",%BBP40d(58)))
 s %BBP40d(59)=$p(%BBP40d(123),"\",2)
%0GEp2 
 s %BBP40d(84)=$lb(""_%BBP40d(59))
 g:%BBP40d(83)'=%BBP40d(84) %0GEdun
%0GDuncommitted ;
 s %BBP40d(66)=%BBP40d(17)
 i %BBP40d(66)'="",$d(^TTAB("BB-ST",%BBP40d(66)))
 e  s %BBP40d(66)="",%BBP40d(75)=" " g %0GEp7
 s %BBP40d(128)=$g(^TTAB("BB-ST",%BBP40d(66)))
 s %BBP40d(67)=$p(%BBP40d(128),"\",2)
 s %BBP40d(75)=$zu(28,%BBP40d(67),7)
%0GEp7 
 g:'(((%BBP40d(75)'=" ")&&(%BBP40d(75)=%BBP40d(76)))||(%BBP40d(69)="")) %0GEdun
 g:$zu(115,2)=0 %0GEuncommitted i $zu(115,2)=1 l +^TTAB("BB-ST",$p(%BBP40d(66),"||",1))#"S":$zu(115,4) i $t { s %BBP40d(94)=1,%BBP40d(95)=$name(^TTAB("BB-ST",$p(%BBP40d(66),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.CTBB_PackStatus for RowID value: "_%BBP40d(66) ztrap "LOCK"  }
 ; asl MOD# 6
 s %BBP40d(85)=$lb(""_%BBP40d(75))
 i %BBP40d(66)'="",$d(^TTAB("BB-ST",%BBP40d(66)))
 e  s %BBP40d(66)="",%BBP40d(75)=" " g %0GFp2
 s %BBP40d(133)=$g(^TTAB("BB-ST",%BBP40d(66)))
 s %BBP40d(67)=$p(%BBP40d(133),"\",2)
 s %BBP40d(75)=$zu(28,%BBP40d(67),7)
%0GFp2 
 s %BBP40d(86)=$lb(""_%BBP40d(75))
 g:%BBP40d(85)'=%BBP40d(86) %0GFdun
%0GEuncommitted ;
 s:$g(SQLCODE)'<0 SQLCODE=0 s %BBP40d(87)=%BBP40d(87)+1,%ROWCOUNT=%BBP40d(87),%ROWID=%BBP40d(1),%BBP40c=10 q
%BBP40f i '$g(%BBP40c) { s SQLCODE=-102 q  } i %BBP40c=100 { s SQLCODE=100 q  } s SQLCODE=0
 s $zt="%0Gerr" i $d(%0CacheRowLimit)#2,$g(%BBP40d(87))'<%0CacheRowLimit { s SQLCODE=100,%ROWCOUNT=%BBP40d(87),%BBP40c=100 q  } g %0Gfirst:%BBP40c=1
%0GFdun i $zu(115,2)=1,$g(%BBP40d(94))=1 { l -@%BBP40d(95) s %BBP40d(94)=0 }
%0GEdun i $zu(115,2)=1,$g(%BBP40d(92))=1 { l -@%BBP40d(93) s %BBP40d(92)=0 }
%0GDdun i $zu(115,2)=1,$g(%BBP40d(90))=1 { l -@%BBP40d(91) s %BBP40d(90)=0 }
%0GCdun i $zu(115,2)=1,$g(%BBP40d(88))=1 { l -@%BBP40d(89) s %BBP40d(88)=0 }
 g %0GBk2
%0GBdun 
%0GAdun 
 s %ROWCOUNT=%BBP40d(87),SQLCODE=100,%BBP40c=100 q
%BBP40c i '$g(%BBP40c) { s SQLCODE=-102 q  } s %ROWCOUNT=$s($g(SQLCODE)'<0:+$g(%BBP40d(87)),1:0)
 i $zu(115,2)=1,$g(%BBP40d(88))=1 { l -@%BBP40d(89) } i $zu(115,2)=1,$g(%BBP40d(90))=1 { l -@%BBP40d(91) } i $zu(115,2)=1,$g(%BBP40d(92))=1 { l -@%BBP40d(93) } i $zu(115,2)=1,$g(%BBP40d(94))=1 { l -@%BBP40d(95) } k %BBP40c,%BBP40d,%BBP40E,%BBP40l,%BBP40n,%BBP40R,%BBP40Z s SQLCODE=0 q
%0Gerr s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) s %BBP40c=100 q
%0Io n %i,icol,ir
 f icol=0:1:47 i $d(PLIST(icol)) s %i(icol)=PLIST(icol)
 s %ROWID=$$%insert^User.BBPPackDetails.T1(.%i,$c(0,0,0,0)),%ROWCOUNT='SQLCODE
 q  // From %0Io
%0Ko n %mmmsqlc,%mmmsqld,%mmmsqlE,%mmmsqll,%mmmsqln,%mmmsqlp,%mmmsqlR,%mmmsqls,%mmmsqlt,%mmmsqlTS,%mmmsqlTS2,%mmmsqlZ s $zt="%0Kerr" s %mmmsqld(6)=0 s %mmmsqld(7)=""
 s %mmmsqld(3)=$g(ROWID)
 n %data,icol,ir
 s SQLCODE=100
 k:'$TLEVEL %0CacheLock If $zu(115,1)=2,'$TLEVEL { s %mmmsqlTS2=1 TSTART } If $zu(115,1) { s %mmmsqlTS=1 TSTART  }
 ; asl MOD# 2
 s %mmmsqld(2)=%mmmsqld(3)
 s %mmmsqld(4)=$p(%mmmsqld(2),"||"),%mmmsqld(5)=$p(%mmmsqld(2),"||",2)
 i %mmmsqld(4)'="",%mmmsqld(5)'="",$d(^TBBP(%mmmsqld(4),%mmmsqld(5)))
 e  g %0KBdun
 s %mmmsqld(11)=$$%getlock^User.BBPPackDetails.T1(%mmmsqld(2)) i '%mmmsqld(11) s SQLCODE=-110 g %0Kc
 ; asl MOD# 3
 s %mmmsqld(4)=$p(%mmmsqld(2),"||"),%mmmsqld(5)=$p(%mmmsqld(2),"||",2)
 i %mmmsqld(4)'="",%mmmsqld(5)'="",$d(^TBBP(%mmmsqld(4),%mmmsqld(5)))
 e  g %0KCdun
 k %data
 f icol=0:1:47 i $d(PLIST(icol)) s %data(icol)=PLIST(icol)
 d %update^User.BBPPackDetails.T1(%mmmsqld(2),$c(0,2,0,0),.%data,,'$g(%mmmsqlTS))
 i 'SQLCODE i $i(%mmmsqld(6))'<$g(%0CacheRowLimit,9223372036854775807) d:%mmmsqld(11)=1 %ReleaseLock^User.BBPPackDetails.T1(%mmmsqld(2)) g %0Kc
%0KCdun 
 d:%mmmsqld(11)=1 %ReleaseLock^User.BBPPackDetails.T1(%mmmsqld(2)) g:SQLCODE<0 %0Kc
%0KBdun 
%0KAdun 
%0Kc s %ROWCOUNT=$s($g(SQLCODE)'<0:+$g(%mmmsqld(6)),1:0)
 If $zu(115,1),$g(%mmmsqlTS) { TCOMMIT:SQLCODE'<0  TROLLBACK:SQLCODE<0 1 } TCOMMIT:SQLCODE=100&&(%ROWCOUNT=0)&&($g(%mmmsqlTS2))&&($zu(115,1)=2)  q
%0Kerr s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) d:$g(%mmmsqld(11))=1 %ReleaseLock^User.BBPPackDetails.T1(%mmmsqld(2)) g %0Kc
%0Qo d %BBP10f q:SQLCODE'=0
 s PLIST(1)=%BBP10d(1),PLIST(2)=%BBP10d(2),PLIST(3)=%BBP10d(3),PLIST(4)=%BBP10d(4),PLIST(5)=%BBP10d(5),PLIST(6)=%BBP10d(6),PLIST(7)=%BBP10d(7),PLIST(8)=%BBP10d(8),PLIST(9)=%BBP10d(9),PLIST(10)=%BBP10d(10),PLIST(11)=%BBP10d(11),PLIST(12)=%BBP10d(12),PLIST(13)=%BBP10d(13),PLIST(14)=%BBP10d(14),PLIST(15)=%BBP10d(15),PLIST(16)=%BBP10d(16),PLIST(17)=%BBP10d(17),PLIST(18)=%BBP10d(18),PLIST(19)=%BBP10d(19),PLIST(20)=%BBP10d(20),PLIST(21)=%BBP10d(21),PLIST(22)=%BBP10d(22),PLIST(23)=%BBP10d(23),PLIST(24)=%BBP10d(24),PLIST(25)=%BBP10d(25),PLIST(26)=%BBP10d(26),PLIST(27)=%BBP10d(27),PLIST(28)=%BBP10d(28),PLIST(29)=%BBP10d(29),PLIST(30)=%BBP10d(30),PLIST(31)=%BBP10d(31),PLIST(32)=%BBP10d(32),PLIST(33)=%BBP10d(33),PLIST(34)=%BBP10d(34),PLIST(35)=%BBP10d(35),PLIST(36)=%BBP10d(36),PLIST(37)=%BBP10d(37),PLIST(38)=%BBP10d(38),PLIST(39)=%BBP10d(39),PLIST(40)=%BBP10d(40),PLIST(41)=%BBP10d(41),PLIST(42)=%BBP10d(42),PLIST(43)=%BBP10d(43),PLIST(44)=%BBP10d(44),PLIST(45)=%BBP10d(45),PLIST(46)=%BBP10d(46),PLIST(47)=%BBP10d(47)
 q
%0Ro d %BBP20f q:SQLCODE'=0
 s PLIST(1)=%BBP20d(1),PLIST(2)=%BBP20d(2),PLIST(3)=%BBP20d(3),PLIST(4)=%BBP20d(4),PLIST(5)=%BBP20d(5),PLIST(6)=%BBP20d(6),PLIST(7)=%BBP20d(7),PLIST(8)=%BBP20d(8),PLIST(9)=%BBP20d(9),PLIST(10)=%BBP20d(10),PLIST(11)=%BBP20d(11),PLIST(12)=%BBP20d(12),PLIST(13)=%BBP20d(13),PLIST(14)=%BBP20d(14),PLIST(15)=%BBP20d(15),PLIST(16)=%BBP20d(16),PLIST(17)=%BBP20d(17),PLIST(18)=%BBP20d(18),PLIST(19)=%BBP20d(19),PLIST(20)=%BBP20d(20),PLIST(21)=%BBP20d(21),PLIST(22)=%BBP20d(22),PLIST(23)=%BBP20d(23),PLIST(24)=%BBP20d(24),PLIST(25)=%BBP20d(25),PLIST(26)=%BBP20d(26),PLIST(27)=%BBP20d(27),PLIST(28)=%BBP20d(28),PLIST(29)=%BBP20d(29),PLIST(30)=%BBP20d(30),PLIST(31)=%BBP20d(31),PLIST(32)=%BBP20d(32),PLIST(33)=%BBP20d(33),PLIST(34)=%BBP20d(34),PLIST(35)=%BBP20d(35),PLIST(36)=%BBP20d(36),PLIST(37)=%BBP20d(37),PLIST(38)=%BBP20d(38),PLIST(39)=%BBP20d(39),PLIST(40)=%BBP20d(40),PLIST(41)=%BBP20d(41),PLIST(42)=%BBP20d(42),PLIST(43)=%BBP20d(43),PLIST(44)=%BBP20d(44),PLIST(45)=%BBP20d(45),PLIST(46)=%BBP20d(46),PLIST(47)=%BBP20d(47)
 q
%0So d %BBP30f q:SQLCODE'=0
 s PLIST(1)=%BBP30d(1),PLIST(2)=%BBP30d(2),PLIST(3)=%BBP30d(3),PLIST(4)=%BBP30d(4),PLIST(5)=%BBP30d(5),PLIST(6)=%BBP30d(6),PLIST(7)=%BBP30d(7),PLIST(8)=%BBP30d(8),PLIST(9)=%BBP30d(9),PLIST(10)=%BBP30d(10),PLIST(11)=%BBP30d(11),PLIST(12)=%BBP30d(12),PLIST(13)=%BBP30d(13),PLIST(14)=%BBP30d(14),PLIST(15)=%BBP30d(15),PLIST(16)=%BBP30d(16),PLIST(17)=%BBP30d(17),PLIST(18)=%BBP30d(18),PLIST(19)=%BBP30d(19),PLIST(20)=%BBP30d(20),PLIST(21)=%BBP30d(21),PLIST(22)=%BBP30d(22),PLIST(23)=%BBP30d(23),PLIST(24)=%BBP30d(24),PLIST(25)=%BBP30d(25),PLIST(26)=%BBP30d(26),PLIST(27)=%BBP30d(27),PLIST(28)=%BBP30d(28),PLIST(29)=%BBP30d(29),PLIST(30)=%BBP30d(30),PLIST(31)=%BBP30d(31),PLIST(32)=%BBP30d(32),PLIST(33)=%BBP30d(33),PLIST(34)=%BBP30d(34),PLIST(35)=%BBP30d(35),PLIST(36)=%BBP30d(36),PLIST(37)=%BBP30d(37),PLIST(38)=%BBP30d(38),PLIST(39)=%BBP30d(39),PLIST(40)=%BBP30d(40),PLIST(41)=%BBP30d(41),PLIST(42)=%BBP30d(42),PLIST(43)=%BBP30d(43),PLIST(44)=%BBP30d(44),PLIST(45)=%BBP30d(45),PLIST(46)=%BBP30d(46),PLIST(47)=%BBP30d(47)
 q
%0To d %BBP40f q:SQLCODE'=0
 s PLIST(1)=%BBP40d(1),PLIST(2)=%BBP40d(2),PLIST(3)=%BBP40d(3),PLIST(4)=%BBP40d(4),PLIST(5)=%BBP40d(5),PLIST(6)=%BBP40d(6),PLIST(7)=%BBP40d(7),PLIST(8)=%BBP40d(8),PLIST(9)=%BBP40d(9),PLIST(10)=%BBP40d(10),PLIST(11)=%BBP40d(11),PLIST(12)=%BBP40d(12),PLIST(13)=%BBP40d(13),PLIST(14)=%BBP40d(14),PLIST(15)=%BBP40d(15),PLIST(16)=%BBP40d(16),PLIST(17)=%BBP40d(17),PLIST(18)=%BBP40d(18),PLIST(19)=%BBP40d(19),PLIST(20)=%BBP40d(20),PLIST(21)=%BBP40d(21),PLIST(22)=%BBP40d(22),PLIST(23)=%BBP40d(23),PLIST(24)=%BBP40d(24),PLIST(25)=%BBP40d(25),PLIST(26)=%BBP40d(26),PLIST(27)=%BBP40d(27),PLIST(28)=%BBP40d(28),PLIST(29)=%BBP40d(29),PLIST(30)=%BBP40d(30),PLIST(31)=%BBP40d(31),PLIST(32)=%BBP40d(32),PLIST(33)=%BBP40d(33),PLIST(34)=%BBP40d(34),PLIST(35)=%BBP40d(35),PLIST(36)=%BBP40d(36),PLIST(37)=%BBP40d(37),PLIST(38)=%BBP40d(38),PLIST(39)=%BBP40d(39),PLIST(40)=%BBP40d(40),PLIST(41)=%BBP40d(41),PLIST(42)=%BBP40d(42),PLIST(43)=%BBP40d(43),PLIST(44)=%BBP40d(44),PLIST(45)=%BBP40d(45),PLIST(46)=%BBP40d(46),PLIST(47)=%BBP40d(47)
 q
%0Yo n %mmmsqlc,%mmmsqld,%mmmsqlE,%mmmsqll,%mmmsqln,%mmmsqlp,%mmmsqlR,%mmmsqls,%mmmsqlt,%mmmsqlZ s $zt="%0Yerr" s %mmmsqld(51)=0,%mmmsqld(52)=""
 s %mmmsqld(49)=$g(ROWID)
 s SQLCODE=100
 ; asl MOD# 2
 s PLIST(1)=%mmmsqld(49)
 s PLIST(2)=$p(PLIST(1),"||"),PLIST(3)=$p(PLIST(1),"||",2)
 i PLIST(2)'="",PLIST(3)'="",$d(^TBBP(PLIST(2),PLIST(3)))
 e  g %0YBdun
 s %mmmsqld(56)=$g(^TBBP(PLIST(2),PLIST(3)))
 s PLIST(4)=$p(%mmmsqld(56),"\",6) s PLIST(5)=$p(%mmmsqld(56),"\",12) s PLIST(8)=$p(%mmmsqld(56),"\",4) s PLIST(9)=$p(%mmmsqld(56),"\",5) s PLIST(10)=$p(%mmmsqld(56),"\",9) s PLIST(13)=$p(%mmmsqld(56),"\",7) s PLIST(14)=$p(%mmmsqld(56),"\",13) s PLIST(15)=$p(%mmmsqld(56),"\",14) s PLIST(16)=$p(%mmmsqld(56),"\",15) s PLIST(19)=$p(%mmmsqld(56),"\",16) s PLIST(21)=$p(%mmmsqld(56),"\",17) s PLIST(22)=$p(%mmmsqld(56),"\",18) s PLIST(23)=$p(%mmmsqld(56),"\",19) s PLIST(24)=$p(%mmmsqld(56),"\",20) s PLIST(25)=$p(%mmmsqld(56),"\",21) s PLIST(26)=$p(%mmmsqld(56),"\",22) s PLIST(27)=$p(%mmmsqld(56),"\",23) s PLIST(28)=$p(%mmmsqld(56),"\",24) s PLIST(29)=$p(%mmmsqld(56),"\",25) s PLIST(30)=$p(%mmmsqld(56),"\",26) s PLIST(31)=$p(%mmmsqld(56),"\",27) s PLIST(32)=$p(%mmmsqld(56),"\",28) s PLIST(33)=$p(%mmmsqld(56),"\",29) s PLIST(34)=$p(%mmmsqld(56),"\",30) s PLIST(35)=$p(%mmmsqld(56),"\",31) s PLIST(36)=$p(%mmmsqld(56),"\",32) s PLIST(37)=$p(%mmmsqld(56),"\",33) s PLIST(38)=$p(%mmmsqld(56),"\",34) s PLIST(39)=$p(%mmmsqld(56),"\",35) s PLIST(40)=$p(%mmmsqld(56),"\",36) s PLIST(41)=$p(%mmmsqld(56),"\",37) s PLIST(42)=$p(%mmmsqld(56),"\",38) s PLIST(43)=$p(%mmmsqld(56),"\",39) s PLIST(44)=$p(%mmmsqld(56),"\",40) s PLIST(45)=$p(%mmmsqld(56),"\",41) s PLIST(46)=$p(%mmmsqld(56),"\",42) s PLIST(47)=$p(%mmmsqld(56),"\",43)
 s PLIST(20)="" f %irep=1:1:$g(^TBBP(PLIST(2),PLIST(3),"REM",0)) s $li(PLIST(20),%irep)=$g(^(%irep))
 s PLIST(11)=$$CT011^at500($g(PLIST(1))) s PLIST(6)=$$CT006^at500($g(PLIST(1))) s PLIST(7)=$$CT007^at500($g(PLIST(1))) s PLIST(18)=$$CT018^at500($g(PLIST(1))) s PLIST(17)=$$CT017^at500($g(PLIST(1))) s PLIST(12)=$$CT012^at500($g(PLIST(1)))
 g:$zu(115,2)=0 %0YBuncommitted i $zu(115,2)=1 l +^TBBP($p(PLIST(1),"||",1),$p(PLIST(1),"||",2))#"S":$zu(115,4) i $t { s %mmmsqld(51)=1,%mmmsqld(52)=$name(^TBBP($p(PLIST(1),"||",1),$p(PLIST(1),"||",2)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.BBP_PackDetails for RowID value: "_PLIST(1) ztrap "LOCK"  }
 ; asl MOD# 3
 s PLIST(2)=$p(PLIST(1),"||"),PLIST(3)=$p(PLIST(1),"||",2)
 i PLIST(2)'="",PLIST(3)'="",$d(^TBBP(PLIST(2),PLIST(3)))
 e  g %0YCdun
 s %mmmsqld(60)=$g(^TBBP(PLIST(2),PLIST(3)))
 s PLIST(4)=$p(%mmmsqld(60),"\",6) s PLIST(5)=$p(%mmmsqld(60),"\",12) s PLIST(8)=$p(%mmmsqld(60),"\",4) s PLIST(9)=$p(%mmmsqld(60),"\",5) s PLIST(10)=$p(%mmmsqld(60),"\",9) s PLIST(13)=$p(%mmmsqld(60),"\",7) s PLIST(14)=$p(%mmmsqld(60),"\",13) s PLIST(15)=$p(%mmmsqld(60),"\",14) s PLIST(16)=$p(%mmmsqld(60),"\",15) s PLIST(19)=$p(%mmmsqld(60),"\",16) s PLIST(21)=$p(%mmmsqld(60),"\",17) s PLIST(22)=$p(%mmmsqld(60),"\",18) s PLIST(23)=$p(%mmmsqld(60),"\",19) s PLIST(24)=$p(%mmmsqld(60),"\",20) s PLIST(25)=$p(%mmmsqld(60),"\",21) s PLIST(26)=$p(%mmmsqld(60),"\",22) s PLIST(27)=$p(%mmmsqld(60),"\",23) s PLIST(28)=$p(%mmmsqld(60),"\",24) s PLIST(29)=$p(%mmmsqld(60),"\",25) s PLIST(30)=$p(%mmmsqld(60),"\",26) s PLIST(31)=$p(%mmmsqld(60),"\",27) s PLIST(32)=$p(%mmmsqld(60),"\",28) s PLIST(33)=$p(%mmmsqld(60),"\",29) s PLIST(34)=$p(%mmmsqld(60),"\",30) s PLIST(35)=$p(%mmmsqld(60),"\",31) s PLIST(36)=$p(%mmmsqld(60),"\",32) s PLIST(37)=$p(%mmmsqld(60),"\",33) s PLIST(38)=$p(%mmmsqld(60),"\",34) s PLIST(39)=$p(%mmmsqld(60),"\",35) s PLIST(40)=$p(%mmmsqld(60),"\",36) s PLIST(41)=$p(%mmmsqld(60),"\",37) s PLIST(42)=$p(%mmmsqld(60),"\",38) s PLIST(43)=$p(%mmmsqld(60),"\",39) s PLIST(44)=$p(%mmmsqld(60),"\",40) s PLIST(45)=$p(%mmmsqld(60),"\",41) s PLIST(46)=$p(%mmmsqld(60),"\",42) s PLIST(47)=$p(%mmmsqld(60),"\",43)
 s PLIST(20)="" f %irep=1:1:$g(^TBBP(PLIST(2),PLIST(3),"REM",0)) s $li(PLIST(20),%irep)=$g(^(%irep))
 s PLIST(11)=$$CT011^at500($g(PLIST(1))) s PLIST(6)=$$CT006^at500($g(PLIST(1))) s PLIST(7)=$$CT007^at500($g(PLIST(1))) s PLIST(18)=$$CT018^at500($g(PLIST(1))) s PLIST(17)=$$CT017^at500($g(PLIST(1))) s PLIST(12)=$$CT012^at500($g(PLIST(1)))
%0YBuncommitted ;
 s SQLCODE=0 g %0Yc
%0YCdun i $zu(115,2)=1,$g(%mmmsqld(51))=1 { l -@%mmmsqld(52) s %mmmsqld(51)=0 }
%0YBdun 
%0YAdun 
%0Yc s %ROWCOUNT='SQLCODE i $zu(115,2)=1,$g(%mmmsqld(51))=1 { l -@%mmmsqld(52) } q
%0Yerr s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) g %0Yc
]]></Routine>
</Export>
