<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="24">
<Routine name="LVBCOM10" type="INT" languagemode="0" generated="1"><![CDATA[
LVBCOM10 ; IG 27/10/2000 ; Common routines
 ;
 ; supported calls:
 ;
 ; $$open^LVBCOM10(sort,user,p2,p3,p4,p5,p6,p7,p8,p9)
 ; $$fetch^LVBCOM10(sort,user,p2,p3,p4,p5,p6,p7,p8,p9)
 ; $$fetchbuffer^LVBCOM10(sort,user,p2,p3,p4,p5,p6,p7,p8,p9)
 ; $$close^LVBCOM10()
 ; $$file^LVBCOM10(sort,user)
 ; fn01^LVBCOM10(text)  ; |?*     ; MicroOrganism
 ; fn02^LVBCOM10(text)  ; |?*     ; Antibiotic+Sensitivity result
 ; fn03^LVBCOM10(text)  ; |  <>=  ; Year of Collection
 ; fn04^LVBCOM10(text)  ; |  <>=  ; Year of Authorisation
 ; fn05^LVBCOM10(text)  ; |  <>=  ; Date of Last Authorisation
 ; fn06^LVBCOM10(text)  ; |?*<>=  ; Test Item Result - All
 ; fn06a^LVBCOM10(text) ; |?*<>=  ; Test Item Result - Code
 ; fn06b^LVBCOM10(text) ; |?*<>=  ; Test Item Result - Synonym
 ; fn06c^LVBCOM10(text) ; |?*<>=  ; Test Item Result - NN Long
 ; fn06d^LVBCOM10(text) ; |?*<>=  ; Test Item Result - NN Short
 ; fn07^LVBCOM10(text)  ; |?*     ; DayBook Accession number
 ; fn08^LVBCOM10(text)  ; |?*     ; Hospital bed
 ; fn09^LVBCOM10(text)  ; |?*     ; Doctor Reference
 ; fn10^LVBCOM10(text)  ; |?*     ; CCR codes
 ; fn11^LVBCOM10(text)  ; |  <>=  ; Date of Admission
 ; fn12^LVBCOM10(text)  ; |?*     ; Patient History
 ; fn13^LVBCOM10(text)  ; |  <>=  ; Date of Birth
 ; fn14^LVBCOM10(text)  ; |  <>=  ; Time of Receival
 ; fn15^LVBCOM10(text)  ;       Y ; Internal Infection
 ; fn16^LVBCOM10(text)  ;       Y ; Antibiotic panel exist
 ; fn17^LVBCOM10(text)  ; |  <>=  ; Date of Collection
 ; fn18^LVBCOM10(text)  ; |  <>=  ; Date of Authorisation
 ; fn19a^LVBCOM10(text) ; |?*     ; Aerobic bottle
 ; fn19b^LVBCOM10(text) ; |?*     ; Anaerobic bottle
 ; fn20a^LVBCOM10(text) ; |?*     ; Verification Queues
 ; fn20b^LVBCOM10(text) ; |?*     ; ReadOnly Queues
 ; fn21^LVBCOM10(text)  ;       Y ; Deceased
 ; fn22^LVBCOM10(text)  ; |?*     ; Test Set
 ; fn23^LVBCOM10(text)  ; |?*     ; Pathogen group
 ; fn24^LVBCOM10(text)  ; |  <>=  ; Patient age
 ; fn25^LVBCOM10(text)  ; |?*     ; Warning message
 ; fn26^LVBCOM10(text)  ; |?*     ; Antibiotic therapy
 ; fn27^LVBCOM10(text)  ; |?*     ; Doctor - Code
 ; fn27a^LVBCOM10(text) ; |?*     ; Doctor - Surname
 ; fn28^LVBCOM10(text)  ; |     L ; Result type - NotEntered("C")/Entered("E")/Pathologist("P")/Hold("H")
 ; fn29^LVBCOM10(text)  ; |?*     ; Patient Name
 ; fn30^LVBCOM10(text)  ; |?*     ; MRN
 ; fn31^LVBCOM10(text)  ; |?*     ; Episode
 ; fn32^LVBCOM10(text)  ; |?*     ; Special Interest Group
 ; fn33^LVBCOM10(text)  ; |       ; DayBook Laboratory
 ; fn34^LVBCOM10(text)  ; |?*     ; Speciality
 ; fn35^LVBCOM10(text)  ; |?*     ; Sex
 ; fn36^LVBCOM10(text)  ; |?*     ; Patient Location Original
 ; fn37^LVBCOM10(text)  ; |     L ; Priority - Urgent(2)/InstantPrint(3)/Fax(4)/Phone(6)
 ; fn38^LVBCOM10(text)  ; |?*     ; Priority
 ; fn39^LVBCOM10(text)  ; |?*     ; Patient Location
 ; fn40^LVBCOM10(text)  ; |?*     ; Clinical History
 ; fn41^LVBCOM10(text)  ; |?*     ; Patient Given Name
 ; fn42^LVBCOM10(text)  ; |?*     ; Patient Surname
 ; fn43a^LVBCOM10(text) ; |?*     ; Pensioner
 ; fn43b^LVBCOM10(text) ; |?*     ; Medicare
 ; fn43c^LVBCOM10(text) ; |?*     ; VA
 ; fn44^LVBCOM10(text)  ; |?*     ; Specimen - Code
 ; fn44a^LVBCOM10(text) ; |?*     ; Specimen - Name
 ; fn45^LVBCOM10(text)  ; |?*     ; Anatomical site - Code
 ; fn45a^LVBCOM10(text) ; |?*     ; Anatomical site - Name
 ; fn46^LVBCOM10(text)  ; |?*     ; Method of collection - Code
 ; fn46a^LVBCOM10(text) ; |?*     ; Method of collection - Name
 ; fn47a^LVBCOM10(text) ; |?*     ; Specimen group - Code
 ; fn47b^LVBCOM10(text) ; |?*     ; Specimen group - Name
 ; fn48^LVBCOM10(text)  ; |?*     ; DayBook Specimen - Code
 ; fn49^LVBCOM10(text)  ; |?*     ; DayBook Anatomical site - Code
 ; fn50a^LVBCOM10(text) ; |?*     ; Extra Field 1
 ; fn50b^LVBCOM10(text) ; |?*     ; Extra Field 2
 ; fn50c^LVBCOM10(text) ; |?*     ; Extra Field 3
 ; fn50d^LVBCOM10(text) ; |?*     ; Extra Field 4
 ; fn50e^LVBCOM10(text) ; |?*     ; Extra Field 5
 ; fn50f^LVBCOM10(text) ; |?*     ; Extra Field 6
 ; fn50g^LVBCOM10(text) ; |?*     ; Extra Field 7
 ; fn50h^LVBCOM10(text) ; |?*     ; Extra Field 8
 ; fn50i^LVBCOM10(text) ; |?*     ; Extra Field 9
 ; fn50j^LVBCOM10(text) ; |?*     ; Extra Field 10
 ; fn51a^LVBCOM10(text) ; |?*     ; DayBook Specimen group - Code
 ; fn52^LVBCOM10(text)  ; |?*     ; Visit Action Multiple - Code
 ;
file(sort,user) n (sort,user,PLIST) s sort=$g(sort),user=$g(user)
 d
 .n (site)
 .s site="" i '$$select^MVBCFSM(1) s site=PLIST(32)
 i $l(site) s %routine=$zn_site i $l(%routine) s LineRoutine="file^"_%routine i $l($t(@LineRoutine)) x "s ok=$$file^"_%routine_"("""_sort_""","""_user_""")" q ok
 q $$file^LVBCOM11(sort,user)
open(sort,user,p2,p3,p4,p5,p6,p7,p8,p9) n (sort,user,PLIST) s sort=$g(sort),user=$g(user)
 q $$open^LVBCOM11(sort,user)
fetch(sort,user,p2,p3,p4,p5,p6,p7,p8,p9) s sort=$g(sort),user=$g(user)
 q $$fetch^LVBCOM11(sort,user)
 ; Fetch all data
fetchbuffer(sort,user,p2,p3,p4,p5,p6,p7,p8,p9) s sort=$g(sort),user=$g(user)
 q $$fetchbuffer^LVBCOM11(sort,user)
close() q $$close^LVBCOM11()
select(vts,TI,DB,xxx) s vts=$g(vts),TI=$g(TI),DB=$g(DB),xxx=$g(xxx)
 q $$select^LVBVIS11(vts,TI,DB,xxx)
compare(xx,result)      n (xx,result) s ok=100,xx=$g(xx),result=$g(result)
 d
 .i $e(xx)="<" s:result'<$e(xx,2,$l(xx)) ok=0 q
 .i $e(xx)=">" s:result'>$e(xx,2,$l(xx)) ok=0 q
 .i xx["=" s:result<$p(xx,"=",1) ok=0 s:result>$p(xx,"=",2) ok=0 q
 .s x="" f j=1:1:$l(xx) d
 ..i $e(xx,j)="?" s x=x_"1E" q
 ..i $e(xx,j)="*" s x=x_".E" q
 ..s x=x_"1"""_$e(xx,j)_""""
 .s xx=x i result'?@(xx) s ok=0
 q ok
 ; MicroOrganism
fn01(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ok=$$val01(vts,text,$p(^(vts),$c(1)))
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 ..i ok s $p(^TMP("Query",$j,"OUT",vts),$c(1),1)=$p(ok,$c(1),2)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ok=$$val01(vts,text) i ok s $p(^TMP("Query",$j,"OUT",vts),$c(1),1)=$p(ok,$c(1),2)
 q
val01(vts,text,list) n (vts,text,list,user) s vts=$g(vts),text=$g(text),list=$g(list),(ok1,ok3)=""
 f j=1:1:3 s @("x"_j)=$p(vts,"||",j)
 s ti="" f  s ti=$o(^TEPI(x1,1,x2,x3,"DATA",ti)) q:ti=""  s result=$p($g(^(ti)),"\") i $l(result) d
 .i $l(list),(","_list_",")'[(","_ti_",") q
 .s ok2="" i $p($g(^TTAB("TC",ti)),"\",3)="V" f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok2=1 q
 .i ok2 s ok1=1,ok3=ok3_$s($l(ok3):",",1:"")_ti
 q ok1_$c(1)_ok3
 ; Antibiotic+Sensitivity result
fn02(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ok=$$val02(vts,text,$p(^(vts),$c(1)))
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 ..i ok s $p(^TMP("Query",$j,"OUT",vts),$c(1),1)=$p(ok,$c(1),2)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ok=$$val02(vts,text) i ok s $p(^TMP("Query",$j,"OUT",vts),$c(1),1)=$p(ok,$c(1),2)
 q
val02(vts,text,list) n (vts,text,list,user) s vts=$g(vts),text=$g(text),list=$g(list),(ok1,ok3)=""
 f j=1:1:3 s @("x"_j)=$p(vts,"||",j)
 s ti="" f  s ti=$o(^TEPI(x1,1,x2,x3,"DATA",ti)) q:ti=""  d
 .i $l(list),(","_list_",")'[(","_ti_",") q
 .s ok2="" f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) d  q:ok2
 ..f j=1,2 s @("xx"_j)=$p(xx,"=",j)
 ..s ant="" f  s ant=$o(^TEPI(x1,1,x2,x3,"DATA",ti,"ANT",ant)) q:ant=""  i $$compare(xx1,ant) d  q:ok2
 ...s result=$p($g(^TEPI(x1,1,x2,x3,"DATA",ti,"ANT",ant)),"\")
 ...i $l(result),xx2=result s ok2=1
 .i ok2 s ok1=1,ok3=ok3_$s($l(ok3):",",1:"")_ti
 q ok1_$c(1)_ok3
 ; Year of Collection
fn03(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),date=$$extdate2^SSUTIL4($p($g(^TEPI(ep)),"\",10))
 ..s ok=0 i $l(date) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,$p(date,"/",3)) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) d
 .d
 ..i $e(xx)="<" s start=$o(^TDAY(1,"")),end=$$intdate^SSUTIL4("12/31/"_($e(xx,2,$l(xx))-1)) q
 ..i $e(xx)=">" s start=$$intdate^SSUTIL4("01/01/"_($e(xx,2,$l(xx))+1)),end=$o(^TDAY(1,""),-1) q
 ..i xx["=" d  q
 ...i $l($p(xx,"=",1)) s start=$$intdate^SSUTIL4("01/01/"_$p(xx,"=",1))
 ...e  s start=$o(^TDAY(1,""))
 ...i $l($p(xx,"=",2)) s end=$$intdate^SSUTIL4("12/31/"_$p(xx,"=",2))
 ...e  s end=$o(^TDAY(1,""),-1)
 ..s start=$$intdate^SSUTIL4("01/01/"_xx),end=$$intdate^SSUTIL4("12/31/"_xx)
 .f date=start:1:end d
 ..s ep="" f  s ep=$o(^TDAY(1,date,0,ep)) q:ep=""  d
 ...s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ....s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 .....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 .....s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Year of Authorisation
fn04(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),ts=$p(vts,"||",2),tscnt=$p(vts,"||",3)
 ..s date=$$extdate2^SSUTIL4($p($g(^TEPI(ep,1,ts,tscnt)),"\",4))
 ..s ok=0 i $l(date) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,$p(date,"/",3)) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) d
 .d
 ..i $e(xx)="<" s start=$o(^TEPIi("AUTHORISED","")),end=$$intdate^SSUTIL4("12/31/"_($e(xx,2,$l(xx))-1)) q
 ..i $e(xx)=">" s start=$$intdate^SSUTIL4("01/01/"_($e(xx,2,$l(xx))+1)),end=$o(^TEPIi("AUTHORISED",""),-1) q
 ..i xx["=" d  q
 ...i $l($p(xx,"=",1)) s start=$$intdate^SSUTIL4("01/01/"_$p(xx,"=",1))
 ...e  s start=$o(^TEPIi("AUTHORISED",""))
 ...i $l($p(xx,"=",2)) s end=$$intdate^SSUTIL4("12/31/"_$p(xx,"=",2))
 ...e  s end=$o(^TEPIi("AUTHORISED",""),-1)
 ..s start=$$intdate^SSUTIL4("01/01/"_xx),end=$$intdate^SSUTIL4("12/31/"_xx)
 .f date=start:1:end d
 ..s ep="" f  s ep=$o(^TEPIi("AUTHORISED",date,ep)) q:ep=""  d
 ...s ts="" f  s ts=$o(^TEPIi("AUTHORISED",date,ep,ts)) q:ts=""  d
 ....s tscnt="" f  s tscnt=$o(^TEPIi("AUTHORISED",date,ep,ts,tscnt)) q:tscnt=""  d
 .....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 .....s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Date of Last Authorisation
fn05(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),ts=$p(vts,"||",2),tscnt=$p(vts,"||",3),date=$p($g(^TEPI(ep,1,ts,tscnt)),"\",4)
 .. ; check if current date is the last date for the episode
 ..s ok=1,x1="" f  s x1=$o(^TEPI(ep,1,x1)) q:x1=""  d  q:'ok
 ...s x2="" f  s x2=$o(^TEPI(ep,1,x1,x2)) q:x2=""  d  q:'ok
 ....i date<$p($g(^TEPI(ep,1,x1,x2)),"\",4) s ok=0 k ^TMP("Query",$j,"OUT",vts)
 ..s ok=0 i $l(date) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) d  i $$compare(xx,date) s ok=1 q
 ...i $e(xx)="<" s xx=$e(xx,2,$l(xx)),xx="<"_$$tcvt(xx) q
 ...i $e(xx)=">" s xx=$e(xx,2,$l(xx)),xx=">"_$$tcvt(xx) q
 ...i xx["=" s xx1=$p(xx,"=",1),xx2=$p(xx,"=",2),xx=$s($l(xx1):$$tcvt(xx1),1:"")_"="_$s($l(xx2):$$tcvt(xx2),1:"") q
 ...s xx=$$tcvt(xx)
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) d
 .d
 ..i $e(xx)="<" s xx=$e(xx,2,$l(xx)),start=$o(^TEPIi("AUTHORISED","")),end=$$tcvt(xx)-1 q
 ..i $e(xx)=">" s xx=$e(xx,2,$l(xx)),start=$$tcvt(xx)+1,end=$o(^TEPIi("AUTHORISED",""),-1) q
 ..i xx["=" s xx1=$p(xx,"=",1),xx2=$p(xx,"=",2) d  q
 ...i $l(xx1) s start=$$tcvt(xx1)
 ...e  s start=$o(^TEPIi("AUTHORISED",""))
 ...i $l(xx2) s end=$$tcvt(xx2)
 ...e  s end=$o(^TEPIi("AUTHORISED",""),-1)
 ..s (start,end)=$$tcvt(xx)
 .f date=start:1:end d
 ..s ep="" f  s ep=$o(^TEPIi("AUTHORISED",date,ep)) q:ep=""  d
 ... ; check if current date is the last date for the episode
 ...s ok=1,x1="" f  s x1=$o(^TEPI(ep,1,x1)) q:x1=""  d  q:'ok
 ....s x2="" f  s x2=$o(^TEPI(ep,1,x1,x2)) q:x2=""  d  q:'ok
 .....i date<$p($g(^TEPI(ep,1,x1,x2)),"\",4) s ok=0
 ...i ok s ts="" f  s ts=$o(^TEPIi("AUTHORISED",date,ep,ts)) q:ts=""  d
 ....s tscnt="" f  s tscnt=$o(^TEPIi("AUTHORISED",date,ep,ts,tscnt)) q:tscnt=""  d
 .....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 .....s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Test Item Result - All
fn06(text,type) n (text,type,user) s text=$g(text),type=$g(type)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ok=$$val06(vts,text,,type)
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 ..i ok s $p(^TMP("Query",$j,"OUT",vts),$c(1),1)=$p(ok,$c(1),2)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ok=$$val06(vts,text,,type) i ok s $p(^TMP("Query",$j,"OUT",vts),$c(1),1)=$p(ok,$c(1),2)
 q
fn06a(text) n (text,user) s text=$g(text) d fn06(text,1) q
fn06b(text) n (text,user) s text=$g(text) d fn06(text,2) q
fn06c(text) n (text,user) s text=$g(text) d fn06(text,3) q
fn06d(text) n (text,user) s text=$g(text) d fn06(text,4) q
 ; type - 1.Code
 ;        2.Synonym
 ;        3.NN Long
 ;        4.NN Short
val06(vts,text,list,type) n (vts,text,list,type,user) s vts=$g(vts),text=$g(text),list=$g(list),type=$g(type),(ok1,ok3)=""
 f j=1:1:3 s @("z"_j)=$p(vts,"||",j)
 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) d  i ok1,'$l(ok3) q
 .s x1=$p(xx,"=",1),x2=$p(xx,"=",2,$l(xx,"="))
 .s x1=$$ALPHAUP^SSUTIL4(x1)
 .i $l(x1),$l(x2) d
 ..i '$l(type)!(type=1) s ti=x1 d val06a i ok1,'$l(ok3) q
 ..i '$l(type)!(type=2) s ti="" f  s ti=$o(^TTAB("SY",x1,"TC",ti)) q:ti=""  d val06a i ok1,'$l(ok3) q
 ..i '$l(type)!(type=3) s ti="" f  s ti=$o(^TTABi("TC","NNL",x1,ti)) q:ti=""  d val06a i ok1,'$l(ok3) q
 ..i '$l(type)!(type=4) s ti="" f  s ti=$o(^TTABi("TC","NNS",x1,ti)) q:ti=""  d val06a i ok1,'$l(ok3) q
 q ok1_$c(1)_ok3
val06a i $l(list),(","_list_",")'[(","_ti_",") q
 i (","_ok3_",")[(","_ti_",") q
 s ok2="" i $d(^TEPI(z1,1,z2,z3,"DATA",ti)) s result=$p($g(^(ti)),"\") i $l(result),$$compare(x2,result) s ok2=1
 i ok2 d
 .s xti=ti i $p(^TTAB("TC",ti),"\",3)'="V" s x=$p(^TTAB("TC",ti),"\",26) i $l(x) s xti="" i $p(^TTAB("TC",x),"\",3)="V" s xti=x
 .s ok1=1 i $l(xti) s ok3=ok3_$s($l(ok3):",",1:"")_xti
 q
 ; DayBook Accession number
fn07(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  s list=$p(^(vts),$c(1),2) d
 ..s ep=$p(vts,"||",1),(ok,xNew)=""
 ..s xAN="" f  s xAN=$o(^THIR(ep,xAN)) q:xAN=""  i $d(^THIR(ep,xAN,"TEST",vts)) d
 ...i $l(list),(","_list_",")'[(","_xAN_",") q
 ...s result=$$AccNoFormat^LVBCOM03(xAN)
 ...i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1,xNew=xNew_$s($l(xNew):",",1:"")_xAN q
 ..i ok s $p(^TMP("Query",$j,"OUT",vts),$c(1),2)=xNew
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^THIR(ep)) q:ep=""  d
 .s xAN="" f  s xAN=$o(^THIR(ep,xAN)) q:xAN=""  i $d(^THIR(ep,xAN,"TEST")) d
 ..s result=$$AccNoFormat^LVBCOM03(xAN)
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 ..i ok s vts="" f  s vts=$o(^THIR(ep,xAN,"TEST",vts)) q:vts=""  d
 ...i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s x=$p($g(^TMP("Query",$j,"OUT",vts)),$c(1),2)
 ...s x=x_$s($l(x):",",1:"")_xAN
 ...s $p(^TMP("Query",$j,"OUT",vts),$c(1),2)=x
 q
 ; Hospital bed
fn08(text) n (text,user) s text=$g(text) d fnCom1(text,29,0) q
 ; Doctor Reference
fn09(text) n (text,user) s text=$g(text) d fnCom3(text,4) q
 ; CCR codes
fn10(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..i '$$val10(vts,text) k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...i $$val10(vts,text) s ^TMP("Query",$j,"OUT",vts)=""
 q
val10(vts,text) n (vts,text,user) s vts=$g(vts),text=$g(text),ok=0
 f j=1:1:3 s @("x"_j)=$p(vts,"||",j)
 s ti="" f  s ti=$o(^TEPI(x1,1,x2,x3,"CCR",ti)) q:ti=""  s result=ti_^(ti) d  q:ok
 .f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 q ok
 ; Date of Admission
fn11(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),date=$p($g(^TEPI(ep,0)),"\",30)
 ..s ok=0 i $l(date) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) d  i $$compare(xx,date) s ok=1 q
 ...i $e(xx)="<" s xx=$e(xx,2,$l(xx)),xx="<"_$$tcvt(xx) q
 ...i $e(xx)=">" s xx=$e(xx,2,$l(xx)),xx=">"_$$tcvt(xx) q
 ...i xx["=" s xx1=$p(xx,"=",1),xx2=$p(xx,"=",2),xx=$s($l(xx1):$$tcvt(xx1),1:"")_"="_$s($l(xx2):$$tcvt(xx2),1:"") q
 ...s (start,end)=$$tcvt(xx)
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) d
 .d
 ..i $e(xx)="<" s xx=$e(xx,2,$l(xx)),start=$o(^TDAY(7,"")),end=$$tcvt(xx)-1 q
 ..i $e(xx)=">" s xx=$e(xx,2,$l(xx)),start=$$tcvt(xx)+1,end=$o(^TDAY(7,""),-1) q
 ..i xx["=" s xx1=$p(xx,"=",1),xx2=$p(xx,"=",2) d  q
 ...i $l(xx1) s start=$$tcvt(xx1)
 ...e  s start=$o(TDAY(7,""))
 ...i $l(xx2) s end=$$tcvt(xx2)
 ...e  s end=$o(TDAY(7,""),-1)
 ..s (start,end)=$$tcvt(xx)
 .f date=start:1:end d
 ..s ep="" f  s ep=$o(^TDAY(7,date,0,ep)) q:ep=""  d
 ...s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ....s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 .....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 .....s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Patient History
fn12(text) n (text,user) s text=$g(text),text=$$UPPER^SSUTIL4(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),mrn=$p($g(^TEPI(ep)),"\",18)
 ..i '$$select^LVBDEB(mrn,"Y") d
 ...s result=$$UPPER^SSUTIL4($tr(PLIST(7),"|"," "))
 ...s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 ...i 'ok k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s mrn=$p($g(^TEPI(ep)),"\",18)
 .i '$$select^LVBDEB(mrn,"Y") d
 ..s result=$$UPPER^SSUTIL4($tr(PLIST(7),"|"," "))
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 ..i ok s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ...s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ....s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Date of Birth
fn13(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),date=$p($g(^TEPI(ep)),"\",4)
 ..s ok=0 i $l(date) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) d  i $$compare(xx,date) s ok=1 q
 ...i $e(xx)="<" s xx=$e(xx,2,$l(xx)),xx="<"_$$tcvt(xx) q
 ...i $e(xx)=">" s xx=$e(xx,2,$l(xx)),xx=">"_$$tcvt(xx) q
 ...i xx["=" s xx1=$p(xx,"=",1),xx2=$p(xx,"=",2),xx=$s($l(xx1):$$tcvt(xx1),1:"")_"="_$s($l(xx2):$$tcvt(xx2),1:"") q
 ...s xx=$$tcvt(xx)
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) d
 .d
 ..i $e(xx)="<" s xx=$e(xx,2,$l(xx)),start=$o(^TIND(7,"")),end=$$tcvt(xx)-1 q
 ..i $e(xx)=">" s xx=$e(xx,2,$l(xx)),start=$$tcvt(xx)+1,end=$o(^TIND(7,""),-1) q
 ..i xx["=" s xx1=$p(xx,"=",1),xx2=$p(xx,"=",2) d  q
 ...i $l(xx1) s start=$$tcvt(xx1)
 ...e  s start=$o(TIND(7,""))
 ...i $l(xx2) s end=$$tcvt(xx2)
 ...e  s end=$o(TIND(7,""),-1)
 ..s (start,end)=$$tcvt(xx)
 .f date=start:1:end d
 ..s ep="" f  s ep=$o(^TIND(7,date,ep)) q:ep=""  d
 ...s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ....s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 .....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 .....s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Time of receival
fn14(text) n (text,user) s text=$g(text)
 s TEXT="" f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) d
 .i $e(xx)="<" s xx=$e(xx,2,$l(xx)),TEXT=TEXT_$s($l(TEXT):"|",1:"")_"<"_($p(xx,":",1)*60+$p(xx,":",2))
 .e  i $e(xx)=">" s xx=$e(xx,2,$l(xx)),TEXT=TEXT_$s($l(TEXT):"|",1:"")_">"_($p(xx,":",1)*60+$p(xx,":",2))
 .e  i xx["=" s xx1=$p(xx,"=",1),xx2=$p(xx,"=",2),TEXT=TEXT_$s($l(TEXT):"|",1:"")_$s($l(xx1):($p(xx1,":",1)*60+$p(xx1,":",2)),1:"")_"="_$s($l(xx2):($p(xx2,":",1)*60+$p(xx2,":",2)),1:"")
 .e  s TEXT=TEXT_$s($l(TEXT):"|",1:"")_($p(xx,":",1)*60+$p(xx,":",2))
 s text=TEXT d fnCom1(text,33)
 q
 ; Internal infection
fn15(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1)
 ..s x1=$p($g(^TEPI(ep)),"\",10),x2=$p($g(^TEPI(ep)),"\",11),x5=$p($g(^TEPI(ep)),"\",20)
 ..s x3=$p($g(^TEPI(ep,0)),"\",30),x4=$p($g(^TEPI(ep,0)),"\",34)
 ..s x6="N" i $l(x5) s x6=$p($g(^TTAB("RH",x5)),"\",16)
 ..s ok=0 i x1,x3,$p($g(^CF("LAB",1)),"^",74) d
 ...i text="Y",(((x1*24)+(x2\3600))-((x3*24)+(x4\3600)))>$p($g(^CF("LAB",1)),"^",74),x6="Y" s ok=1 q
 ...i text="N",(((x1*24)+(x2\3600))-((x3*24)+(x4\3600)))'>$p($g(^CF("LAB",1)),"^",74),x6="Y" s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s x1=$p($g(^TEPI(ep)),"\",10),x2=$p($g(^TEPI(ep)),"\",11),x5=$p($g(^TEPI(ep)),"\",20)
 .s x3=$p($g(^TEPI(ep,0)),"\",30),x4=$p($g(^TEPI(ep,0)),"\",34)
 .s x6="N" i $l(x5) s x6=$p($g(^TTAB("RH",x5)),"\",16)
 .s ok=0 i x1,x3,$p($g(^CF("LAB",1)),"^",74) d
 ..i text="Y",(((x1*24)+(x2\3600))-((x3*24)+(x4\3600)))>$p($g(^CF("LAB",1)),"^",74),x6="Y" s ok=1 q
 ..i text="N",(((x1*24)+(x2\3600))-((x3*24)+(x4\3600)))'>$p($g(^CF("LAB",1)),"^",74),x6="Y" s ok=1 q
 .i ok s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Antibiotic panel exist
fn16(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  s list=$p(^(vts),$c(1)) d
 ..s ep=$p(vts,"||",1),ts=$p(vts,"||",2),tscnt=$p(vts,"||",3),ok=0,xx=""
 ..s ti="" f  s ti=$o(^TEPI(ep,1,ts,tscnt,"DATA",ti)) q:ti=""  i $p($g(^TTAB("TC",ti)),"\",3)="V" d
 ...i $l(list),(","_list_",")'[(","_ti_",") q
 ...i text="Y" d
 ....s x="" f  s x=$o(^TEPI(ep,1,ts,tscnt,"DATA",ti,"ANT",x)) q:x=""  i $l($p(^(x),"\",1))!$l($p(^(x),"\",3))!$l($p(^(x),"\",4)) q
 ....i $l(x) s ok=1,xx=xx_$s($l(xx):",",1:"")_ti
 ...i text="N" d
 ....s x="" f  s x=$o(^TEPI(ep,1,ts,tscnt,"DATA",ti,"ANT",x)) q:x=""  i $l($p(^(x),"\",1))!$l($p(^(x),"\",3))!$l($p(^(x),"\",4)) q
 ....i '$l(x) s ok=1,xx=xx_$s($l(xx):",",1:"")_ti
 ..i ok s $p(^TMP("Query",$j,"OUT",vts),$c(1),1)=xx
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt,xx="" i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s (ok,ti)="" f  s ti=$o(^TEPI(ep,1,ts,tscnt,"DATA",ti)) q:ti=""  i $p($g(^TTAB("TC",ti)),"\",3)="V" d
 ....i text="Y" d
 .....s x="" f  s x=$o(^TEPI(ep,1,ts,tscnt,"DATA",ti,"ANT",x)) q:x=""  i $l($p(^(x),"\",1))!$l($p(^(x),"\",3))!$l($p(^(x),"\",4)) q
 .....i $l(x) s ok=1,xx=xx_$s($l(xx):",",1:"")_ti
 ....i text="N" d
 .....s x="" f  s x=$o(^TEPI(ep,1,ts,tscnt,"DATA",ti,"ANT",x)) q:x=""  i $l($p(^(x),"\",1))!$l($p(^(x),"\",3))!$l($p(^(x),"\",4)) q
 .....i '$l(x) s ok=1,xx=xx_$s($l(xx):",",1:"")_ti
 ...i ok s $p(^TMP("Query",$j,"OUT",vts),$c(1),1)=xx
 q
 ; Date of Collection
fn17(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),date=$p($g(^TEPI(ep)),"\",10)
 ..s ok=0 i $l(date) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) d  i $$compare(xx,date) s ok=1 q
 ...i $e(xx)="<" s xx=$e(xx,2,$l(xx)),xx="<"_$$tcvt(xx) q
 ...i $e(xx)=">" s xx=$e(xx,2,$l(xx)),xx=">"_$$tcvt(xx) q
 ...i xx["=" s xx1=$p(xx,"=",1),xx2=$p(xx,"=",2),xx=$s($l(xx1):$$tcvt(xx1),1:"")_"="_$s($l(xx2):$$tcvt(xx2),1:"") q
 ...s xx=$$tcvt(xx)
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) d
 .d
 ..i $e(xx)="<" s xx=$e(xx,2,$l(xx)),start=$o(^TDAY(1,"")),end=$$tcvt(xx)-1 q
 ..i $e(xx)=">" s xx=$e(xx,2,$l(xx)),start=$$tcvt(xx)+1,end=$o(^TDAY(1,""),-1) q
 ..i xx["=" s xx1=$p(xx,"=",1),xx2=$p(xx,"=",2) d  q
 ...i $l(xx1) s start=$$tcvt(xx1)
 ...e  s start=$o(^TDAY(1,""))
 ...i $l(xx2) s end=$$tcvt(xx2)
 ...e  s end=$o(^TDAY(1,""),-1)
 ..s (start,end)=$$tcvt(xx)
 .f date=start:1:end d
 ..s ep="" f  s ep=$o(^TDAY(1,date,0,ep)) q:ep=""  d
 ...s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ....s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 .....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 .....s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Date of Authorisation
fn18(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),ts=$p(vts,"||",2),tscnt=$p(vts,"||",3),date=$p($g(^TEPI(ep,1,ts,tscnt)),"\",4)
 ..s ok=0 i $l(date) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) d  i $$compare(xx,date) s ok=1 q
 ...i $e(xx)="<" s xx=$e(xx,2,$l(xx)),xx="<"_$$tcvt(xx) q
 ...i $e(xx)=">" s xx=$e(xx,2,$l(xx)),xx=">"_$$tcvt(xx) q
 ...i xx["=" s xx1=$p(xx,"=",1),xx2=$p(xx,"=",2),xx=$s($l(xx1):$$tcvt(xx1),1:"")_"="_$s($l(xx2):$$tcvt(xx2),1:"") q
 ...s xx=$$tcvt(xx)
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) d
 .d
 ..i $e(xx)="<" s xx=$e(xx,2,$l(xx)),start=$o(^TEPIi("AUTHORISED","")),end=$$tcvt(xx)-1 q
 ..i $e(xx)=">" s xx=$e(xx,2,$l(xx)),start=$$tcvt(xx)+1,end=$o(^TEPIi("AUTHORISED",""),-1) q
 ..i xx["=" s xx1=$p(xx,"=",1),xx2=$p(xx,"=",2) d  q
 ...i $l(xx1) s start=$$tcvt(xx1)
 ...e  s start=$o(^TEPIi("AUTHORISED",""))
 ...i $l(xx2) s end=$$tcvt(xx2)
 ...e  s end=$o(^TEPIi("AUTHORISED",""),-1)
 ..s (start,end)=$$tcvt(xx)
 .f date=start:1:end d
 ..s ep="" f  s ep=$o(^TEPIi("AUTHORISED",date,ep)) q:ep=""  d
 ...s ts="" f  s ts=$o(^TEPIi("AUTHORISED",date,ep,ts)) q:ts=""  d
 ....s tscnt="" f  s tscnt=$o(^TEPIi("AUTHORISED",date,ep,ts,tscnt)) q:tscnt=""  d
 .....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 .....s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Aerobic bottle
fn19a(text) n (text,user) s text=$g(text) d fnCom3(text,14) q
 ; Anaerobic bottle
fn19b(text) n (text,user) s text=$g(text) d fnCom3(text,15) q
 ; Verification Queues
fn20a(text) n (text,user) s text=$g(text) d fn20(text,"VQ") q
 ; ReadOnly Queues
fn20b(text) n (text,user) s text=$g(text) d fn20(text,"RQ") q
 ; Verification/ReadOnly Queues
fn20(text,type) n (text,type,user) s text=$g(text),type=$g(type)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 .. ; find last queue
 ..f j1=1:1:3 s @("x"_j1)=$p(vts,"||",j1)
 ..s (ok,queue)="" f  s queue=$o(^TEPI(x1,1,x2,x3,"QUEUE",type,queue)) q:queue=""  d  q:ok
 ...i $p(^TEPI(x1,1,x2,x3,"QUEUE",type,last),"\",5)="" d
 ....s result=$p(^TEPI(x1,1,x2,x3,"QUEUE",type,last),"\",1)
 ....i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 s result="" f  s result=$o(^TEPIi("QUEUE",type,result)) q:result=""  d
 .s ok=0 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 .i ok s ep="" f  s ep=$o(^TEPIi("QUEUE",type,result,ep)) q:ep=""  d
 ..s ts="" f  s ts=$o(^TEPIi("QUEUE",type,result,ep,ts)) q:ts=""  d
 ...s tscnt="" f  s tscnt=$o(^TEPIi("QUEUE",type,result,ep,ts,tscnt)) q:tscnt=""  d
 ....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ....s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Deceased
fn21(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1)
 ..s ok=0  d
 ...i text="Y",$p($g(^TEPI(ep,0)),"\",19)="Y" s ok=1 q
 ...i text="N",$p($g(^TEPI(ep,0)),"\",19)'="Y" s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 i text="Y" d
 .s ep="" f  s ep=$o(^TIND(17,ep)) q:ep=""  d
 ..s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ...s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ....s ^TMP("Query",$j,"OUT",vts)=""
 i text="N" d
 .s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  i '$d(^TIND(17,ep)) d
 ..s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ...s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ....s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Test Set
fn22(text) n (text,user) s text=$g(text),TEXT=text,text=""
 ; find list of TestSets
 d
 .i TEXT'["*",TEXT'["?" d  q
 ..f j=1:1:$l(TEXT,"|") s xx=$p(TEXT,"|",j) i $l(xx) d
 ...i $d(^TTAB("TS",xx)) s text=text_$s($l(text):"|",1:"")_xx q
 ...s x="" f  s x=$o(^TTAB("SY",xx,"TS",x)) q:x=""  s text=text_$s($l(text):"|",1:"")_x
 .s x1="" f  s x1=$o(^TTAB("TS",x1)) q:x1=""  d
 ..s ok="" f j1=2,3 s @("x"_j1)=$p(^TTAB("TS",x1),"\",j1)
 ..f j1=1:1:3 s result=@("x"_j1) i $l(result) d  q:ok
 ...f j2=1:1:$l(TEXT,"|") s xx=$p(TEXT,"|",j2) i $l(xx),$$compare(xx,result) s text=text_$s($l(text):"|",1:"")_x1,ok=1 q
 i $l(text) d
 .i $d(^TMP("Query",$j,"OUT")) d  q
 ..s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ...i ("|"_text_"|")'[("|"_$p(vts,"||",2)_"|") k ^TMP("Query",$j,"OUT",vts)
 .s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 ..s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  i ("|"_text_"|")[("|"_ts_"|") d
 ...s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ....s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Pathogen group
fn23(text) n (text,user) s text=$g(text),TEXT=text,text=""
 ; find list of Pathogens
 d
 .i TEXT'["*",TEXT'["?" d  q
 ..f j=1:1:$l(TEXT,"|") s xx=$p(TEXT,"|",j) i $l(xx) d
 ...s x="" f  s x=$o(^TTAB("BUG-GROUP",xx,"BUGS",x)) q:x=""  i ("|"_text_"|")'[("|"_x_"|") s text=text_$s($l(text):"|",1:"")_x
 .s x1="" f  s x1=$o(^TTAB("BUG-GROUP",x1)) q:x1=""  d
 ..s result=x1
 ..f j1=1:1:$l(TEXT,"|") s xx=$p(TEXT,"|",j1) i $l(xx),$$compare(xx,result) d
 ...s x="" f  s x=$o(^TTAB("BUG-GROUP",x1,"BUGS",x)) q:x=""  i ("|"_text_"|")'[("|"_x_"|") s text=text_$s($l(text):"|",1:"")_x
 i $l(text) d fn01(text)
 q
 ; Patient age
fn24(text) n (text,user) s text=$g(text) d fnCom1(text,25) q
 ; Warning message
fn25(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..i '$$val25(vts,text) k ^TMP("Query",$j,"OUT",vts)
 s mrn="" f  s mrn=$o(^TDEB(mrn)) q:mrn=""  i $$val25(,text,mrn) d
 .s x1="" f  s x1=$o(^TDEBi(mrn,"DATE",x1)) q:x1=""  d
 ..s x2="" f  s x2=$o(^TDEBi(mrn,"DATE",x1,x2)) q:x2=""  d
 ...s ep="" f  s ep=$o(^TDEBi(mrn,"DATE",x1,x2,ep)) q:ep=""  d
 ....s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 .....s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ......s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ......s ^TMP("Query",$j,"OUT",vts)=""
 q
val25(vts,text,mrn) n (vts,text,mrn,user) s vts=$g(vts),text=$g(text),mrn=$g(mrn),ok=0
 i '$l(mrn) s ep=$p(vts,"||"),mrn=$p($g(^TEPI(ep)),"\",18)
 i $l(mrn) d
 .s result=$p($g(^TDEB(mrn)),"\",3)
 .i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 q ok
 ; Antibiotic therapy
fn26(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..i '$$val26(vts,text) k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  i $$val26(ep,text) d
 .s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ^TMP("Query",$j,"OUT",vts)=""
 q
val26(vts,text) n (vts,text,user) s vts=$g(vts),text=$g(text),ok=0
 s ep=$p(vts,"||")
 s ti="" f  s ti=$o(^TEPI(ep,"AT",ti)) q:ti=""  s result=ti d  q:ok
 .f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 q ok
 ; Doctor - Surname
fn27a(text) n (text,user) s text=$g(text),text=$$UPPER^SSUTIL4(text),line=""
 s x="" f  s x=$o(^TTAB("DR",x)) q:x=""  s result=$$UPPER^SSUTIL4($p(^(x),"\",1)) i $l(result) d
 .f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) i $$compare(xx,result) s line=line_$s($l(line):"|",1:"")_x q
 i $l(line) d fnCom2(line,3)
 q
 ; Doctor - Code
fn27(text) n (text,user) s text=$g(text) d fnCom2(text,3) q
 ; Result type - NotEntered("C")/Entered("E")/Pathologist("P")/Hold("H")
fn28(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s result=$p($g(^TEPI($p(vts,"||",1),1,$p(vts,"||",2),$p(vts,"||",3))),"\",31)
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) d
 .s ep="" f  s ep=$o(^TEPIi("STATUS-EPISODE",xx,ep)) q:ep=""  d
 ..s ts="" f  s ts=$o(^TEPIi("STATUS-EPISODE",xx,ep,ts)) q:ts=""  d
 ...s tscnt="" f  s tscnt=$o(^TEPIi("STATUS-EPISODE",xx,ep,ts,tscnt)) q:tscnt=""  d
 ....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ....s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Patient name
fn29(text) n (text,user) s text=$g(text),text=$$UPPER^SSUTIL4(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),xx=$g(^TEPI(ep)),xx0=$g(^TEPI(ep,0))
 ..s result=$$UPPER^SSUTIL4($$NameFormat^LVBCOM03("PT",,$p(xx,"\",2),$p(xx,"\",1),$p(xx0,"\",23),$p(xx0,"\",24),$p(xx0,"\",25)))
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s xx=$g(^TEPI(ep)),xx0=$g(^TEPI(ep,0))
 .s result=$$UPPER^SSUTIL4($$NameFormat^LVBCOM03("PT",,$p(xx,"\",2),$p(xx,"\",1),$p(xx0,"\",23),$p(xx0,"\",24),$p(xx0,"\",25)))
 .s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 .i ok s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; MRN
fn30(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),result=$p($g(^TEPI(ep)),"\",18)
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 i text'["*",text'["?" d  q
 .f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) d
 ..s x1="" f  s x1=$o(^TDEBi(xx,"DATE",x1)) q:x1=""  d
 ...s x2="" f  s x2=$o(^TDEBi(xx,"DATE",x1,x2)) q:x2=""  d
 ....s ep="" f  s ep=$o(^TDEBi(xx,"DATE",x1,x2,ep)) q:ep=""  d
 .....s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ......s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 .......s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 .......s ^TMP("Query",$j,"OUT",vts)=""
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s result=$p($g(^TEPI(ep)),"\",18)
 .s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 .i ok s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Episode
fn31(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),result=ep
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 i text'["*",text'["?" d  q
 .f j1=1:1:$l(text,"|") s ep=$p(text,"|",j1) i $l(ep) d
 ..s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ...s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ....s ^TMP("Query",$j,"OUT",vts)=""
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s result=ep
 .s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 .i ok s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Special Interest Group
fn32(text) n (text,user) s text=$g(text) d fnCom1(text,33,0) q
 ; DayBook Laboratory
fn33(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  s list=$p(^(vts),$c(1),2) d
 ..s ep=$p(vts,"||",1),(ok,xNew)=""
 ..s xAN="" f  s xAN=$o(^THIR(ep,xAN)) q:xAN=""  i $d(^THIR(ep,xAN,"TEST",vts)) d
 ...i $l(list),(","_list_",")'[(","_xAN_",") q
 ...s result=$e(xAN)
 ...i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1,xNew=xNew_$s($l(xNew):",",1:"")_xAN q
 ..i ok s $p(^TMP("Query",$j,"OUT",vts),$c(1),2)=xNew
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^THIR(ep)) q:ep=""  d
 .s xAN="" f  s xAN=$o(^THIR(ep,xAN)) q:xAN=""  i $d(^THIR(ep,xAN,"TEST")) d
 ..s result=$e(xAN)
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 ..i ok s vts="" f  s vts=$o(^THIR(ep,xAN,"TEST",vts)) q:vts=""  d
 ...i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s x=$p($g(^TMP("Query",$j,"OUT",vts)),$c(1),2)
 ...s x=x_$s($l(x):",",1:"")_xAN
 ...s $p(^TMP("Query",$j,"OUT",vts),$c(1),2)=x
 q
 ; Speciality
fn34(text) n (text,user) s text=$g(text) d fnCom1(text,47) q
 ; Sex
fn35(text) n (text,user) s text=$g(text) d fnCom1(text,3) q
 ; Patient Location Original
fn36(text) n (text,user) s text=$g(text) d fnCom2(text,16) q
 ; Priority - Urgent(2)/InstantPrint(3)/Fax(4)/Phone(6)
fn37(text) n (text,user) s text=$g(text),TEXT=text,text=""
 ; find list of priorities
 s x1="" f  s x1=$o(^TTAB("PC",x1)) q:x1=""  d
 .f j1=1:1:$l(TEXT,"|") s xx=$p(TEXT,"|",j1) i $l(xx),$p(^TTAB("PC",x1),"\",xx)="Y" s text=text_$s($l(text):"|",1:"")_x1 q
 i $l(text) d fn38(text)
 q
 ; Priority
fn38(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s result=$$priority^LVBVISTS(vts)
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s result=$$priority^LVBVISTS(vts)
 ...s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 ...i ok s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Patient Location
fn39(text) n (text,user) s text=$g(text) d fnCom2(text,8) q
 ; Clinical History
fn40(text) n (text,user) s text=$g(text),text=$$UPPER^SSUTIL4(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1) i '$$select^LVBEPVIS(ep,"Y") d
 ...s result=$$UPPER^SSUTIL4($tr(PLIST(53),"|"," "))
 ...s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 ...i 'ok k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  i '$$select^LVBEPVIS(ep,"Y") d
 .s result=$$UPPER^SSUTIL4($tr(PLIST(53),"|"," "))
 .s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 .i ok s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Patient Given Name
fn41(text) n (text,user) s text=$g(text),text=$$UPPER^SSUTIL4(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),result=$$UPPER^SSUTIL4($p($g(^TEPI(ep)),"\",2))
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 s ok=1 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i ($e(xx)="*")!($e(xx)="?") s ok=0 q
 i ok d  q
 .f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) d
 ..s name="" f j=1:1:$l(xx) q:$e(xx,j)="?"  q:$e(xx,j)="*"  s name=name_$e(xx,j)
 ..i $l(name) s x1=name f  d  s x1=$o(^TIND("Name",10,x1)) q:$e(x1,1,$l(name))'=name
 ...s result=x1 i $$compare(xx,result) d
 ....s ep="" f  s ep=$o(^TIND("Name",10,x1,ep)) q:ep=""  d
 .....s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ......s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 .......s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 .......s ^TMP("Query",$j,"OUT",vts)=""
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s result=$$UPPER^SSUTIL4($p($g(^TEPI(ep)),"\",2))
 .s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 .i ok s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Patient Surname
fn42(text) n (text,user) s text=$g(text),text=$$UPPER^SSUTIL4(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),result=$p($g(^TEPI(ep)),"\",1)
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 s ok=1 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i ($e(xx)="*")!($e(xx)="?") s ok=0 q
 i ok d  q
 .f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) d
 ..s name="" f j=1:1:$l(xx) q:$e(xx,j)="?"  q:$e(xx,j)="*"  s name=name_$e(xx,j)
 ..i $l(name) s x1=name f  d  s x1=$o(^TIND("Name",11,x1)) q:$e(x1,1,$l(name))'=name
 ...s result=x1 i $$compare(xx,result) d
 ....s ep="" f  s ep=$o(^TIND("Name",11,x1,ep)) q:ep=""  d
 .....s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ......s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 .......s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 .......s ^TMP("Query",$j,"OUT",vts)=""
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s result=$$UPPER^SSUTIL4($p($g(^TEPI(ep)),"\",1))
 .s ok=0 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 .i ok s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Pensioner
fn43a(text) n (text,user) s text=$g(text) d fnCom3(text,10) q
 ; Medicare
fn43b(text) n (text,user) s text=$g(text) d fnCom3(text,1) q
 ; VA
fn43c(text) n (text,user) s text=$g(text) d fnCom3(text,9) q
 ; Specimen - Name
fn44a(text) n (text,user) s text=$g(text),text=$$UPPER^SSUTIL4(text),line=""
 s x="" f  s x=$o(^TTAB("SPEC",x)) q:x=""  s result=$$UPPER^SSUTIL4($p(^(x),"\",1)) i $l(result) d
 .f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) i $$compare(xx,result) s line=line_$s($l(line):"|",1:"")_x q
 i $l(line) d fn44(line)
 q
 ; Specimen - Code
fn44(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),ts=$p(vts,"||",2),tscnt=$p(vts,"||",3),result=$$UPPER^SSUTIL4($p($g(^TEPI(ep,1,ts,tscnt)),"\",46))
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s result=$$UPPER^SSUTIL4($p($g(^TEPI(ep,1,ts,tscnt)),"\",46))
 ...s ok=0 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 ...i ok s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Anatomical site - Name
fn45a(text) n (text,user) s text=$g(text),text=$$UPPER^SSUTIL4(text),line=""
 s x="" f  s x=$o(^TTAB("SPEC",x)) q:x=""  s result=$$UPPER^SSUTIL4($p(^(x),"\",1)) i $l(result) d
 .f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) i $$compare(xx,result) s line=line_$s($l(line):"|",1:"")_x q
 i $l(line) d fn45(line)
 q
 ; Anatomical site - Code
fn45(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),ts=$p(vts,"||",2),tscnt=$p(vts,"||",3),result=$$UPPER^SSUTIL4($p($g(^TEPI(ep,1,ts,tscnt)),"\",51))
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s result=$$UPPER^SSUTIL4($p($g(^TEPI(ep,1,ts,tscnt)),"\",51))
 ...s ok=0 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 ...i ok s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; Method of collection - Name
fn46a(text) n (text,user) s text=$g(text),text=$$UPPER^SSUTIL4(text),line=""
 s x="" f  s x=$o(^TTAB("CTMCL",x)) q:x=""  s result=$$UPPER^SSUTIL4($p(^(x),"\",1)) i $l(result) d
 .f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) i $$compare(xx,result) s line=line_$s($l(line):"|",1:"")_x q
 i $l(line) d fn46(line)
 q
 ; Method of collection - Code
fn46(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  s list=$p(^(vts),$c(1),2) d
 ..s ep=$p(vts,"||",1),xNew=""
 ..s xAN="" f  s xAN=$o(^THIR(ep,xAN)) q:xAN=""  i $d(^THIR(ep,xAN,"TEST",vts)) d
 ...i $l(list),(","_list_",")'[(","_xAN_",") q
 ...s result=$p(^THIR(ep,xAN),"\",12)
 ...s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 ...i ok s xNew=xNew_$s($l(xNew):",",1:"")_xAN
 ..i $l(xNew) s $p(^TMP("Query",$j,"OUT",vts),$c(1),2)=xNew
 ..e  k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s xAN="" f  s xAN=$o(^THIR(ep,xAN)) q:xAN=""  i $d(^THIR(ep,xAN,"TEST")) d
 ..s result=$p(^THIR(ep,xAN),"\",12)
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 ..i ok s vts="" f  s vts=$o(^THIR(ep,xAN,"TEST",vts)) q:vts=""  d
 ...i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s x=$p($g(^TMP("Query",$j,"OUT",vts)),$c(1),2)
 ...s x=x_$s($l(x):",",1:"")_xAN
 ...s $p(^TMP("Query",$j,"OUT",vts),$c(1),2)=x
 q
 ; Specimen group - Code
fn47a(text) n (text,user) s text=$g(text),text=$$UPPER^SSUTIL4(text),line=""
 s x1="" f  s x1=$o(^TTAB("CTSG",x1)) q:x1=""  s result=$$UPPER^SSUTIL4(x1) i $l(result) d
 .f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) i $$compare(xx,result) d  q
 ..s x2="" f  s x2=$o(^TTAB("CTSG",x1,x2)) q:x2=""  i ("|"_line_"|")'[("|"_x2_"|") s line=line_$s($l(line):"|",1:"")_x2
 i $l(line) d fn44(line)
 q
 ; Specimen group - Name
fn47b(text) n (text,user) s text=$g(text),text=$$UPPER^SSUTIL4(text),line=""
 s x1="" f  s x1=$o(^TTAB("CTSG",x1)) q:x1=""  s result=$$UPPER^SSUTIL4($p(^(x1),"\",1)) i $l(result) d
 .f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) i $$compare(xx,result) d  q
 ..s x2="" f  s x2=$o(^TTAB("CTSG",x1,x2)) q:x2=""  i ("|"_line_"|")'[("|"_x2_"|") s line=line_$s($l(line):"|",1:"")_x2
 i $l(line) d fn44(line)
 q
 ; DayBook Specimen - Code
fn48(text) n (text,user) s text=$g(text) d fnCom4(text,1) q
 ; DayBook Anatomical site - Code
fn49(text) n (text,user) s text=$g(text) d fnCom4(text,5) q
 q
 ; Extra field 1-10
fn50a(text) n (text,user) s text=$g(text) d fnCom1(text,1,8) q
fn50b(text) n (text,user) s text=$g(text) d fnCom1(text,2,8) q
fn50c(text) n (text,user) s text=$g(text) d fnCom1(text,3,8) q
fn50d(text) n (text,user) s text=$g(text) d fnCom1(text,4,8) q
fn50e(text) n (text,user) s text=$g(text) d fnCom1(text,5,8) q
fn50f(text) n (text,user) s text=$g(text) d fnCom1(text,6,8) q
fn50g(text) n (text,user) s text=$g(text) d fnCom1(text,7,8) q
fn50h(text) n (text,user) s text=$g(text) d fnCom1(text,8,8) q
fn50i(text) n (text,user) s text=$g(text) d fnCom1(text,9,8) q
fn50j(text) n (text,user) s text=$g(text) d fnCom1(text,10,8) q
 ; DayBook Specimen group - Code
fn51a(text) n (text,user) s text=$g(text),text=$$UPPER^SSUTIL4(text),line=""
 s x1="" f  s x1=$o(^TTAB("CTSG",x1)) q:x1=""  s result=$$UPPER^SSUTIL4(x1) i $l(result) d
 .f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) i $$compare(xx,result) d  q
 ..s x2="" f  s x2=$o(^TTAB("CTSG",x1,x2)) q:x2=""  i ("|"_line_"|")'[("|"_x2_"|") s line=line_$s($l(line):"|",1:"")_x2
 i $l(line) d fnCom4(line,1)
 q
 ; Visit Action Multiple - Code
fn52(text) n (text,user) s text=$g(text)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),ok=0
 ..s result="" f  s result=$o(^TEPI(ep,"VA",result)) q:result=""  d  q:ok
 ...f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s result="" f  s result=$o(^TEPI(ep,"VA",result)) q:result=""  d
 ..s ok=0 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 ..i ok s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ...s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ....s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; type -  3, .Sex
 ;        25, .Patient age
 ;        29,0.Hospital bed
 ;        33, .Time of receival
 ;        33,0.Special Interest Group
 ;        47, .Speciality
fnCom1(text,type1,type2) n (text,type1,type2,user) s text=$g(text),type1=$g(type1),type2=$g(type2)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1)
 ..i $l(type2) s result=$p($g(^TEPI(ep,type2)),"\",type1)
 ..e  s result=$p($g(^TEPI(ep)),"\",type1)
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .i $l(type2) s result=$p($g(^TEPI(ep,type2)),"\",type1)
 .e  s result=$p($g(^TEPI(ep)),"\",type1)
 .s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 .i ok s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; type - 3.Doctor code
 ;        8.Patient Location
 ;       16.Patient Location - Original
fnCom2(text,type) n (text,type,user) s text=$g(text),type=$g(type)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),result=$p($g(^TEPI(ep)),"\",$s(type=8:20,type=16:54,type=3:13,1:999))
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 i text'["*",text'["?" d  q
 .f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) d
 ..s x1="" f  s x1=$o(^TIND(type,xx,x1)) q:x1=""  d
 ...s ep="" f  s ep=$o(^TIND(type,xx,x1,ep)) q:ep=""  d
 ....s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 .....s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ......s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ......s ^TMP("Query",$j,"OUT",vts)=""
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s result=$p($g(^TEPI(ep)),"\",$s(type=8:20,type=16:54,type=3:13,1:999))
 .s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 .i ok s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; type -  1.Medicare
 ;         4.Doctor Reference
 ;         9.VA
 ;        10.Pensioner
 ;        14.Aerobic bottle
 ;        15.Anaerobic bottle
fnCom3(text,type) n (text,type,user) s text=$g(text),type=$g(type)
 s TEXT="" f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) s TEXT=TEXT_$s($l(TEXT):"|",1:"")_$tr($$UPPER^SSUTIL4(xx),"~`!@#$%^&()-_+={}[]|\;:""'<>,./")
 s text=TEXT
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  d
 ..s ep=$p(vts,"||",1),result=$$UPPER^SSUTIL4($p($g(^TEPI(ep)),"\",$s(type=4:14,type=10:45,type=1:6,type=9:46,type=14:52,type=15:53,1:999)))
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx),$$compare(xx,result) s ok=1 q
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 i text'["*",text'["?" d  q
 .f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $l(xx) d
 ..s ep="" f  s ep=$o(^TIND(type,xx,ep)) q:ep=""  d
 ...s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ....s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 .....s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 .....s ^TMP("Query",$j,"OUT",vts)=""
 s ep="" f  s ep=$o(^TEPI(ep)) q:ep=""  d
 .s result=$$UPPER^SSUTIL4($p($g(^TEPI(ep)),"\",$s(type=4:14,type=10:45,type=1:6,type=9:46,type=14:52,type=15:53,1:999)))
 .s ok=0 f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 .i ok s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d
 ..s tscnt="" f  s tscnt=$o(^TEPI(ep,1,ts,tscnt)) q:tscnt=""  d
 ...s vts=ep_"||"_ts_"||"_tscnt i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s ^TMP("Query",$j,"OUT",vts)=""
 q
 ; type -  1.DayBook Specimen
 ;         5.DayBook Anatomical site
fnCom4(text,type) n (text,type,user) s text=$g(text),type=$g(type)
 i $d(^TMP("Query",$j,"OUT")) d  q
 .s vts="" f  s vts=$o(^TMP("Query",$j,"OUT",vts)) q:vts=""  s list=$p(^(vts),$c(1),2) d
 ..s ep=$p(vts,"||",1),(ok,xNew)=""
 ..s xAN="" f  s xAN=$o(^THIR(ep,xAN)) q:xAN=""  i $d(^THIR(ep,xAN,"TEST",vts)) d
 ...i $l(list),(","_list_",")'[(","_xAN_",") q
 ...s result=$p($g(^THIR(ep,xAN)),"\",type)
 ...i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1,xNew=xNew_$s($l(xNew):",",1:"")_xAN q
 ..i ok s $p(^TMP("Query",$j,"OUT",vts),$c(1),2)=xNew
 ..i 'ok k ^TMP("Query",$j,"OUT",vts)
 s ep="" f  s ep=$o(^THIR(ep)) q:ep=""  d
 .s xAN="" f  s xAN=$o(^THIR(ep,xAN)) q:xAN=""  i $d(^THIR(ep,xAN,"TEST")) d
 ..s result=$p($g(^THIR(ep,xAN)),"\",type)
 ..s ok=0 i $l(result) f j1=1:1:$l(text,"|") s xx=$p(text,"|",j1) i $$compare(xx,result) s ok=1 q
 ..i ok s vts="" f  s vts=$o(^THIR(ep,xAN,"TEST",vts)) q:vts=""  d
 ...i $$ValUser^LVBVISTS(user,vts,"V")>50 q
 ...s x=$p($g(^TMP("Query",$j,"OUT",vts)),$c(1),2)
 ...s x=x_$s($l(x):",",1:"")_xAN
 ...s $p(^TMP("Query",$j,"OUT",vts),$c(1),2)=x
 q
tcvt(xx) n (xx) s xx=$g(xx)
 i $e($$UPPER^SSUTIL4(xx))="T" d  q ret
 .i $e(xx,2)="-" s ret=$h-$e(xx,3,$l(xx))
 .e  i $e(xx,2)="+" s ret=$h+$e(xx,3,$l(xx))
 .e  s ret=+$h
 q $$intdate^SSUTIL4($p(xx,"/",2)_"/"_$p(xx,"/",1)_"/"_$p(xx,"/",3))
]]></Routine>
</Export>
