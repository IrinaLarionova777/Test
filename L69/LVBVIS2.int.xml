<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="24">
<Routine name="LVBVIS2" type="INT" languagemode="0" generated="1"><![CDATA[
LVBVIS2 ; IG 7/5/98 ; Visit routines
 ;
 ; supported calls :
 ;
 ; $$cumres^LVBVIS2(vtsROWID,include,type,Continue)
 ; $$check^LVBVIS2(epis,ts)
 ; $$reminder^LVBVIS2(epis,pc,batch,seq)
 ; $$BBspecimen^LVBVIS2(ur)
 ; $$panel^LVBVIS2(vtsRID,type,mode,Continue)
 ;
 ; type :     - Patient
 ;        BBP - BloodBank pack
 ; mode : LRE - LabResultEntry
 ;        LRI - LabResultEnquiry
 ;        WRE - WorkSheetResultEntry
 ;        IRE - InstrumentResultEntry
 ;        MVS - MedicalvalidationScreen
 ;        DBE - DayBookEntry
 ;        ISR - InstantReprint
 ;        WEB - WebViewer
 ;
 ; demographic panel : data1 & data2 & data3 & ... & dataN
 ; data1 : 1 - data string
 ;         2 - position left
 ;         3 - position top
 ;         4 - font name
 ;         5 - font size
 ;         6 - bold
 ;         7 - italic
 ;         8 - underline
 ;         9 - backcolor
 ;        10 - forecolor
 ;        11 - bitmap file
 ;        12 - position right
 ;        13 - flash
 ;        14 - moving text
 ;        15 - position right (extreme)
 ; data2 : 1 - action dll                        Double click
 ;         2 - action parameters
 ; data3...N : 1    - action dll                 Right click
 ;             2    - description
 ;             3... - action parameters
panel(vtsRID,type,mode,user,Continue) n (vtsRID,type,mode,user,Continue,PLIST) k PLIST
 s vtsRID=$g(vtsRID),type=$g(type),mode=$g(mode),user=$g(user),Continue=$g(Continue)
 ; get client specific routine
 s %routine=$p($g(^TTAB("REPORT-GENERIC","PANEL")),"\",1)
 i $l(%routine),%routine'=$zn x "s x=$$panel^"_%routine_"("""_vtsRID_""","""_type_""","""_mode_""","""_user_""","""_Continue_""")" q x
 i Continue="Y" g panelContinue
 k ^TMP($zn,$j) s del1=$c(2),del2=$c(28),epis=$p(vtsRID,"||",1),ts=$p(vtsRID,"||",2),tscnt=$p(vtsRID,"||",3)
 k CFLAB i '$$select^MVBCFLAB(1) m CFLAB=PLIST
 k CFSM i '$$select^MVBCFSM(1) m CFSM=PLIST
 s Queue="" i $l(epis),$l(ts),$l(tscnt),$d(^TEPI(epis,1,ts,tscnt,"QUEUE","VQ")) d
 .s x=$o(^TEPI(epis,1,ts,tscnt,"QUEUE","VQ",""),-1)
 .i '$$select^LVBVISTQ(epis_"||"_ts_"||"_tscnt_"||VQ||"_x) d
 ..f j=1:1:PLIST i $d(PLIST(j)) s PLIST(j)=$p(PLIST(j),$c(1))
 ..i '$l(PLIST(7)) s Queue=PLIST(10)
 i vtsRID'="." d
 .k VISTS i $l(vtsRID),'$$select^LVBVISTS(vtsRID) m VISTS=PLIST
 .k EPVIS i $l(epis),'$$select^LVBEPVIS(epis) m EPVIS=PLIST i type="" d
 ..k DEB,DEBDH i $l($p(PLIST(20),$c(1))) s deb=$p(PLIST(20),$c(1)) d
 ...i '$$select^LVBDEB(deb) m DEB=PLIST
 ...i '$$select^LVBDEBDH(deb_"||"_$e(ts)) m DEBDH=PLIST
 ..k DEBBT i '$$getall^LVBDEBBT($p(EPVIS(20),$c(1))),PLIST m DEBBT=PLIST
 ..k ANTRG s x=$$getall^LVBANTRG(,$p(EPVIS(20),$c(1)),"AR") i PLIST m ANTRG=PLIST
 ..k TRR s x=$$getall^LVBANTRG(,$p(EPVIS(20),$c(1)),"TRR") i PLIST m TRR=PLIST
 ..k ATR s x=$$getall^LVBANTRG(,$p(EPVIS(20),$c(1)),"ATR") i PLIST m ATR=PLIST
 ..s donors=$$donors^LVBDEB($p(EPVIS(20),$c(1))) i $l(donors) s x=$$getall^LVBANTRG(,,"ATR",donors) i PLIST f j=1:1:PLIST s i=$o(ATR(""),-1)+1,ATR(i)=PLIST(j)
 .s eXM=100 i $$seldata^LVBCTTS($p(vtsRID,"||",2),69)="Y" s eXM=$$eXM^LVBCOM04(,$p(EPVIS(20),$c(1)),vtsRID)
 .
 . ; Neonatal TS
 .
 .k mDEM,mEPVIS,mANTRG,mTRR,mATR
 .i $g(VISTS(67))="Y",$l($g(DEB(12))) d
 ..i '$$select^LVBDEB($p(DEB(12),$c(1))) m mDEB=PLIST
 ..i $l(mDEB(4)),'$$select^LVBEPVIS(mDEB(4)) m mEPVIS=PLIST
 ..s x=$$getall^LVBANTRG(,$p(mEPVIS(20),$c(1)),"AR") i PLIST m mANTRG=PLIST
 ..s x=$$getall^LVBANTRG(,$p(mEPVIS(20),$c(1)),"TRR") i PLIST m mTRR=PLIST
 ..s x=$$getall^LVBANTRG(,$p(mEPVIS(20),$c(1)),"ATR") i PLIST m mATR=PLIST
 .
 .i type="BBP" d
 ..k BBP i $l(epis),'$$select^LVBBBP($p(epis,"_",2)_"||"_$p(epis,"_",3)) m BBP=PLIST
 ..k BBPA i $l(epis),'$$getall^LVBBBPA($p(epis,"_",2)_"||"_$p(epis,"_",3)) m BBPA=PLIST
 ..k BBPC i $l(epis),'$$getall^LVBBBPC($p(epis,"_",2)_"||"_$p(epis,"_",3)) m BBPC=PLIST
 ..k BBPT i $l(epis),'$$sellast^LVBBBPT($p(epis,"_",2)_"||"_$p(epis,"_",3),,"Y") m BBPT=PLIST
 i '$d(EPVIS) s EPVIS=200 f j=1:1:200 s EPVIS(j)=""
 i '$d(VISTS) s VISTS=200 f j=1:1:200 s VISTS(j)=""
 i type="" d
 .s epName=$$NameFormat^LVBCOM03("PT",$p(EPVIS(7),$c(1),2),EPVIS(4),EPVIS(3),EPVIS(99),EPVIS(100),EPVIS(101))
 .s mName="" i $d(mEPVIS) s mName=$$NameFormat^LVBCOM03("PT",$p(mEPVIS(7),$c(1),2),mEPVIS(4),mEPVIS(3),mEPVIS(99),mEPVIS(100),mEPVIS(101))
 .i '$d(DEB) s DEB=50 f j=1:1:50 s DEB(j)=""
 .i '$d(DEBDH) s DEBDH=50 f j=1:1:50 s DEBDH(j)=""
 i type="BBP" d
 .i '$d(BBP) s BBP=200 f j=1:1:200 s BBP(j)=""
 .i '$d(BBPT) s BBPT=50 f j=1:1:50 s BBPT(j)=""
 s color(1)=-2147483645  ; disabled-backcolor
 s color(2)=-2147483629  ; disabled-forecolor
 s color(3)=-2147483633  ; normal-backcolor
 s color(4)=-2147483630  ; normal-forecolor
 s color(5)=-2147483643  ; window-backcolor
 s color(6)=-2147483631  ; window-forecolor
 s color(7)=-2147483635  ; selected-backcolor
 s color(8)=-2147483634  ; selected-forecolor
 s color(9)=-2147483646  ; titlebar-backcolor
 s color(10)=-2147483639 ; titlebar-forecolor
 s color("black")=0
 s color("maroon")=128
 s color("red")=255
 s color("orange")=25599
 s color("green")=32768
 s color("olive")=32896
 s color("lime")=65280
 s color("yellow")=65535
 s color("beige")=4377855
 s color("purple")=8388736
 s color("grey")=8421504
 s color("blue")=16711680
 s color("fuchsia")=16711935
 s color("cyan")=16776960
 s color("white")=16777215
 ; panel backcolor
 s xx1="" f j=1:1:$g(EPVIS) s $p(xx1,$c(2),j)=EPVIS(j)
 s xx2="" f j=1:1:$g(DEB) s $p(xx2,$c(2),j)=DEB(j)
 s ^TMP($zn,$j,1)=color(3)
 s ^TMP($zn,$j,2)=xx1
 s ^TMP($zn,$j,3)=xx2
 s ^TMP($zn,$j,4)=$g(DEBDH(3))_del2_$e(ts)
 s top=-5
 i vtsRID="." d  g panelContinue
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="New MRN"_del1_"3500"_del1_(top+700)_del1_"Arial"_del1_"20"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color("blue")_del1_del1_del1_del1_del1_"7000"
 i type="" d
 . ;
 . ; line - 1
 . ;
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="MRN"_del1_"50"_del1_(top)_del1_"Arial"_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"600"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(EPVIS(20),$c(1))_del1_"600"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color("cyan")_del1_del1_"1800"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Episode"_del1_"1900"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"2700"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(EPVIS(2),$c(1))_del1_"2700"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color("yellow")_del1_del1_"4000"
 .i 'eXM s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="eXM"_del1_"4050"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_del1_color("red")_del1_del1_del1_del1_del1_"4500"
 .i $l($p(EPVIS(65),$c(1))),$p(EPVIS(65),$c(1))'="," d
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Hosp."_del1_"4500"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"5000"
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p($p(EPVIS(65),$c(1)),",",1)_del1_"5000"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(10)_del1_del1_"6200"
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p($p(EPVIS(65),$c(1)),",",2)_del1_"6275"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(10)_del1_del1_"7475"
 .i $l($p(EPVIS(66),$c(1),2)) d
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(EPVIS(66),$c(1),2)_del1_"7600"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_$s(Queue="":"9400",1:"8700")
 .i $l(Queue) d
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_Queue_del1_"8800"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color("white")_del1_del1_"9400"
 . ;
 . ; line - 2
 . ;
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=epName_del1_"50"_del1_(top+230)_del1_del1_"14"_del1_"Y"_del1_"N"_del1_"N"_del1_del1_color("blue")_del1_del1_del1_del1_del1_"5000"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(EPVIS(5),$c(1),1)_del1_"5000"_del1_(top+270)_del1_del1_"10"_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"5300"
 .d
 ..i 'EPVIS(26) s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" UNKNOWN"_del1_"5375"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200" q
 ..i EPVIS(26)<1 s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_(EPVIS(26)*1000)_" d"_del1_"5375"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200" q
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_EPVIS(26)_" y"_del1_"5375"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$$extdate2^SSUTIL4(EPVIS(6))_del1_"6275"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"7475"
 .i $l($p(EPVIS(22),$c(1),2)) d
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(EPVIS(22),$c(1),2)_del1_"7600"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"9400"
 . ;
 . ; line - 3
 . ;
 . ; Neonatal - display Mother's details
 .i $g(VISTS(67))="Y",'$l($g(DEB(12))) d
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="No mother's details on file"_del1_"50"_del1_(top+505)_del1_del1_"14"_del1_"Y"_del1_"N"_del1_"N"_del1_del1_color("red")_del1_del1_del1_"Y"_del1_del1_"5000"
 .i $g(VISTS(67))="Y",$l($g(DEB(12))) d
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=mName_del1_"50"_del1_(top+505)_del1_del1_"14"_del1_"Y"_del1_"N"_del1_"N"_del1_del1_color("blue")_del1_del1_del1_del1_del1_"5000"
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(mEPVIS(5),$c(1),1)_del1_"5000"_del1_(top+545)_del1_del1_"10"_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"5300"
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_mEPVIS(26)_" y"_del1_"5375"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200"
 ..s left=6275
 ..i $d(mTRR) d
 ...s xx1="clstkLTABRegistry"_del1_"MRN="_$p(mEPVIS(20),$c(1))_del1_"TYPE=TRR"
 ...s xx2="clstkLTABRegistry"_del1_"Transfusion Reaction Registry..."_del1_"MRN="_$p(mEPVIS(20),$c(1))_del1_"TYPE=TRR"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" TRR"_del1_left_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color("fuchsia")_del1_del1_(left+475)_del2_xx1_del2_xx2
 ...s left=left+525
 ..i $d(mATR) d
 ...s xx1="clstkLTABRegistry"_del1_"MRN="_$p(mEPVIS(20),$c(1))_del1_"TYPE=ATR"_del1_"DONOR="_$p(EPVIS(46),$c(1),1)
 ...s xx2="clstkLTABRegistry"_del1_"Antigen Registry..."_del1_"MRN="_$p(mEPVIS(20),$c(1))_del1_"TYPE=ATR"_del1_"DONOR="_$p(EPVIS(46),$c(1),1)
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" ATR"_del1_left_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color("fuchsia")_del1_del1_(left+475)_del2_xx1_del2_xx2
 ...s left=left+525
 ..i $d(mANTRG) d
 ...s xx1="clstkLTABRegistry"_del1_"MRN="_$p(mEPVIS(20),$c(1))_del1_"TYPE=AR"
 ...s xx2="clstkLTABRegistry"_del1_"Antibody Registry..."_del1_"MRN="_$p(mEPVIS(20),$c(1))_del1_"TYPE=AR"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" AR"_del1_left_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color("fuchsia")_del1_del1_(left+350)_del2_xx1_del2_xx2
 ...s left=left+400
 ..s bg=""
 ..s mbgtxt="Mother's BG"
 ..i left<7600 s left=7600
 ..i left>6300 s mbgtxt=""
 ..i '$l(bg),$l(mDEB(9)) d
 ...s (bg,xx)=" "_$p(mDEB(9),$c(1),2) ;i CFLAB(31)="Y",$$BloodGroup^LVBCTTS(ts)="Y" s xx="#################"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=mbgtxt_del1_"6650"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=xx_del1_left_del1_del1_del1_del1_"Y"_del1_del1_"N"_del1_color("black")_del1_color("yellow")_del1_del1_"9400"
 ..i '$l(bg),$l(mDEB(16)) d
 ...s (bg,xx)=" "_$p(mDEB(16),$c(1),2) ;i CFLAB(31)="Y",$$BloodGroup^LVBCTTS(ts)="Y" s xx="#################"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=mbgtxt_del1_"6275"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=xx_del1_left_del1_del1_del1_del1_"Y"_del1_del1_"N"_del1_color(9)_del1_color("red")_del1_del1_"9400"
 ..i '$l(bg),$l(mDEB(15)) d
 ...s (bg,xx)=" "_$p(mDEB(15),$c(1),2) ;i CFLAB(31)="Y",$$BloodGroup^LVBCTTS(ts)="Y" s xx="#################"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=mbgtxt_del1_"6275"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=xx_del1_left_del1_del1_del1_del1_"Y"_del1_del1_"N"_del1_color(9)_del1_color("white")_del1_del1_"9400"
 . ; not Neonatal - display patient's details
 .i $g(VISTS(67))'="Y" d
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=EPVIS(32)_$s($l(EPVIS(33)):" "_EPVIS(33),1:"")_$s($l(EPVIS(34)):" "_EPVIS(34),1:"")_$s($l(EPVIS(35)):" "_EPVIS(35),1:"")_$s($l(EPVIS(36)):" "_EPVIS(36),1:"")_del1_"50"_del1_(top+575)_del1_del1_"8"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color("black")_del1_del1_del1_del1_del1_"6200"
 ..i $l(EPVIS(43))!$l(EPVIS(44)) d
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=del1_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color("black")_del1_"phone.bmp"_del1_del1_del1_del1_"6200"
 ...i $l(EPVIS(43)) s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=EPVIS(43)_"(h)  "_del1_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color("black")_del1_del1_del1_del1_del1_"6200"
 ...i $l(EPVIS(44)) s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=EPVIS(44)_"(w)"_del1_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color("black")_del1_del1_del1_del1_del1_"6200"
 ..i $l(EPVIS(19)) d
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Fast"_del1_"6275"_del1_(top+(270*2))_del1_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"6700"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(EPVIS(19),$c(1),1)_del1_"6700"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6975"
 ..i EPVIS(63)="Y" d
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Preg"_del1_"7050"_del1_(top+(270*2))_del1_del1_"10"_del1_"Y"_del1_"N"_del1_"N"_del1_del1_color("red")_del1_del1_del1_del1_del1_"7600"
 ..s xx=$s($l(VISTS(13)):VISTS(13),1:EPVIS(17)) i $l(xx) d
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(xx,$c(1),2)_del1_"7600"_del1_(top+(270*2))_del1_del1_"10"_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_$s($p(xx,$c(1),3)="Y":color("red"),1:color(2))_del1_del1_"8500"_del1_$s($p(xx,$c(1),3)="Y":"Y",1:"")
 ..i $l(EPVIS(94)) d
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Cat."_del1_"8600"_del1_(top+(270*2))_del1_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"9000"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(EPVIS(94),$c(1),1)_del1_"9000"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"9400"
 . ;
 . ; line - 4
 . ;
 .s xx1="tkLTClinicalHist"_del1_"NM="_epName_del1_"EP="_$p(EPVIS(2),$c(1))
 .s xx2="tkLTClinicalHist"_del1_"Clinical History..."_del1_"NM="_epName_del1_"EP="_$p(EPVIS(2),$c(1))
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Clin.Hist."_del1_"50"_del1_(top+(270*3))_del1_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"850"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$e(EPVIS(53),1,200)_del1_"850"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200"_del1_del1_"Y"_del2_xx1_del2_xx2
 .i $l(epis),$d(^TEPI(epis,"AT")) d
 ..s xx1="frmDemoAT"_del1_"EP="_$p(EPVIS(2),$c(1))
 ..s xx2="frmDemoAT"_del1_"Antibiotic Therapy..."_del1_"EP="_$p(EPVIS(2),$c(1))
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" AT"_del1_"6275"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color("cyan")_del1_del1_"6600"_del2_xx1_del2_xx2
 .s dt=""
 .i $l(EPVIS(12)) s dt=$p(EPVIS(12),$c(1),1)_","_$p(EPVIS(13),$c(1),1)
 .i $l(VISTS(49)) s dt=$p(VISTS(49),$c(1),1)_","_$p(VISTS(50),$c(1),1)
 .i $l(dt) d
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Collection"_del1_"6650"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$$extdate2^SSUTIL4($p(dt,",",1))_del1_"7600"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"8700"
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$s(CFSM(8)=$p(dt,",",2):$p(dt,",",2),1:$$exttime^SSUTIL4($p(dt,",",2)))_del1_"8800"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"9400"
 . ;
 . ; line - 5
 . ;
 .i " ISR "'[(" "_mode_" ") d
 ..s xx1="" i $l($p(EPVIS(20),$c(1))) s xx1="MRNHist"_del1_"MRN="_$p(EPVIS(20),$c(1))_del1_"NM="_epName_del1_"PW="_$p(DEB(5),$c(1))
 ..s xx2="" i $l($p(EPVIS(20),$c(1))) s xx2="MRNHist"_del1_"Patient History..."_del1_"MRN="_$p(EPVIS(20),$c(1))_del1_"NM="_epName_del1_"PW="_$p(DEB(5),$c(1))
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Pat.Hist."_del1_"50"_del1_(top+(270*4))_del1_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"850"
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$e(DEB(7),1,200)_del1_"850"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_$s($d(TRR)&$d(ATR):"5050",$d(TRR)!$d(ATR):"5625",1:"6200")_del1_del1_"Y"_del2_xx1_del2_xx2
 ..i $d(TRR) d
 ...s xx1="clstkLTABRegistry"_del1_"MRN="_$p(EPVIS(20),$c(1))_del1_"TYPE=TRR"
 ...s xx2="clstkLTABRegistry"_del1_"Transfusion Reaction Registry..."_del1_"MRN="_$p(EPVIS(20),$c(1))_del1_"TYPE=TRR"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" TRR"_del1_$s($d(ATR):"5125",1:"5700")_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color("fuchsia")_del1_del1_$s($d(ATR):"5625",1:"6200")_del2_xx1_del2_xx2
 ..i $d(ATR) d
 ...s xx1="clstkLTABRegistry"_del1_"MRN="_$p(EPVIS(20),$c(1))_del1_"TYPE=ATR"_del1_"DONOR="_$p(EPVIS(46),$c(1),1)
 ...s xx2="clstkLTABRegistry"_del1_"Antigen Registry..."_del1_"MRN="_$p(EPVIS(20),$c(1))_del1_"TYPE=ATR"_del1_"DONOR="_$p(EPVIS(46),$c(1),1)
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" ATR"_del1_"5700"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color("fuchsia")_del1_del1_"6200"_del2_xx1_del2_xx2
 ..i $d(ANTRG) d
 ...s xx1="clstkLTABRegistry"_del1_"MRN="_$p(EPVIS(20),$c(1))_del1_"TYPE=AR"
 ...s xx2="clstkLTABRegistry"_del1_"Antibody Registry..."_del1_"MRN="_$p(EPVIS(20),$c(1))_del1_"TYPE=AR"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" AR"_del1_"6250"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color("fuchsia")_del1_del1_"6600"_del2_xx1_del2_xx2
 ..s dt=""
 ..i $l(EPVIS(61)) s dt=$p(EPVIS(61),$c(1),1)_","_$p(EPVIS(62),$c(1),1)
 ..i $l(dt) d
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Received"_del1_"6650"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$$extdate2^SSUTIL4($p(dt,",",1))_del1_"7600"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"8700"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$s(CFSM(8)=$p(dt,",",2):$p(dt,",",2),1:$$exttime^SSUTIL4($p(dt,",",2)))_del1_"8800"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"9400"
 . ;
 . ; line - 6
 . ;
 .i " ISR "'[(" "_mode_" ") d
 ..i " WEB LRI "'[(" "_mode_" ") d
 ...s xx1="" i $l($p(EPVIS(20),$c(1))),$l($e(ts)) s xx1="DEPHist"_del1_"DEP="_$e(ts)_del1_"MRN="_$p(EPVIS(20),$c(1))_del1_"NM="_epName_del1_"PW="_$p(DEB(5),$c(1))
 ...s xx2="" i $l($p(EPVIS(20),$c(1))),$l($e(ts)) s xx2="DEPHist"_del1_"Department History..."_del1_"DEP="_$e(ts)_del1_"MRN="_$p(EPVIS(20),$c(1))_del1_"NM="_epName_del1_"PW="_$p(DEB(5),$c(1))
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Dep.Hist."_del1_"50"_del1_(top+(270*5))_del1_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"850"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$e(DEBDH(3),1,200)_del1_"850"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"4000"_del1_del1_"Y"_del2_xx1_del2_xx2
 ...i $l($g(DEB(5))) d
 ....s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(DEB(5),$c(1),2)_del1_"4100"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200"_del1_del1_"Y"
 ..i " WEB LRI "[(" "_mode_" ") d
 ...s xx1="tkLTDocDetails"_del1_"DR="_$p(EPVIS(15),$c(1))
 ...s xx2="tkLTDocDetails"_del1_"Doctor Details..."_del1_"DR="_$p(EPVIS(15),$c(1))
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Doctor"_del1_"50"_del1_(top+(270*5))_del1_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"850"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" ["_$p(EPVIS(15),$c(1))_"] "_$p(EPVIS(15),$c(1),2)_" "_del1_"850"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_$s('$l($p(EPVIS(15),$c(1),3)):"6200",1:"")_del1_del1_del1_"6200"_del2_xx1_del2_xx2
 ...i $l($p(EPVIS(15),$c(1),3)) d
 ....s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=del1_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_del1_color("black")_del1_"phone.bmp"_del2_xx1_del2_xx2
 ....s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(EPVIS(15),$c(1),3)_del1_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200"_del2_xx1_del2_xx2
 ..i $d(DEBBT) d
 ...s xx1="clsPatientTags"_del1_"MRN="_$p(EPVIS(20),$c(1))
 ...s xx2="clsPatientTags"_del1_"BB Patient Tags..."_del1_"MRN="_$p(EPVIS(20),$c(1))
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" BT"_del1_"6275"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color("fuchsia")_del1_del1_"6600"_del2_xx1_del2_xx2
 ..i $l(EPVIS(98)) d
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Clin.Cond."_del1_"6650"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(EPVIS(98),$c(1),2)_del1_"7600"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"9400"
 . ;
 . ; line - 7
 . ;
 .i " ISR "'[(" "_mode_" ") d
 ..i " WEB LRI "'[(" "_mode_" ") d
 ...s xx1="tkLTDocDetails"_del1_"DR="_$p(EPVIS(15),$c(1))
 ...s xx2="tkLTDocDetails"_del1_"Doctor Details..."_del1_"DR="_$p(EPVIS(15),$c(1))
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Doctor"_del1_"50"_del1_(top+(270*6))_del1_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"850"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" ["_$p(EPVIS(15),$c(1))_"] "_$p(EPVIS(15),$c(1),2)_" "_del1_"850"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_$s('$l($p(EPVIS(15),$c(1),3)):"6200",1:"")_del1_del1_del1_"6200"_del2_xx1_del2_xx2
 ...i $l($p(EPVIS(15),$c(1),3)) d
 ....s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=del1_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_del1_color("black")_del1_"phone.bmp"_del2_xx1_del2_xx2
 ....s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(EPVIS(15),$c(1),3)_del1_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200"_del2_xx1_del2_xx2
 ..i " WEB LRI "[(" "_mode_" ") d
 ...i $$open^LVBVISTS(epis,,"Y",user)
 ...s list="" f  q:$$fetch^LVBVISTS(epis,,"Y",user)  d
 ....s xx1=PLIST(33),xx2=PLIST(3)
 ....i '$$selskip^LVBCTTS(xx2) s list=list_$s($l(list):", ",1:"")_$s(xx1="A":"[",1:"")_PLIST(4)_$s(xx1="A":"]",1:"")
 ...i $$close^LVBVISTS()
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Tests"_del1_"50"_del1_(top+(270*6))_del1_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"850"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_list_" "_del1_"850"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200"_del1_del1_"Y"
 ..s bg=""
 ..i '$l(bg),$l(DEB(9)) d
 ...s (bg,xx)=" "_$p(DEB(9),$c(1),2) i CFLAB(31)="Y",$$BloodGroup^LVBCTTS(ts)="Y" s xx="#################"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Blood Group"_del1_"6275"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=xx_del1_"7600"_del1_del1_del1_del1_"Y"_del1_del1_"N"_del1_color("black")_del1_color("yellow")_del1_del1_"9400"
 ..i '$l(bg),$l(DEB(16)) d
 ...s (bg,xx)=" "_$p(DEB(16),$c(1),2) i CFLAB(31)="Y",$$BloodGroup^LVBCTTS(ts)="Y" s xx="#################"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Blood Group"_del1_"6275"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=xx_del1_"7600"_del1_del1_del1_del1_"Y"_del1_del1_"N"_del1_color(9)_del1_color("red")_del1_del1_"9400"
 ..i '$l(bg),$l(DEB(15)) d
 ...s (bg,xx)=" "_$p(DEB(15),$c(1),2) i CFLAB(31)="Y",$$BloodGroup^LVBCTTS(ts)="Y" s xx="#################"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Blood Group"_del1_"6275"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=xx_del1_"7600"_del1_del1_del1_del1_"Y"_del1_del1_"N"_del1_color(9)_del1_color("white")_del1_del1_"9400"
 . ;
 . ; line - 8
 . ;
 .i " WRE IRE "[(" "_mode_" ") d
 ..i $$open^LVBVISTS(epis,,"Y",user)
 ..s list="" f  q:$$fetch^LVBVISTS(epis,,"Y",user)  d
 ...s xx1=PLIST(33),xx2=PLIST(3)
 ...i '$$selskip^LVBCTTS(xx2) s list=list_$s($l(list):", ",1:"")_$s(xx1="A":"[",1:"")_PLIST(4)_$s(xx1="A":"]",1:"")
 ..i $$close^LVBVISTS()
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Tests"_del1_"50"_del1_(top+(270*7))_del1_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"850"
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_list_" "_del1_"850"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"9400"_del1_del1_"Y"
 .
 .i " ISR "[(" "_mode_" ") d
 ..s xx1="tkLTDocDetails"_del1_"DR="_$p(EPVIS(15),$c(1))
 ..s xx2="tkLTDocDetails"_del1_"Doctor Details..."_del1_"DR="_$p(EPVIS(15),$c(1))
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Doctor"_del1_"50"_del1_(top+(270*4))_del1_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"850"
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" ["_$p(EPVIS(15),$c(1))_"] "_$p(EPVIS(15),$c(1),2)_" "_del1_"850"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_$s('$l($p(EPVIS(15),$c(1),3)):"6200",1:"")_del1_del1_del1_"6200"_del2_xx1_del2_xx2
 ..i $l($p(EPVIS(15),$c(1),3)) d
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=del1_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_del1_color("black")_del1_"phone.bmp"_del2_xx1_del2_xx2
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(EPVIS(15),$c(1),3)_del1_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200"_del2_xx1_del2_xx2
 ..s dt=""
 ..i $l(EPVIS(61)) s dt=$p(EPVIS(61),$c(1),1)_","_$p(EPVIS(62),$c(1),1)
 ..i $l(dt) d
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Received"_del1_"6650"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$$extdate2^SSUTIL4($p(dt,",",1))_del1_"7600"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"8700"
 ...s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$s(CFSM(8)=$p(dt,",",2):$p(dt,",",2),1:$$exttime^SSUTIL4($p(dt,",",2)))_del1_"8800"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"9400"
 i type="BBP" d
 . ;
 . ; line - 1
 . ;
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Unit ID"_del1_"50"_del1_(top)_del1_"Arial"_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"800"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(BBP(2),$c(1))_del1_"800"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color("yellow")_del1_del1_"2900"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Sec. ID"_del1_"3000"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"4250"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(BBP(3),$c(1))_del1_"3900"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color("yellow")_del1_del1_"6200"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Location"_del1_"6350"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(BBP(11),$c(1),2)_del1_"7600"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"9400"
 . ;
 . ; line - 2
 . ;
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Product"_del1_"50"_del1_(top+270)_del1_"Arial"_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"800"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(BBP(8),$c(1),2)_del1_"800"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color("cyan")_del1_del1_"2900"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Antigens"_del1_"3000"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"4250"
 .s xx="" i $d(BBPC) f j=1:1:BBPC s xx=xx_$s($l(xx):", ",1:"")_$p($p($p(BBPC(j),$c(2),4),$c(28),2),$c(1))_"("_$s($p($p(BBPC(j),$c(2),4),$c(28),3)="Y":"+",$p($p(BBPC(j),$c(2),4),$c(28),3)="N":"-",1:"NT")_")"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_xx_del1_"3900"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Status"_del1_"6350"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(BBP(17),$c(1),2)_del1_"7600"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"9400"
 . ;
 . ; line - 3
 . ;
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Blood Tags"_del1_"50"_del1_(top+(270*2))_del1_"Arial"_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"1550"
 .s xx="" i $d(BBPA) d
 ..i BBPA>1 f j=1:1:BBPA s xx=xx_$s($l(xx):", ",1:"")_$p(BBPA(j),$c(2),3)
 ..i BBPA=1 s xx=$p(BBPA(1),$c(2),2)
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_xx_del1_"1550"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Transaction"_del1_"6350"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(BBPT(3),$c(1),2)_del1_"7600"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"9400"
 . ;
 . ; line - 4
 . ;
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Pack Comments"_del1_"50"_del1_(top+(270*3))_del1_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"1550"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_BBP(20)_del1_"1550"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200"_del1_del1_"Y"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Collection"_del1_"6350"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$$extdate2^SSUTIL4($p(BBP(4),$c(1),1))_del1_"7600"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"8700"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$$exttime^SSUTIL4($p(BBP(27),$c(1),1))_del1_"8800"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"9400"
 . ;
 . ; line - 5
 . ;
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Trans Comments"_del1_"50"_del1_(top+(270*4))_del1_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"1550"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_BBPT(7)_del1_"1550"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200"_del1_del1_"Y"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Expiry"_del1_"6350"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$$extdate2^SSUTIL4($p(BBP(13),$c(1),1))_del1_"7600"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"8700"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$$exttime^SSUTIL4($p(BBP(38),$c(1),1))_del1_"8800"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"9400"
 . ;
 . ; line - 6
 . ;
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Patient Details"_del1_"50"_del1_(top+(270*5))_del1_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"1550"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_del1_"1550"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200"_del1_del1_"Y"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Volume"_del1_"6350"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(BBP(25),$c(1),1)_del1_"7600"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"9400"
 . ;
 . ; line - 7
 . ;
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Supplier"_del1_"50"_del1_(top+(270*6))_del1_del1_"10"_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"1550"
 .s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" ["_$p(BBP(5),$c(1))_"] "_$p(BBP(5),$c(1),2)_" "_del1_"1550"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_$s('$l($p(BBP(5),$c(1),8)):"6200",1:"")_del1_del1_del1_"6200"
 .i $l($p(BBP(5),$c(1),8)) d
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=del1_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_del1_color("black")_del1_"phone.bmp"
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=" "_$p(BBP(5),$c(1),8)_del1_"850"_del1_del1_del1_del1_"Y"_del1_"N"_del1_"N"_del1_color(9)_del1_color(2)_del1_del1_"6200"
 .s bg=""
 .i '$l(bg),$l(BBP(9)) d
 ..s (bg,xx)=" "_$p(BBP(9),$c(1),2) i CFLAB(31)="Y",$$BloodGroup^LVBCTTS(ts)="Y" s xx="#################"
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Blood Group"_del1_"6350"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=xx_del1_"7600"_del1_del1_del1_del1_"Y"_del1_del1_"N"_del1_color("black")_del1_color("yellow")_del1_del1_"9400"
 .i '$l(bg),$l(BBP(47)) d
 ..s (bg,xx)=" "_$p(BBP(47),$c(1),2) i CFLAB(31)="Y",$$BloodGroup^LVBCTTS(ts)="Y" s xx="#################"
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)="Blood Group"_del1_"6350"_del1_del1_del1_del1_"N"_del1_"N"_del1_"N"_del1_del1_color(4)_del1_del1_del1_del1_del1_"7600"
 ..s x=$o(^TMP($zn,$j,""),-1)+1,^TMP($zn,$j,x)=xx_del1_"7600"_del1_del1_del1_del1_"Y"_del1_del1_"N"_del1_color(9)_del1_color("white")_del1_del1_"9400"
panelContinue 
 i mode'="WEB" d
 .k PLIST s (sum,x)="" f j=1:1 s x=$o(^TMP($zn,$j,x)) q:x=""  q:(sum+$l(^(x)))>15000  s PLIST(j)=^(x),sum=sum+$l(^(x)) k ^TMP($zn,$j,x)
 .s PLIST=$o(PLIST(""),-1)
 i mode="WEB" m PLIST=^TMP($zn,$j) s PLIST=$o(PLIST(""),-1) k ^TMP($zn,$j) d panelHTML
 q $s($d(^TMP($zn,$j)):0,1:100)
 ; convert standard panel to HTML format
panelHTML k row,RESULT
 s (col,row)="" f j=5:1:PLIST s rx=$p(PLIST(j),del1,3),pos1=$p(PLIST(j),del1,2),pos2=$p(PLIST(j),del1,12) s:'pos2 pos2=$p(PLIST(j),del1,15) d
 .i rx d  q
 ..i $o(row(rx)) s:($o(row(rx))-rx>200) row=rx d  s row(row,col,j)=PLIST(j),row(row,col)=pos2 q
 ...i $l(pos1) s col=+pos1 q
 ...s col=+$o(row(row,""),-1)
 ..i $o(row(rx),-1) s:(rx-$o(row(rx),-1)>200) row=rx d  s row(row,col,j)=PLIST(j),row(row,col)=pos2 q
 ...i $l(pos1) s col=+pos1 q
 ...s col=+$o(row(row,""),-1)
 ..s row=rx d  s row(row,col,j)=PLIST(j),row(row,col)=pos2
 ...i $l(pos1) s col=+pos1 q
 ...s col=+$o(row(row,""),-1)
 .d  s row(row,col,j)=PLIST(j),row(row,col)=pos2
 ..i $l(pos1) s col=+pos1 q
 ..s col=+$o(row(row,""),-1)
 s tbl="" f  s tbl=$o(row(tbl)) q:tbl=""  d
 .s col="" f  s col=$o(row(tbl,col)) q:col=""  s xc=$o(row(tbl,col)) i xc s row(tbl,col)=xc
 s RESULT(0)="<table border='1px'><tr><td>"
 s tbl="" f cnt=1:1 s tbl=$o(row(tbl)) q:tbl=""  d
 .s RESULT(cnt)="<table border='1px' cellspacing='0px' width='940px'>"
 .s RESULT(cnt)=RESULT(cnt)_"<tr>"
 .s sum=0
 .s col="" f xx=0:1 s col=$o(row(tbl,col)) q:col=""  d
 ..s width=row(tbl,col)-col,sum=sum+(width\10)
 ..s fld="" f  s fld=$o(row(tbl,col,fld)) q:fld=""  s data=PLIST(fld),bg=$p(data,del1,9) i $l(bg) q
 ..s style=""
 ..i $l(bg) s x=$$color(bg),style=style_"background-color:"_x_";"
 ..s RESULT(cnt)=RESULT(cnt)_"<td width='"_($j(width/10,0,0)-xx)_"px' "_$s($l(style):"style='"_style_"'",1:"")_">"
 ..k style s fld="" f  s fld=$o(row(tbl,col,fld)) q:fld=""  d
 ...s data=PLIST(fld)
 ...s style=""
 ...s name=$p(data,del1,4) i '$l(name),$d(style("name")) s name=style("name")
 ...i $l(name) s style=style_"font-family:"_name_"; ",style("name")=name
 ...s size=$p(data,del1,5) i '$l(size),$d(style("size")) s size=style("size")
 ...i $l(size) s style=style_"font-size:"_size_"pt; ",style("size")=size
 ...s bold=$p(data,del1,6) i '$l(bold),$d(style("bold")) s bold=style("bold")
 ...i bold="Y" s style=style_"font-weight:bold; ",style("bold")=bold
 ...s italic=$p(data,del1,7) i '$l(italic),$d(style("italic")) s italic=style("italic")
 ...i italic="Y" s style=style_"font-style:italic; ",style("italic")=italic
 ...s underline=$p(data,del1,8) i '$l(underline),$d(style("underline")) s underline=style("underline")
 ...i underline="Y" s style=style_"text-decoration:underline; ",style("underline")=underline
 ...s blink=$p(data,del1,13) i blink="Y" s style=style_"text-decoration:blink; "
 ...s fg=$p(data,del1,10) i '$l(fg),$d(style("fg")) s underline=style("fg")
 ...i $l(fg) s x=$$color(fg),style=style_"color:"_x_";",style("fg")=x
 ...i $l(style) s RESULT(cnt)=RESULT(cnt)_"<span style='"_style_"'>"
 ...s text=$p(data,del1,1),RESULT(cnt)=RESULT(cnt)_" "_text
 ...i $l(style) s RESULT(cnt)=RESULT(cnt)_"</span>"
 ..s RESULT(cnt)=RESULT(cnt)_"</td>"
 .i sum<940 s RESULT(cnt)=RESULT(cnt)_"<td width='"_(940-sum)_"px'></td>"
 .s RESULT(cnt)=RESULT(cnt)_"</tr>"
 .s RESULT(cnt)=RESULT(cnt)_"</table>"
 s x=$o(RESULT(""),-1)+1
 s RESULT(x)="</td></tr></table>"
 s RESULT=$o(RESULT(""),-1)
 k PLIST f j=0:1:RESULT s PLIST(j+1)=RESULT(j)
 s PLIST=$o(PLIST(""),-1) k RESULT
 q
color(cl) s cl=$g(cl)
 i cl=-2147483645 s cl=4210752
 i cl=-2147483629 s cl=13160660
 i cl=-2147483633 s cl=13160660
 i cl=-2147483630 s cl=0
 i cl=-2147483643 s cl=16777215
 i cl=-2147483631 s cl=4210752
 i cl=-2147483635 s cl=6956042
 i cl=-2147483634 s cl=16777215
 i cl=-2147483646 s cl=6956042
 i cl=-2147483639 s cl=16777215
 q $$color^LVBCOM01(cl)
BBspecimen(ur) n (ur) s ur=$g(ur),result=""
 i $l(ur) d
 .s date="" f  s date=$o(^TDEBi(ur,"DATE",date),-1) q:date=""  d  q:$l(result)
 ..s time="" f  s time=$o(^TDEBi(ur,"DATE",date,time),-1) q:time=""  d  q:$l(result)
 ...s epis="" f  s epis=$o(^TDEBi(ur,"DATE",date,time,epis)) q:epis=""  d  q:$l(result)
 ....s ts="" f  s ts=$o(^TEPI(epis,1,ts)) q:ts=""  d
 .....s xm=$$seldata^LVBCTTS(ts,6) i $p(xm,$c(1))="Y" d
 ......i '$$select^LVBEPVIS(epis) m EPVIS=PLIST d
 .......s dt=$$fHoldDT^LVBCOM03(epis)
 .......s xx=((EPVIS(12)*24)+(EPVIS(13)/3600)+dt),xx1=xx\24,xx2=xx1#24*3600
 .......s result="Y"_$c(1)_xx1_","_xx2
 .......i dt,((EPVIS(12)*24)+(EPVIS(13)/3600)+dt)<(($h*24)+($p($h,",",2)/3600)) s result="N"
 q result
 ; check if previous result exists
check(epis,ts) n (epis,ts) s epis=$g(epis),ts=$g(ts),stop=100
 ; check episode
 s PLIST(12)=$$seldata^LVBEPVIS(epis,12)
 s PLIST(13)=$$seldata^LVBEPVIS(epis,13)
 s PLIST(20)=$$seldata^LVBEPVIS(epis,20)
 f j=20,12,13 i $d(PLIST(j)) s PLIST(j)=$p(PLIST(j),$c(1))
 s ur=PLIST(20),date=+PLIST(12),time=PLIST(13)
 i $l(ur),$l(date),$l(time) K ^TMP($zn,$j) i $l(ur) d
 .f  d:$l(date)  q:'stop  s date=$o(^TDEBi(ur,"DATE",date),-1) q:date=""
 ..f  d:$l(time)  q:'stop  s time=$o(^TDEBi(ur,"DATE",date,time),-1) q:time=""
 ...s ep="" f  s ep=$o(^TDEBi(ur,"DATE",date,time,ep)) q:ep=""  i ep'=epis d  q:'stop
 ....s cnt="" f  s cnt=$o(^TEPI(ep,1,ts,cnt)) q:cnt=""  s stop=0 q
 q stop
 ; cumulative result
cumdata(vtsROWID,include,max,type) n (vtsROWID,include,max,type)
 s vtsROWID=$g(vtsROWID),include=$g(include),max=$g(max),type=$g(type),stop=0
 s epis=$p(vtsROWID,"||",1),ts=$p(vtsROWID,"||",2)
 ; check TS workgroup
 s tsg=$$seldata^LVBCTTS(ts,46)
 s ^TMP($zn,$j,100,ts)=""
 s cum=$$seldata^MVBCFLAB(1,147),nti=$$seldata^MVBCFSM(1,8)
 i cum="TI",$l(tsg) s x="" f  s x=$o(^TTAB("GR",tsg,"TS",x)) q:x=""  s ^TMP($zn,$j,100,x)=""
 s x="" f  s x=$o(^TTAB("TS",ts,0,x)) q:x=""  s tc=$p(^(x),"\",8) i $l(tc) s ^TMP($zn,$j,101,tc)=""
 s ts="" f  s ts=$o(^TMP($zn,$j,100,ts)) q:ts=""  d
 .s (ok,x)="" f  s x=$o(^TTAB("TS",ts,0,x)) q:x=""  s tc=$p(^(x),"\",8) i $l(tc),$d(^TMP($zn,$j,101,tc)) s ok=1 q
 .i 'ok k ^TMP($zn,$j,100,ts)
 i include="Y" s tc="" f  s tc=$o(^TMP($zn,$j,101,tc)) q:tc=""  d
 .s xx=$$seldata^LVBCTTC(tc,5)
 .i '(($e(xx)="N")!($e(xx)="M")) k ^TMP($zn,$j,101,tc)
 i include="Y",$l(vtsROWID,"||")=4 s tc="" f  s tc=$o(^TMP($zn,$j,101,tc)) q:tc=""  i tc'=$p(vtsROWID,"||",4) k ^TMP($zn,$j,101,tc)
 ; sort episodes
 k ^TMP($zn,$j,"sort")
 s ur=$$seldata^LVBEPVIS(epis,20)
 i $l(ur) s dt="" f  s dt=$o(^TDEBi(ur,"DATE",dt)) q:dt=""  d
 .s tm="" f  s tm=$o(^TDEBi(ur,"DATE",dt,tm)) q:tm=""  d
 ..s ep="" f  s ep=$o(^TDEBi(ur,"DATE",dt,tm,ep)) q:ep=""  d
 ...f j=13,62 s PLIST(j)=$$seldata^LVBEPVIS(ep,j) i PLIST(j) s PLIST(j)=PLIST(j)\60
 ...s time=$s($l(PLIST(13))&(PLIST(13)'=nti):PLIST(13),$l(PLIST(62))&(PLIST(62)'=nti):PLIST(62),1:"") i '$l(time) s time=" "
 ...s ^TMP($zn,$j,"sort",dt,time,ep)=""
 ; check episode
 f j=12,13 s PLIST(j)=$$seldata^LVBEPVIS(epis,j)
 s (DATE,date)=+PLIST(12),time=PLIST(13) i time s time=time\60
 i $l(ur),$l(type),type'="Y" d  s time=""
 .i $p(type,$c(1),2)="N" s step=1
 .i $p(type,$c(1),2)="P" s step=-1
 .s vtsROWID=""
 .f  s (DATE,date)=$o(^TMP($zn,$j,"sort",date),step) q:date=""  d  q:$l(vtsROWID)
 ..s time="" f  s time=$o(^TMP($zn,$j,"sort",date,time),-1) q:time=""  d  q:$l(vtsROWID)
 ...s ep="" f  s ep=$o(^TMP($zn,$j,"sort",date,time,ep)) q:ep=""  d  q:$l(vtsROWID)
 ....s ts="" f  s ts=$o(^TMP($zn,$j,100,ts)) q:ts=""  d  q:$l(vtsROWID)
 .....s cnt="" f  s cnt=$o(^TEPI(ep,1,ts,cnt)) q:cnt=""  d  q:$l(vtsROWID)
 ......s tc="" f  s tc=$o(^TEPI(ep,1,ts,cnt,"DATA",tc)) q:tc=""  d  q:$l(vtsROWID)
 .......i $d(^TMP($zn,$j,101,tc)) s vtsROWID=ep_"||"_ts_"||"_cnt_"||"_tc
 i $l(type) s time="",type="Y"
 s epis=$p(vtsROWID,"||")
 s cum=$$seldata^MVBCFLAB(1,147)
 i $l(ur),$l(date),('max)!(max&(stop<max)) d
 .f  d:$l(date)  q:max&(stop=max)  s date=$o(^TMP($zn,$j,"sort",date),-1) q:date=""  q:date<(DATE-365)  q:(type="Y")&(date'=DATE)
 ..f  d:$l(time)  q:max&(stop=max)  s time=$o(^TMP($zn,$j,"sort",date,time),-1) q:time=""
 ...s ep="" f  s ep=$o(^TMP($zn,$j,"sort",date,time,ep)) q:ep=""  d  q:max&(stop=max)
 ....s tm=$$seldata^LVBEPVIS(ep,13) i tm s tm=tm\60
 ....i cum'="TI" s ts="" f  s ts=$o(^TMP($zn,$j,100,ts)) q:ts=""  d  q:max&(stop=max)
 .....s cnt="" f  s cnt=$o(^TEPI(ep,1,ts,cnt)) q:cnt=""  d  q:max&(stop=max)
 ......i include'="Y",ep=$p(vtsROWID,"||",1),ts=$p(vtsROWID,"||",2),cnt=$p(vtsROWID,"||",3) q
 ......s tc="" f  s tc=$o(^TEPI(ep,1,ts,cnt,"DATA",tc)) q:tc=""  i $d(^TMP($zn,$j,101,tc)) d
 .......s res=$p($g(^TEPI(ep,1,ts,cnt,"DATA",tc)),"\") q:'$l(res)
 .......i '$d(^TMP($zn,$j,2,ep_"||"_ts_"||"_cnt)) d  q
 ........s (found,x)="" f  s x=$o(^TMP($zn,$j,0,x)) q:x=""  d  q:found
 .........s xx=^(x)
 .........i $p(xx,$c(1),1)'=ep q
 .........i $p(xx,$c(1),2)'=date q
 .........i $p(xx,$c(1),3)'=time q
 .........i $g(^TMP($zn,$j,0,x,tc))'=res q
 .........s found=x
 ........i 'found d
 .........s stop=stop+1
 .........s ^TMP($zn,$j,0,stop)=ep_$c(1)_date_$c(1)_tm_$c(1)_ep_"||"_ts_"||"_cnt
 .........s ^TMP($zn,$j,0,stop,tc)=res
 .........s ^TMP($zn,$j,2,ep_"||"_ts_"||"_cnt)=stop
 .......s stop=^TMP($zn,$j,2,ep_"||"_ts_"||"_cnt),^TMP($zn,$j,0,stop,tc)=res
 ....i cum="TI" s ts="" f  s ts=$o(^TEPI(ep,1,ts)) q:ts=""  d  q:max&(stop=max)
 .....s cnt="" f  s cnt=$o(^TEPI(ep,1,ts,cnt)) q:cnt=""  d  q:max&(stop=max)
 ......i include'="Y",ep=$p(vtsROWID,"||",1),ts=$p(vtsROWID,"||",2),cnt=$p(vtsROWID,"||",3) q
 ......s tc="" f  s tc=$o(^TEPI(ep,1,ts,cnt,"DATA",tc)) q:tc=""  i $d(^TMP($zn,$j,101,tc)) d
 .......s res=$p($g(^TEPI(ep,1,ts,cnt,"DATA",tc)),"\",1) q:'$l(res)
 .......i '$d(^TMP($zn,$j,2,ep_"||"_ts_"||"_cnt)) d  q
 ........s (found,x)="" f  s x=$o(^TMP($zn,$j,0,x)) q:x=""  d  q:found
 .........s xx=^(x)
 .........i $p(xx,$c(1),1)'=ep q
 .........i $p(xx,$c(1),2)'=date q
 .........i $p(xx,$c(1),3)'=time q
 .........i $g(^TMP($zn,$j,0,x,tc))'=res q
 .........s found=x
 ........i 'found d
 .........s stop=stop+1
 .........s ^TMP($zn,$j,0,stop)=ep_$c(1)_date_$c(1)_tm_$c(1)_ep_"||"_ts_"||"_cnt
 .........s ^TMP($zn,$j,0,stop,tc)=res
 .........s ^TMP($zn,$j,2,ep_"||"_ts_"||"_cnt)=stop
 .......s stop=^TMP($zn,$j,2,ep_"||"_ts_"||"_cnt),^TMP($zn,$j,0,stop,tc)=res
 q 0
 ; cumulative result
 ; type :                - 365 days back
 ;        Y              - one day only
 ;        date_$c(1)_N   - next day
 ;        date_$c(1)_P   - previous day
cumres(vtsROWID,include,type,Continue) n (vtsROWID,include,type,Continue,PLIST)
 s vtsROWID=$g(vtsROWID),include=$g(include),type=$g(type),Continue=$g(Continue),width=12
 s (flaglow,flaghigh)="*" i '$$select^MVBCFLAB(1) d
 .i $l(PLIST(18)) s flaglow=PLIST(18)
 .i $l(PLIST(19)) s flaghigh=PLIST(19)
 i '$l(Continue) d
 .k CFSM i '$$select^MVBCFSM(1) m CFSM=PLIST
 .i include'="Y" s max=6 i '$$select^MVBCFLAB(1),$l(PLIST(14)) s max=PLIST(14)
 .i include="Y" s max=""
 .
 .k ^TMP($zn,$j) i $$cumdata(vtsROWID,include,max,type)
 . 
 .i include'="Y" d
 ..s max=$o(^TMP($zn,$j,0,""),-1)+1
 ..s space=$j("",max*width) f stop=1:1 q:'$d(^TMP($zn,$j,0,stop))  d
 ...s ep=$p(^(stop),$c(1),1),date=$p(^(stop),$c(1),2),time=$s(CFSM(8)=$p(^(stop),$c(1),3):$p(^(stop),$c(1),3),1:$p(^(stop),$c(1),3)*60),vts=$p(^(stop),$c(1),4)
 ...s ^TMP($zn,$j,1,"H1")=$e($G(^TMP($zn,$j,1,"H1"))_ep_space,1,stop*width)
 ...s ^TMP($zn,$j,1,"H2")=$e($G(^TMP($zn,$j,1,"H2"))_$$extdate2^SSUTIL4(date)_space,1,stop*width)
 ...s ^TMP($zn,$j,1,"H3")=$e($G(^TMP($zn,$j,1,"H3"))_$s(CFSM(8)=time:time,1:$$exttime^SSUTIL4(time))_space,1,stop*width)
 ...s tc="" f  s tc=$o(^TMP($zn,$j,0,stop,tc)) q:tc=""  s res=^(tc) d
 ....s flag="",x=$p($$validres^LVBVIS1(ep,tc,res,vts),$c(1),1),flag=$s(x="H":flaghigh,x="L":flaglow,1:"")
 ....s ^TMP($zn,$j,1,tc)=$e($G(^TMP($zn,$j,1,tc))_space,1,stop-1*width)
 ....s rf=$$seldata^LVBCTTC(tc,5)
 ....i rf="T" s res=$$exttime^SSUTIL4(res)
 ....i rf="D" s res=$$extdate2^SSUTIL4(res)
 ....s ^TMP($zn,$j,1,tc)=$e($G(^TMP($zn,$j,1,tc))_res_" "_flag_space,1,stop*width)
 .
 .i include="Y" d
 ..s max=$o(^TMP($zn,$j,0,""),-1)+1
 ..k ^TMP($zn,$j,3)
 ..f stop=1:1 q:'$d(^TMP($zn,$j,0,stop))  m ^TMP($zn,$j,3,max-stop)=^TMP($zn,$j,0,stop)
 ..k ^TMP($zn,$j,0) m ^TMP($zn,$j,0)=^TMP($zn,$j,3) k ^TMP($zn,$j,3)
 ..f stop=1:1 q:'$d(^TMP($zn,$j,0,stop))  s tc="" f  s tc=$o(^TMP($zn,$j,0,stop,tc)) q:tc=""  i ^(tc)=+^(tc) s ^TMP($zn,$j,3,tc,stop)=""
 ..s tc="" f  s tc=$o(^TMP($zn,$j,3,tc)) q:tc=""  d
 ...s (result,rrl,rrh,lr,hr,stop)="" f ok=0:1 s stop=$o(^TMP($zn,$j,3,tc,stop)) q:stop=""  d
 ....s res=^TMP($zn,$j,0,stop,tc),(vts,date,time,comm)=""
 ....i $d(^TMP($zn,$j,0,stop))#10 s vts=$p(^(stop),$c(1),4),date=$p(^(stop),$c(1),2),time=$p(^(stop),$c(1),3)*60,epis=$p(^(stop),$c(1),1),comm=$p(^(stop),$c(1),5)
 ....i $l(result)<15000 s result=result_$s($l(result):$c(28),1:"")_vts_"||"_tc_$c(1)_res_$c(1)_date_$c(1)_time_$c(1)_comm
 ....s:lr="" lr=res s:lr>res lr=res
 ....s:hr="" hr=res s:hr<res hr=res
 ....i 'ok d
 .....f j=5,12,13,20,22,26,60,63,64,98,167 s PLIST(j)=$$seldata^LVBEPVIS(epis,j)
 .....s ur=PLIST(20),ColDate=PLIST(12),ColTime=PLIST(13),spec=PLIST(5),loc=PLIST(22),age=PLIST(26),pregn=PLIST(63),weeks=PLIST(64),cond=PLIST(98),ethnicity=PLIST(60),altitude=PLIST(167)
 .....  ;---&sql(SELECT EPVIS_HospitalCode_DR->CTHOS_LocationType INTO :inpat FROM EP_VisitNumber WHERE EPVIS_RowID=:epis)
  .....  ;--- ** SQL PUBLIC Variables: SQLCODE, epis, inpat
 ..... Do %0Ao
 .....s inpat=$p(inpat,$c(1))
 .....i SQLCODE q
 ..... ; get authorised date
 .....i $l(vts) s date=$$seldata^LVBVISTS(vts,7)
 ..... ; type      - common/outpatient
 ..... ;      -IN  - inpatient
 .....s type=0_$s(inpat="Y":"-IN",1:"")
 ..... ; check ranges by type,age,sex
 .....s x=$$ranges^LVBVIS1(tc,age,spec,pregn,type,date,cond,loc,,weeks_$c(1)_ethnicity_$c(1)_altitude)
 .....s rrl=$p(x,$c(1),1),rrh=$p(x,$c(1),2)
 ...i '$$selskip^LVBCTTC(tc) d
 ....i $e(rrl)="<" s rrh=$e(rrl,2,999),rrl=""
 ....i $e(rrl)=">" s rrl=$e(rrl,2,999),rrh=""
 ....i $l(rrl),lr>rrl s lr=rrl
 ....i $l(rrh),hr<rrh s hr=rrh
 ....i $l(lr) s lr=lr-(lr*.1) i lr<0 s lr=0
 ....i $l(hr) s hr=hr+(hr*.1)
 ....i $l(rrh),'$l(rrl) s rrl=lr
 ....i $l(rrl),'$l(rrh) s rrh=hr
 ....s cnt=$o(^TMP($zn,$j,1,""),-1)+1
 ....s ^TMP($zn,$j,1,cnt)=tc_$c(1)_PLIST(3)_$c(1)_rrl_$c(1)_rrh_$c(1)_lr_$c(1)_hr_$c(2)_result
 k PLIST
 s (sum,tc)="" f cnt=1:1 s tc=$o(^TMP($zn,$j,1,tc)) q:tc=""  q:sum&((sum+$l(tc_$c(1)_^(tc)))>15000)  s PLIST(cnt)=tc_$c(1)_^(tc),sum=sum+$l(PLIST(cnt))+1 k ^TMP($zn,$j,1,tc)
 S PLIST=$o(PLIST(""),-1)
 q $s(PLIST:0,1:100)
 ; return last reminder printed
reminder(epis,pc,batch,seq) n (epis,pc,batch,seq)
 s epis=$g(epis),pc=$g(pc),batch=$g(batch),seq=$g(seq),result=""
 i '$l(epis),$l(pc),$l(batch) d
 .s epis="" f  s epis=$o(^TMCB(pc,batch,epis)) q:epis=""  q:'$l(seq)  q:seq=$p(^(epis),"\",2)
 i $l(epis) d
 .s result=$$seldata^LVBEPVIS(epis,59)
 .i $e(result,1,2)="R-" s result=$p($p(result,$c(1)),"R-",2)
 .e  i $l(result) s result=3
 q result
%0Ao n %mmmsqlc,%mmmsqld,%mmmsqlE,%mmmsqll,%mmmsqln,%mmmsqlp,%mmmsqlR,%mmmsqls,%mmmsqlt,%mmmsqlZ s $zt="%0Aerr" s %mmmsqld(8)=0,%mmmsqld(9)="",%mmmsqld(10)=0,%mmmsqld(11)=""
 s %mmmsqld(6)=$g(epis)
 s SQLCODE=100
 ; asl MOD# 2
 s %mmmsqld(5)=%mmmsqld(6)
 i %mmmsqld(5)'="",$d(^TEPI(%mmmsqld(5)))
 e  g %0ABdun
 s %mmmsqld(14)=$g(^TEPI(%mmmsqld(5)))
 s %mmmsqld(1)=$p(%mmmsqld(14),"\",20)
 g:$zu(115,2)=0 %0ABuncommitted i $zu(115,2)=1 l +^TEPI($p(%mmmsqld(5),"||",1))#"S":$zu(115,4) i $t { s %mmmsqld(8)=1,%mmmsqld(9)=$name(^TEPI($p(%mmmsqld(5),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.EP_VisitNumber for RowID value: "_%mmmsqld(5) ztrap "LOCK"  }
 ; asl MOD# 3
 i %mmmsqld(5)'="",$d(^TEPI(%mmmsqld(5)))
 e  g %0ACdun
 s %mmmsqld(17)=$g(^TEPI(%mmmsqld(5)))
 s %mmmsqld(1)=$p(%mmmsqld(17),"\",20)
%0ABuncommitted ;
 s %mmmsqld(2)=%mmmsqld(1)
 i %mmmsqld(2)'="",$d(^TTAB("RH",%mmmsqld(2)))
 e  s inpat="",%mmmsqld(2)="" g %0ACp4
 s %mmmsqld(22)=$g(^TTAB("RH",%mmmsqld(2)))
 s inpat=$p(%mmmsqld(22),"\",16)
%0ACp4 
 g:$zu(115,2)=0 %0ACuncommitted i $zu(115,2)=1 l +^TTAB("RH",$p(%mmmsqld(2),"||",1))#"S":$zu(115,4) i $t { s %mmmsqld(10)=1,%mmmsqld(11)=$name(^TTAB("RH",$p(%mmmsqld(2),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.CT_Hospital for RowID value: "_%mmmsqld(2) ztrap "LOCK"  }
 ; asl MOD# 4
 i %mmmsqld(2)'="",$d(^TTAB("RH",%mmmsqld(2)))
 e  s inpat="",%mmmsqld(2)="" g %0ADp1
 s %mmmsqld(27)=$g(^TTAB("RH",%mmmsqld(2)))
 s inpat=$p(%mmmsqld(27),"\",16)
%0ADp1 
%0ACuncommitted ;
 s SQLCODE=0 g %0Ac
%0ADdun i $zu(115,2)=1,$g(%mmmsqld(10))=1 { l -@%mmmsqld(11) s %mmmsqld(10)=0 }
%0ACdun i $zu(115,2)=1,$g(%mmmsqld(8))=1 { l -@%mmmsqld(9) s %mmmsqld(8)=0 }
%0ABdun 
%0AAdun 
%0Ac s %ROWCOUNT='SQLCODE i $zu(115,2)=1,$g(%mmmsqld(8))=1 { l -@%mmmsqld(9) } i $zu(115,2)=1,$g(%mmmsqld(10))=1 { l -@%mmmsqld(11) } q
%0Aerr s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) g %0Ac
]]></Routine>
</Export>
