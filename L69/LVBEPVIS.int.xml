<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="24">
<Routine name="LVBEPVIS" type="INT" languagemode="0" generated="1"><![CDATA[
LVBEPVIS ; IG 6/5/98 ; MVB Control data access for EP_VisitNumber
 ;
 ; supported calls:
 ;
 ; $$status^LVBEPVIS(episode)
 ; $$bbp^LVBEPVIS(episode,bbp)
 ; $$TestSets^LVBEPVIS(episode,user)
 ; $$updateTS^LVBEPVIS(episode)
 ; $$select^LVBEPVIS(RowID,skip,user,type,specimen)
 ; $$seldata^LVBEPVIS(ROWID,data)
 ; $$delete^LVBEPVIS(RowID)
 ; $$insert^LVBEPVIS()
 ; $$update^LVBEPVIS(RowID,app,group)
 ; $$save^LVBEPVIS(RowID,app,group)
 ; $$new^LVBEPVIS(pref)
 ; $$checknum^LVBEPVIS(num)
 ; $$invoice^LVBEPVIS(RowID)
 ; $$check^LVBEPVIS(site,epis)
 ; $$medicare^LVBEPVIS(pc,deb,data)
 ; $$ValUser^LVBEPVIS(user,epis) 
 ; $$mrn^LVBEPVIS(epis) 
 ; $$DonorCheck^LVBEPVIS(donorID) 
 ; $$DonorNew^LVBEPVIS() 
 ; $$JobNew^LVBEPVIS() 
 ; $$clCond^LVBEPVIS(epis,clCond,preg,ldmp,weeks,dc) 
 ; $$mark^LVBEPVIS(epis,mrn)
 ;
clCond(epis,clCond,preg,ldmp,weeks,dc) n (epis,clCond,preg,ldmp,weeks,dc)
 s epis=$g(epis),clCond=$g(clCond),preg=$g(preg),ldmp=$g(ldmp),weeks=$g(weeks),dc=$g(dc)
  ;---&sql(UPDATE EP_VisitNumber SET EPVIS_ClinicalConditions_DR = :clCond,
   ;---         EPVIS_Pregnant = :preg,
   ;---         EPVIS_DateOfLMP = :ldmp,
   ;---         EPVIS_PregnantNumberOfWeeks = :weeks,
   ;---         EPVIS_DayOfCycle = :dc
   ;---         WHERE EPVIS_RowID = :epis)
   ;--- ** SQL PUBLIC Variables: SQLCODE, clCond, dc, epis, ldmp, preg, weeks
 Do %0Ao
 q SQLCODE
bbp(epis,bbp) s epis=$g(epis),bbp=$g(bbp) n (epis,bbp)
  ;---&sql(UPDATE EP_VisitNumber SET EPVIS_Donor_BBP_DR = :bbp WHERE EPVIS_RowID = :epis)
   ;--- ** SQL PUBLIC Variables: SQLCODE, bbp, epis
 Do %0Co
 s donor=$$seldata(epis,46) i $l(donor) d
 .  ;---&sql(UPDATE BBP_PackDetails SET BBP_Donor_ID = :donor WHERE BBP_RowID = :bbp)
  .  ;--- ** SQL PUBLIC Variables: SQLCODE, bbp, donor
 . Do %0Eo
 q SQLCODE_$s('SQLCODE:"",SQLCODE'=100:" "_$G(%msg)_" "_$g(%mdiag(1)),1:"")
status(epis) s epis=$g(epis)
 q $$seldata(epis,29)
invoice(RowID) s RowID=$g(RowID) n (RowID) s result=$$seldata(RowID,57)
 i $l(result) s rowid=result_"||"_RowID s sequence=$$seldata^LVBINVBP(result_"||"_RowID,4),result=result_"||"_$p(sequence,$c(1))
 q result
updateTS(episode) n (episode)
 i $$open^LVBVISTS(episode,,"Y")
 f  q:$$fetch^LVBVISTS(episode,,"Y")  d
 .f j=1:1:PLIST s PLIST(j)=$p(PLIST(j),$c(1))
 .i $$update^LVBVISTS(PLIST(1))
 i $$close^LVBVISTS()
 q 0
TestSets(episode,user) n (episode,user) s result=""
 i $$open^LVBVISTS(episode,,,user)
 f  q:$$fetch^LVBVISTS(episode,,,user)  d
 .s result=result_$s($l(result):" ",1:"")_$p(PLIST(3),$c(1),2)
 i $$close^LVBVISTS()
 q result
 ; type : 9 - Blood Bank Packs
select(RowID,skip,user,type,specimen) s RowID=$p($g(RowID),$c(1)),skip=$g(skip),user=$g(user),type=$g(type),specimen=$g(specimen) k PLIST
 i $l($p($g(^CF("SM",1)),"^",28)),$l($t(@("select^"_$zn_$p(^CF("SM",1),"^",28)))) k %quit d @("select^"_$zn_$p(^CF("SM",1),"^",28)) q:$d(%quit) %quit  
 i specimen="Y",$l(RowID) d  i $d(PLIST) q 300
 .i $d(^TEPI(RowID)) q
 .i $d(^TEPIi("Specimen-TS",RowID)) d
 ..s x="" f  s x=$o(^TEPIi("Specimen-TS",RowID,x)) q:x=""  s PLIST=$o(PLIST(""),-1)+1,PLIST(PLIST)=x
 .i $d(^TEPIi("Specimen-SP",RowID)) d
 ..s x="" f  s x=$o(^TEPIi("Specimen-SP",RowID,x)) q:x=""  s PLIST=$o(PLIST(""),-1)+1,PLIST(PLIST)=x
 .i $d(PLIST(1)),'$d(PLIST(2)) s RowID=PLIST(1) k PLIST
 i $l(RowID),'$d(^TEPI(RowID)),$d(^TIND(13,RowID)) s RowID=$o(^TIND(13,RowID,""))
  ;---&sql(SELECT * INTO :PLIST() FROM EP_VisitNumber WHERE EPVIS_RowID=:RowID)
   ;--- ** SQL PUBLIC Variables: PLIST, RowID, SQLCODE
 Do %0Go
 s PLIST=$o(PLIST(""),-1)
 i 'SQLCODE d  i 'SQLCODE s SQLCODE=$$ValUser(user,$p(PLIST(1),$c(1))) i SQLCODE<100 d adjust
 .i '$l(type),$p(PLIST(86),$c(1))=9 s SQLCODE=100
 q SQLCODE
 ; select data by code and field No
seldata(ROWID,data) n (ROWID,data) s ROWID=$g(ROWID),data=$g(data),result=""
 i $l(ROWID) d  q result
 .i data=1 s:$d(^TEPI(ROWID)) result=ROWID q
 .i data=3 s result=$p($g(^TEPI(ROWID)),"\",1) q
 .i data=4 s result=$p($g(^TEPI(ROWID)),"\",2) q
 .i data=5 s result=$p($g(^TEPI(ROWID)),"\",3) q
 .i data=6 s result=$p($g(^TEPI(ROWID)),"\",4) q
 .i data=7 s result=$p($g(^TEPI(ROWID)),"\",5) q
 .i data=8 s result=$p($g(^TEPI(ROWID)),"\",6) q
 .i data=9 s result=$p($g(^TEPI(ROWID)),"\",7) q
 .i data=10 s result=$p($g(^TEPI(ROWID)),"\",8) q
 .i data=11 s result=$tr($p($g(^TEPI(ROWID)),"\",9)," ") s:$g(result) result=result*60 q
 .i data=12 s result=$p($g(^TEPI(ROWID)),"\",10) q
 .i data=13 s result=$tr($p($g(^TEPI(ROWID)),"\",11)," ") s:$g(result) result=result*60 q
 .i data=14 s result=$p($g(^TEPI(ROWID)),"\",12) q
 .i data=15 s result=$p($g(^TEPI(ROWID)),"\",13) q
 .i data=17 s result=$p($g(^TEPI(ROWID)),"\",15) q
 .i data=18 s result=$p($g(^TEPI(ROWID)),"\",16) q
 .i data=19 s result=$p($g(^TEPI(ROWID)),"\",17) q
 .i data=20 s result=$p($g(^TEPI(ROWID)),"\",18) q
 .i data=21 s result=$p($g(^TEPI(ROWID)),"\",19) q
 .i data=22 s result=$p($g(^TEPI(ROWID)),"\",20) q
 .i data=25 s result=$p($g(^TEPI(ROWID)),"\",24) q
 .i data=26 s result=$p($g(^TEPI(ROWID)),"\",25) q
 .i data=27 s result=$p($g(^TEPI(ROWID)),"\",26) q
 .i data=29 s result=$p($g(^TEPI(ROWID)),"\",28) q
 .i data=31 s result=$p($g(^TEPI(ROWID)),"\",30) q
 .i data=32 s result=$p($g(^TEPI(ROWID,0)),"\",1) q
 .i data=33 s result=$p($g(^TEPI(ROWID,0)),"\",2) q
 .i data=34 s result=$p($g(^TEPI(ROWID,0)),"\",3) q
 .i data=35 s result=$p($g(^TEPI(ROWID,0)),"\",4) q
 .i data=36 s result=$p($g(^TEPI(ROWID,0)),"\",5) q
 .i data=43 s result=$p($g(^TEPI(ROWID,0)),"\",12) q
 .i data=44 s result=$p($g(^TEPI(ROWID,0)),"\",13) q
 .i data=46 s result=$p($g(^TEPI(ROWID,0)),"\",18) q
 .i data=50 s result=$p($g(^TEPI(ROWID,0)),"\",32) q
 .i data=51 s result=$p($g(^TEPI(ROWID,0)),"\",33) q
 .i data=53 m result=^TEPI(ROWID,3) d  q
 ..s xdt="" f j=1:1:$g(result(0)) s $p(xdt,"|",j)=result(j)
 ..s result=$lfs(xdt,"|")
 ..s xx=$$remarks^LVBCOM01("IE",.result,11)
 .i data=54 s result=$p($g(^TEPI(ROWID,7)),"\",1) q
 .i data=55 s result=$p($g(^TEPI(ROWID,7)),"\",2) q
 .i data=56 s result=$p($g(^TEPI(ROWID,7)),"\",3) q
 .i data=57 s result=$p($g(^TEPI(ROWID,7)),"\",4) q
 .i data=58 s result=$p($g(^TEPI(ROWID,7)),"\",5) q
 .i data=59 s result=$p($g(^TEPI(ROWID,7)),"\",6) q
 .i data=60 s result=$p($g(^TEPI(ROWID)),"\",31) q
 .i data=61 s result=$p($g(^TEPI(ROWID)),"\",32) q
 .i data=62 s result=$tr($p($g(^TEPI(ROWID)),"\",33)," ") s:$g(result) result=result*60 q
 .i data=63 s result=$p($g(^TEPI(ROWID)),"\",34) q
 .i data=64 s result=$p($g(^TEPI(ROWID)),"\",35) q
 .i data=65 s result=$p($g(^TEPI(ROWID)),"\",37) q
 .i data=66 s result=$p($g(^TEPI(ROWID)),"\",36) q
 .i data=67 s result=$p($g(^TEPI(ROWID)),"\",38) q
 .i data=74 s result=$p($g(^TEPI(ROWID)),"\",22) q
 .i data=84 s result=$p($g(^TEPI(ROWID,0)),"\",31) q
 .i data=86 s result=$p($g(^TEPI(ROWID)),"\",44) q
 .i data=87 s result=$p($g(^TEPI(ROWID,7)),"\",7) q
 .i data=88 s result=$p($g(^TEPI(ROWID)),"\",45) q
 .i data=89 s result=$p($g(^TEPI(ROWID)),"\",46) q
 .i data=93 s result=$p($g(^TEPI(ROWID)),"\",48) q
 .i data=94 s result=$p($g(^TEPI(ROWID)),"\",49) q
 .i data=96 s result=$p($g(^TEPI(ROWID,0)),"\",15) q
 .i data=98 s result=$p($g(^TEPI(ROWID,0)),"\",17) q
 .i data=99 s result=$p($g(^TEPI(ROWID,0)),"\",23) q
 .i data=100 s result=$p($g(^TEPI(ROWID,0)),"\",24) q
 .i data=101 s result=$p($g(^TEPI(ROWID,0)),"\",25) q
 .i data=108 s result=$p($g(^TEPI(ROWID,0)),"\",22) q
 .i data=117 s result=$p($g(^TEPI(ROWID,8)),"\",16) q
 .i data=119 m result=^TEPI(ROWID,"SN") d  q
 ..s xdt="" f j=1:1:$g(result(0)) s $p(xdt,"|",j)=result(j)
 ..s result=$lfs(xdt,"|")
 ..s xx=$$remarks^LVBCOM01("IE",.result,11)
 .i data=121 s result=$p($g(^TEPI(ROWID)),"\",53) q
 .i data=122 s result=$p($g(^TEPI(ROWID)),"\",52) q
 .i data=125 s result=$p($g(^TEPI(ROWID)),"\",55) q
 .i data=161 s result=$p($g(^TEPI(ROWID)),"\",61) q
 .i data=165 s result=$p($g(^TEPI(ROWID)),"\",64) q
 .i data=166 s result=$p($g(^TEPI(ROWID)),"\",65) q
 .i data=167 s result=$p($g(^TEPI(ROWID)),"\",66) q
 .i '$$select(ROWID,"Y") s result=$g(PLIST(data))
 q result
mrn(epis) n (epis) q $$seldata(epis,20)
 ; Delete the data only pre-entry
delete(RowID) s RowID=$g(RowID)
 f j=20,12 s VISIT(j)=$$seldata(RowID,j)
  ;---&SQL(DELETE FROM EP_VisitNumber WHERE EPVIS_RowID=:RowID AND ((%INTERNAL(EPVIS_StatusPatient) NOT= '0') OR (EPVIS_StatusPatient IS NULL)))
   ;--- ** SQL PUBLIC Variables: RowID, SQLCODE
 Do %0Io
 i 'SQLCODE,$l(VISIT(20)),$l(VISIT(12)),$$delete^LVBDEBVI(VISIT(20)_"||"_VISIT(12)_"||"_RowID)
 i '$d(^TMOVE("TEMP","42D",RowID)) d SetAll^LVBCOM50(RowID,"42D")
 Q SQLCODE
 ; Delete the data only pre-entry
xdel(RowID) s RowID=$g(RowID)
  ;---&SQL(DELETE FROM EP_VisitNumber WHERE EPVIS_RowID=:RowID)
   ;--- ** SQL PUBLIC Variables: RowID, SQLCODE
 Do %0Ko
 i '$d(^TMOVE("TEMP","42XD",RowID)) d SetAll^LVBCOM50(RowID,"42XD")
 Q SQLCODE
 ;
insert() 
 i $l($p($g(^CF("SM",1)),"^",28)),$l($t(@("insert^"_$zn_$p(^CF("SM",1),"^",28)))) k %quit d @("insert^"_$zn_$p(^CF("SM",1),"^",28)) q:$d(%quit) %quit  
 d pre("N") k PLIST(1)
 i PLIST(2)="." q 100
 i PLIST(2)="JOB_" s PLIST(2)="JOB_"_$$JobNew(),new=1
  ;---&sql(INSERT INTO EP_VisitNumber VALUES :PLIST())
   ;--- ** SQL PUBLIC Variables: PLIST, SQLCODE
 Do %0Mo
 i 'SQLCODE d  q $$select(%ROWID)_$c(1)_"Insert"
 .n %ROWID
 . ; check delete from Hospital DB parameter
 .f j=1,2 s @("x"_j)=$p($g(PLIST(65)),",",j)
 .i $l(x1),$l(x2) d
 ..s delete=$$seldata^MVBCFLAB(1,64)
 ..i delete="Y" f jj1=1:1:$l(x2) i '$$delete^LVBHOSP($e(x2,1,jj1)_"||"_x2_"||"_x1) q
 q SQLCODE_$s('SQLCODE:"",SQLCODE'=100:" "_$g(%msg)_" "_$g(%mdiag(1)),1:"")
 ;
update(RowID,app,group) s RowID=$g(RowID),app=$g(app),group=$g(group) d pre("Y") 
 s ^TMP("FUNCTION",$j)=app_$c(1)_group
  ;---&sql(UPDATE EP_VisitNumber VALUES :PLIST() WHERE EPVIS_RowID=:RowID)
   ;--- ** SQL PUBLIC Variables: PLIST, RowID, SQLCODE
 Do %0Oo
 k ^TMP("FUNCTION",$j)
 I 'SQLCODE d post^LVBDEBVI(,%ROWID)
 q SQLCODE_$s('SQLCODE:"",SQLCODE'=100:" "_$G(%msg)_" "_$g(%mdiag(1)),1:"")
 ; PLIST - 1.Episode
 ;         2.MRN
 ;         3.Visit for Collector Entry
 ;         4.Donor ID
save(RowID,app,group,DateTimeList) s RowID=$g(RowID),app=$g(app),group=$g(group),DateTimeList=$g(DateTimeList),display="" k ^TMP("SaveEPVIS",$j)
 s x="" f  s x=$o(PLIST(x)) q:x=""  s PLIST(x)=$p(PLIST(x),$c(1))
 s l=$i(^TMPlog("log")) m ^TMPlog("log",l)=PLIST
 s ^TMPlog("log",l)=$h_" : "_$j_" : $$save^"_$zn_" : "_$g(RowID)_"^"_$g(app)_"^"_$g(group)
 ; get client specific init parameters
 s cc=$p($g(^CF("SM",1)),"^",28) i $l(cc) s LineRoutine="save^"_$zn_cc i $l($t(@LineRoutine)) x "d "_LineRoutine
 f j=30,45 i ($g(PLIST(j))="{New}")!($g(PLIST(j))="*EMPTY*") s PLIST(j)=""
 i $l(RowID) d
 . ;
 . ; calculate Donor Id
 . ;
 .s donor=$g(PLIST(46)) i donor="{New}" d  s PLIST(46)=donor
 ..n PLIST
 ..i '$$DonorNew() s donor=PLIST(1)
 ..s $p(display,$c(1),4)=donor
 . ;
 . ; calculate Debtor
 . ;
 .i '$l(PLIST(20)),PLIST(86)=0 s PLIST(20)="{New}"
 .s deb=$g(PLIST(20)) i deb["{New}" s new=1 d  s PLIST(20)=deb
 ..n PLIST
 ..i '$$new^LVBDEB($p(deb,"{New}")) s deb=PLIST(1)
 .i $l(deb),'$d(^TDEB(deb)) d
 ..k ^TMP($zn,$j) m ^TMP($zn,$j)=PLIST k PLIST
 ..s PLIST(2)=deb,PLIST=$o(PLIST(""),-1) i $$insert^LVBDEB()
 ..k PLIST m PLIST=^TMP($zn,$j) k ^TMP($zn,$j)
 ; calculate BBP user site
 i $e(RowID,1,4)="BBP_" d
 .s rowid=$p(RowID,"_",2)_"||"_$p(RowID,"_",3)
 .  ;---&SQL(SELECT BBP_do_Location_DR->BBL_UserSite_DR INTO :site FROM BBP_PackDetails WHERE BBP_RowID=:rowid)
  .  ;--- ** SQL PUBLIC Variables: SQLCODE, rowid, site
 . Do %0Qo
 .i 'SQLCODE s PLIST(66)=$p(site,$c(1))
 s SQLCODE=100
 i $l(RowID) d
 .s $p(display,$c(1),2)=$p(PLIST(20),$c(1))
 .i $d(^TEPI(RowID)) s SQLCODE=$$update(RowID,app,group) i 'SQLCODE f j=1,3 s $p(display,$c(1),j)=%ROWID
 .i '$d(^TEPI(RowID)) s SQLCODE=$$insert() i 'SQLCODE f j=1,3 s $p(display,$c(1),j)=%ROWID
 .s MainEpis=PLIST(2)
 .i $l(DateTimeList) s JobList="" d
 ..f xx=1:1:$l(DateTimeList,"\") d
 ...s PLIST(12)=$p($p(DateTimeList,"\",xx),",",1)
 ...s PLIST(13)=$p($p(DateTimeList,"\",xx),",",2)
 ...s PLIST(2)="JOB_"_$$JobNew()
 ...i '$$insert() s JobList=JobList_$s($l(JobList):",",1:"")_PLIST(2)
 ..i $l(JobList) s ^TMP("SaveEPVIS",$j,MainEpis)=JobList
 k PLIST
 f j=1:1:4 s PLIST(j)=$p(display,$c(1),j)
 s PLIST=$o(PLIST(""),-1)
 q SQLCODE
 ; Adjust certain fields
adjust N plist,I,J,SQLCODE,X d PostSQL^SSUTIL4("52,53,119")
 i $g(PLIST(13))=" " s PLIST(13)=""
 f j=11,13,62 i $g(PLIST(j)) s PLIST(j)=PLIST(j)*60
 I $G(PLIST(7))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTTL(plist(7),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(7)=X K plist
 i $g(skip)="Y" q
 I $g(PLIST(5))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTSP(plist(5),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$c(1)_PLIST(3)_$c(1)_PLIST(4)
 .K PLIST M PLIST=plist S PLIST(5)=X K plist
 I $g(PLIST(9))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTPC(plist(9),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(9)=X K plist
 I $g(PLIST(15))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTDR(plist(15),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_$$NameFormat^LVBCOM03("DR",PLIST(26),PLIST(4),PLIST(3),PLIST(49),PLIST(50),PLIST(51))_$C(1)_PLIST(5)_$C(1)_PLIST(18)
 .K PLIST M PLIST=plist S PLIST(15)=X K plist
 I $g(PLIST(17))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTPR(plist(17),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)_$C(1)_PLIST(4)
 .K PLIST M PLIST=plist S PLIST(17)=X K plist
 I $g(PLIST(18))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTIC(plist(18),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(18)=X K plist
 I $g(PLIST(19))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTFAS(plist(19),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(19)=X K plist
 I $g(PLIST(20))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBDEB(plist(20))
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(8)_$C(1)_$P(PLIST(9),$C(1),2)
 .K PLIST M PLIST=plist S PLIST(20)=X K plist
 f I=22,123 I $g(PLIST(I))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTHOS(plist(I),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)_$C(1)_PLIST(38)
 .K PLIST M PLIST=plist S PLIST(I)=X K plist
 I $g(PLIST(25))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTVA(plist(25),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(25)=X K plist
 I $g(PLIST(27))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTCC(plist(27),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(27)=X K plist
 I $g(PLIST(28))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTPER(plist(28),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(28)=X K plist
 I $g(PLIST(31))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$selrow^MVBSSUSR(plist(31),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(31)=X K plist
 I $g(PLIST(51))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTSI(plist(51),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(51)=X K plist
 I $g(PLIST(66))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTUSL(plist(66),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(66)=X K plist
 I $g(PLIST(69))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBBBBG(plist(69),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(69)=X K plist
 I $g(PLIST(74))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTBL(plist(74),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(74)=X K plist
 I $g(PLIST(94))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTPA(plist(94),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(94)=X K plist
 I $g(PLIST(98))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTCLC(plist(98),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(98)=X K plist
 I $g(PLIST(125))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTRT(plist(125),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(125)=X K plist
 I $g(PLIST(128))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTAB(plist(128),"Y")
 .S X="" I 'SQLCODE S X=PLIST(2)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(128)=X K plist
 I $G(PLIST(161))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^MVBSSLAN(plist(161),"Y")
 .S X="" I 'SQLCODE S X=PLIST(1)_$C(1)_PLIST(15)
 .K PLIST M PLIST=plist S PLIST(161)=X K plist
 I $G(PLIST(164))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTCN(plist(164),"Y")
 .S X="" I 'SQLCODE S X=PLIST(1)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(164)=X K plist
 I $G(PLIST(167))'="" D
 .K plist M plist=PLIST K PLIST
 .S SQLCODE=$$select^LVBCTALT(plist(167),"Y")
 .S X="" I 'SQLCODE S X=PLIST(1)_$C(1)_PLIST(3)
 .K PLIST M PLIST=plist S PLIST(167)=X K plist
 q
pre(xUpdate) d PreSQL^SSUTIL4("52,53,119","11")
 k PLIST(1)
 ; set Date/Time of Entry to Full Entry Date/Time
 i $l($g(PLIST(2))) d
 .i '$d(^TEPI(PLIST(2))) s PLIST(10)=+$h,PLIST(11)=$p($h,",",2)
 .e  i $p(^TEPI(PLIST(2)),"\",44)>0 s PLIST(10)=+$h,PLIST(11)=$p($h,",",2)
 f j=121,122 i $l($g(PLIST(j))) s PLIST(j)=$$UPPER^SSUTIL4(PLIST(j))
 f j=126,127 i $l($g(PLIST(j))) s PLIST(j)=$$ALPHAUP^SSUTIL4(PLIST(j))
 i $g(PLIST(123))="" s PLIST(123)=$g(PLIST(22))
 f j=11,13,62 i $g(PLIST(j)) s PLIST(j)=PLIST(j)\60
 i $l($g(PLIST(26))) s PLIST(26)=+PLIST(26)
 f j=52,53,119 s PLIST(j)=$tr($g(PLIST(j)),"^")
 ; If DateReceive,TimeReceived exist set Patient to PreEntry (at least)
 i $l($g(PLIST(61)))," 1 0 9 "'[(" "_$g(PLIST(86))_" ") s PLIST(86)=1
 i '$l($g(PLIST(12))),$g(PLIST(86))="0" s PLIST(12)=+$h
 i '$l($g(PLIST(13))) s PLIST(13)=" "
 ; do not file "." in hospital episode/mrn
 i $p($g(PLIST(65)),",",1)="." s $p(PLIST(65),",",1)=""
 i $p($g(PLIST(65)),",",2)="." s $p(PLIST(65),",",2)=""
 ; create temporary old UserSite record
 i $l($g(PLIST(2))) k ^TMPepis(PLIST(2)) i $$seldata(PLIST(2),66)'=$g(PLIST(66)) s ^TMPepis(PLIST(2))=$$seldata(PLIST(2),66)
 q
 ;
 ; check visit number 0-valid,100-not
checknum(num) n (num) s num=$g(num) s result=0
 i $l(num) d
 .s pattern=$p($g(^CF("LAB",1)),"^",8)
 .i $l(pattern),@("num'?"_pattern) s result=100
 q result
 ; V-ToView
 ; R-ToRead
mark(epis,mrn) n (epis,mrn) s epis=$g(epis),mrn=$g(mrn),result=""
 i '$l(epis),$l(mrn) d
 .s date="" f  s date=$o(^TDEBi(mrn,"DATE",date)) q:date=""  d  i result["R",result["V" q
 ..s time="" f  s time=$o(^TDEBi(mrn,"DATE",date,time)) q:time=""  d  i result["R",result["V" q
 ...s epis="" f  s epis=$o(^TDEBi(mrn,"DATE",date,time,epis)) q:epis=""  d  i result["R",result["V" q
 ....s ts="" f  s ts=$o(^TEPI(epis,1,ts)) q:ts=""  d  i result["R",result["V" q
 .....s tscnt="" f  s tscnt=$o(^TEPI(epis,1,ts,tscnt)) q:tscnt=""  d  i result["R",result["V" q
 ......i result'["R",'$l($$seldata^LVBVISTS(epis_"||"_ts_"||"_tscnt,68)) s result=result_"R"
 ......i result'["V",'$l($$seldata^LVBVISTS(epis_"||"_ts_"||"_tscnt,71)) s result=result_"V"
 i $l(epis) d
 .s ts="" f  s ts=$o(^TEPI(epis,1,ts)) q:ts=""  d  i result["R",result["V" q
 ..s tscnt="" f  s tscnt=$o(^TEPI(epis,1,ts,tscnt)) q:tscnt=""  d  i result["R",result["V" q
 ...i result'["R",'$l($$seldata^LVBVISTS(epis_"||"_ts_"||"_tscnt,68)) s result=result_"R"
 ...i result'["V",'$l($$seldata^LVBVISTS(epis_"||"_ts_"||"_tscnt,71)) s result=result_"V"
 q result
 ; check episode number
 ; return code - 10 - exist in TEPI              - episode
 ;               40 - exist in TEPI-PreEntered   - episode
 ;               50 - does not exist but valid   - episode
 ;              100 - invalid episode
check(site,epis) n (site,epis,PLIST) s site=$g(site),epis=$g(epis),ok=0
 s %routine=$p($g(^TTAB("REPORT-GENERIC","EPIS")),"\",1) i $l(%routine) x "s ok=$$check^"_%routine_"("""_site_""","""_epis_""")"
 q ok
batch(old) n (old) s old=$g(old),ok=""
 s %routine=$p($g(^TTAB("REPORT-GENERIC","EPIS")),"\",1)
 i $l(%routine) s LineRoutine="batch^"_%routine i $l($t(@LineRoutine)) x "s ok=$$batch^"_%routine_"("""_old_""")"
 q ok
 ; check medicare/DVA/Pencioner number
medicare(pc,deb,data,type) n (pc,deb,data,type,PLIST) s pc=$g(pc),deb=$g(deb),data=$g(data),type=$g(type),ok=0
 s %routine=$p($g(^TTAB("REPORT-GENERIC","EPIS")),"\",1) i $l(%routine) x "s ok=$$medicare^"_%routine_"("""_pc_""","""_deb_""","""_data_""","""_type_""")"
 q ok
 ; get new JobID
JobNew() 
 ; get client specific init parameters
 s cc=$p($g(^CF("SM",1)),"^",28)
 i $l(cc) s LineRoutine="JobNew^"_$zn_cc i $l($t(@LineRoutine)) x "s result=$$"_LineRoutine_"()" q result
 f  s result=$$next("^CF(""JOB-CNT"")") q:'$l(result)  q:'$d(^TEPI("JOB_"_result))
 q result
 ; get new DonorID
DonorNew() k PLIST s PLIST=1
 ; get client specific init parameters
 s cc=$p($g(^CF("SM",1)),"^",28)
 i $l(cc) s LineRoutine="DonorNew^"_$zn_cc i $l($t(@LineRoutine)) x "s ok=$$"_LineRoutine_"()" q ok
 f  s PLIST(1)=$$next("^CF(""DONOR-CNT"")") q:'$l(PLIST(1))  q:'$d(^TDEBj("DONOR",PLIST(1)))
 q 0
 ; check existing DonorID
DonorCheck(donor) k PLIST
 s result=100
 i $l(donor) d
 .i donor="{New}" s result=0,PLIST(1)="New Donor" q
 .i $l(donor),$d(^TDEBj("DONOR",donor)) s result=0,PLIST(1)=$o(^TDEBj("DONOR",donor,"")) q
 s PLIST=$o(PLIST(""),-1)
 q result
new(pref) s pref=$g(pref)
  s %routine=$p($g(^TTAB("REPORT-GENERIC","EPIS")),"\",1)
  s LineRoutine="new^"_%routine i $l($t(@LineRoutine)) d  q 0
  .x "s ok=$$new^"_%routine_"("""_pref_""")"
nx  k PLIST s PLIST=1
  i '$l(pref) s PLIST(1)=$$next("^CF(""EPIS-CNT"")")
  i $l(pref) s PLIST(1)=pref_$$next("^CF(""EPIS-CNT"",pref)")
  ; check if number already exists
  i $l(PLIST(1)),$d(^TEPI(PLIST(1))) g nx
  q 0
next(glo) n a
 l +@glo
 s a=$g(@glo)+1,@glo=a
 l -@glo
 q a
 ; validate user
ValUser(user,epis,recLoc,enquiry) n (user,epis,recLoc,enquiry) s user=$g(user),epis=$g(epis),recLoc=$g(recLoc),enquiry=$g(enquiry),ok=0
 i $l(user) d
 .f j=15,20,22,27,66 s VISIT(j)=$$seldata(epis,j)
 . ; validate doctor
 .i 'ok s ok=$$ValUser^LVBCTDR(user,VISIT(15))
 . ; validate hospital
 .i 'ok s ok=$$ValUser^LVBCTHOS(user,VISIT(22))
 . ; validate copy-to
 .i ok d
 ..s x="" f  s x=$o(^TEPI(epis,5,x)) q:x=""  d  i 'ok q
 ...s doc=$$seldata^LVBVISTS(epis_"||"_x,3) i $l(doc) s ok=$$ValUser^LVBCTDR(user,doc)
 ...s hosp=$$seldata^LVBVISTS(epis_"||"_x,17) i $l(hosp) s ok=$$ValUser^LVBCTHOS(user,hosp)
 . ; validate LCC
 .i 'ok s ok=$$ValUser^LVBCTCC(user,VISIT(27))
 . ; validate URPrefix
 .i 'ok s prefix=$e(VISIT(20)) i $l($$seldata^LVBCTUR(prefix,1)) s ok=$$ValUser^LVBCTUR(user,prefix)
 . ; validate user site access
 .i 'ok,enquiry'="Y" s ok=$$ValUser^LVBCTUSL(user,$s($l(recLoc):recLoc,1:VISIT(66))) i ok d
 ..s ts="" f  s ts=$o(^TEPI(epis,1,ts)) q:ts=""  d  i 'ok q
 ...s tscnt="" f  s tscnt=$o(^TEPI(epis,1,ts,tscnt)) q:tscnt=""  d  i 'ok q
 .... ; check user site
 ....s TestLocation=$$seldata^LVBVISTS(epis_"||"_ts_"||"_tscnt,29),ok=$$ValUser^LVBCTUSL(user,TestLocation)
 . ; validate Department
 .i 'ok,enquiry'="Y" i $d(^TEPI(epis,1)) s ok=100 d
 ..s ts="" f  s ts=$o(^TEPI(epis,1,ts)) q:ts=""  d  i 'ok q
 ...s tscnt="" f  s tscnt=$o(^TEPI(epis,1,ts,tscnt)) q:tscnt=""  d  i 'ok q
 .... ; check department access
 ....s Department=$$seldata^LVBCTTS(ts,26),ok=$$ValUser^LVBCTDEP(user,Department)
 q ok
%0Ao n %mmmsqlc,%mmmsqld,%mmmsqlE,%mmmsqll,%mmmsqln,%mmmsqlp,%mmmsqlR,%mmmsqls,%mmmsqlt,%mmmsqlTS,%mmmsqlTS2,%mmmsqlZ s $zt="%0Aerr" s %mmmsqld(13)=0 s %mmmsqld(14)=""
 s %mmmsqld(2)=$g(clCond),%mmmsqld(4)=$g(preg),%mmmsqld(6)=$g(ldmp),%mmmsqld(8)=$g(weeks),%mmmsqld(10)=$g(dc),%mmmsqld(12)=$g(epis)
 n %data
 s SQLCODE=100
 k:'$TLEVEL %0CacheLock If $zu(115,1)=2,'$TLEVEL { s %mmmsqlTS2=1 TSTART } If $zu(115,1) { s %mmmsqlTS=1 TSTART  }
 ; asl MOD# 2
 s %mmmsqld(11)=%mmmsqld(12)
 i %mmmsqld(11)'="",$d(^TEPI(%mmmsqld(11)))
 e  g %0ABdun
 s %mmmsqld(17)=$$%getlock^User.EPVisitNumber.T1(%mmmsqld(11)) i '%mmmsqld(17) s SQLCODE=-110 g %0Ac
 ; asl MOD# 3
 i %mmmsqld(11)'="",$d(^TEPI(%mmmsqld(11)))
 e  g %0ACdun
 k %data
 s %data(98)=$g(%mmmsqld(2)),%data(63)=$g(%mmmsqld(4)),%data(129)=$g(%mmmsqld(6)),%data(64)=$g(%mmmsqld(8)),%data(130)=$g(%mmmsqld(10))
 d %update^User.EPVisitNumber.T1(%mmmsqld(11),$c(0,2,0,0),.%data,,'$g(%mmmsqlTS))
 i 'SQLCODE i $i(%mmmsqld(13))'<$g(%0CacheRowLimit,9223372036854775807) d:%mmmsqld(17)=1 %ReleaseLock^User.EPVisitNumber.T1(%mmmsqld(11)) g %0Ac
%0ACdun 
 d:%mmmsqld(17)=1 %ReleaseLock^User.EPVisitNumber.T1(%mmmsqld(11)) g:SQLCODE<0 %0Ac
%0ABdun 
%0AAdun 
%0Ac s %ROWCOUNT=$s($g(SQLCODE)'<0:+$g(%mmmsqld(13)),1:0)
 If $zu(115,1),$g(%mmmsqlTS) { TCOMMIT:SQLCODE'<0  TROLLBACK:SQLCODE<0 1 } TCOMMIT:SQLCODE=100&&(%ROWCOUNT=0)&&($g(%mmmsqlTS2))&&($zu(115,1)=2)  q
%0Aerr s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) d:$g(%mmmsqld(17))=1 %ReleaseLock^User.EPVisitNumber.T1(%mmmsqld(11)) g %0Ac
%0Co n %mmmsqlc,%mmmsqld,%mmmsqlE,%mmmsqll,%mmmsqln,%mmmsqlp,%mmmsqlR,%mmmsqls,%mmmsqlt,%mmmsqlTS,%mmmsqlTS2,%mmmsqlZ s $zt="%0Cerr" s %mmmsqld(5)=0 s %mmmsqld(6)=""
 s %mmmsqld(2)=$g(bbp),%mmmsqld(4)=$g(epis)
 n %data
 s SQLCODE=100
 k:'$TLEVEL %0CacheLock If $zu(115,1)=2,'$TLEVEL { s %mmmsqlTS2=1 TSTART } If $zu(115,1) { s %mmmsqlTS=1 TSTART  }
 ; asl MOD# 2
 s %mmmsqld(3)=%mmmsqld(4)
 i %mmmsqld(3)'="",$d(^TEPI(%mmmsqld(3)))
 e  g %0CBdun
 s %mmmsqld(9)=$$%getlock^User.EPVisitNumber.T1(%mmmsqld(3)) i '%mmmsqld(9) s SQLCODE=-110 g %0Cc
 ; asl MOD# 3
 i %mmmsqld(3)'="",$d(^TEPI(%mmmsqld(3)))
 e  g %0CCdun
 k %data
 s %data(96)=$g(%mmmsqld(2))
 d %update^User.EPVisitNumber.T1(%mmmsqld(3),$c(0,2,0,0),.%data,,'$g(%mmmsqlTS))
 i 'SQLCODE i $i(%mmmsqld(5))'<$g(%0CacheRowLimit,9223372036854775807) d:%mmmsqld(9)=1 %ReleaseLock^User.EPVisitNumber.T1(%mmmsqld(3)) g %0Cc
%0CCdun 
 d:%mmmsqld(9)=1 %ReleaseLock^User.EPVisitNumber.T1(%mmmsqld(3)) g:SQLCODE<0 %0Cc
%0CBdun 
%0CAdun 
%0Cc s %ROWCOUNT=$s($g(SQLCODE)'<0:+$g(%mmmsqld(5)),1:0)
 If $zu(115,1),$g(%mmmsqlTS) { TCOMMIT:SQLCODE'<0  TROLLBACK:SQLCODE<0 1 } TCOMMIT:SQLCODE=100&&(%ROWCOUNT=0)&&($g(%mmmsqlTS2))&&($zu(115,1)=2)  q
%0Cerr s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) d:$g(%mmmsqld(9))=1 %ReleaseLock^User.EPVisitNumber.T1(%mmmsqld(3)) g %0Cc
%0Eo n %mmmsqlc,%mmmsqld,%mmmsqlE,%mmmsqll,%mmmsqln,%mmmsqlp,%mmmsqlR,%mmmsqls,%mmmsqlt,%mmmsqlTS,%mmmsqlTS2,%mmmsqlZ s $zt="%0Eerr" s %mmmsqld(7)=0 s %mmmsqld(8)=""
 s %mmmsqld(2)=$g(donor),%mmmsqld(4)=$g(bbp)
 n %data
 s SQLCODE=100
 k:'$TLEVEL %0CacheLock If $zu(115,1)=2,'$TLEVEL { s %mmmsqlTS2=1 TSTART } If $zu(115,1) { s %mmmsqlTS=1 TSTART  }
 ; asl MOD# 2
 s %mmmsqld(3)=%mmmsqld(4)
 s %mmmsqld(5)=$p(%mmmsqld(3),"||"),%mmmsqld(6)=$p(%mmmsqld(3),"||",2)
 i %mmmsqld(5)'="",%mmmsqld(6)'="",$d(^TBBP(%mmmsqld(5),%mmmsqld(6)))
 e  g %0EBdun
 s %mmmsqld(12)=$$%getlock^User.BBPPackDetails.T1(%mmmsqld(3)) i '%mmmsqld(12) s SQLCODE=-110 g %0Ec
 ; asl MOD# 3
 s %mmmsqld(5)=$p(%mmmsqld(3),"||"),%mmmsqld(6)=$p(%mmmsqld(3),"||",2)
 i %mmmsqld(5)'="",%mmmsqld(6)'="",$d(^TBBP(%mmmsqld(5),%mmmsqld(6)))
 e  g %0ECdun
 k %data
 s %data(44)=$g(%mmmsqld(2))
 d %update^User.BBPPackDetails.T1(%mmmsqld(3),$c(0,2,0,0),.%data,,'$g(%mmmsqlTS))
 i 'SQLCODE i $i(%mmmsqld(7))'<$g(%0CacheRowLimit,9223372036854775807) d:%mmmsqld(12)=1 %ReleaseLock^User.BBPPackDetails.T1(%mmmsqld(3)) g %0Ec
%0ECdun 
 d:%mmmsqld(12)=1 %ReleaseLock^User.BBPPackDetails.T1(%mmmsqld(3)) g:SQLCODE<0 %0Ec
%0EBdun 
%0EAdun 
%0Ec s %ROWCOUNT=$s($g(SQLCODE)'<0:+$g(%mmmsqld(7)),1:0)
 If $zu(115,1),$g(%mmmsqlTS) { TCOMMIT:SQLCODE'<0  TROLLBACK:SQLCODE<0 1 } TCOMMIT:SQLCODE=100&&(%ROWCOUNT=0)&&($g(%mmmsqlTS2))&&($zu(115,1)=2)  q
%0Eerr s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) d:$g(%mmmsqld(12))=1 %ReleaseLock^User.BBPPackDetails.T1(%mmmsqld(3)) g %0Ec
%0Go n %mmmsqlc,%mmmsqld,%mmmsqlE,%mmmsqll,%mmmsqln,%mmmsqlp,%mmmsqlR,%mmmsqls,%mmmsqlt,%mmmsqlZ s $zt="%0Gerr" s %mmmsqld(170)=0,%mmmsqld(171)=""
 s %mmmsqld(168)=$g(RowID)
 s SQLCODE=100
 ; asl MOD# 2
 s PLIST(2)=%mmmsqld(168)
 i PLIST(2)'="",$d(^TEPI(PLIST(2)))
 e  g %0GBdun
 s %mmmsqld(174)=$g(^TEPI(PLIST(2),0))
 s PLIST(32)=$p(%mmmsqld(174),"\",1) s PLIST(33)=$p(%mmmsqld(174),"\",2) s PLIST(34)=$p(%mmmsqld(174),"\",3) s PLIST(35)=$p(%mmmsqld(174),"\",4) s PLIST(36)=$p(%mmmsqld(174),"\",5) s PLIST(37)=$p(%mmmsqld(174),"\",6) s PLIST(38)=$p(%mmmsqld(174),"\",7) s PLIST(39)=$p(%mmmsqld(174),"\",8) s PLIST(40)=$p(%mmmsqld(174),"\",9) s PLIST(41)=$p(%mmmsqld(174),"\",10) s PLIST(42)=$p(%mmmsqld(174),"\",11) s PLIST(43)=$p(%mmmsqld(174),"\",12) s PLIST(44)=$p(%mmmsqld(174),"\",13) s PLIST(46)=$p(%mmmsqld(174),"\",18) s PLIST(47)=$p(%mmmsqld(174),"\",30) s PLIST(50)=$p(%mmmsqld(174),"\",32) s PLIST(51)=$p(%mmmsqld(174),"\",33) s PLIST(84)=$p(%mmmsqld(174),"\",31) s PLIST(95)=$p(%mmmsqld(174),"\",14) s PLIST(96)=$p(%mmmsqld(174),"\",15) s PLIST(97)=$p(%mmmsqld(174),"\",16) s PLIST(98)=$p(%mmmsqld(174),"\",17) s PLIST(99)=$p(%mmmsqld(174),"\",23) s PLIST(100)=$p(%mmmsqld(174),"\",24) s PLIST(101)=$p(%mmmsqld(174),"\",25) s PLIST(105)=$p(%mmmsqld(174),"\",19) s PLIST(106)=$p(%mmmsqld(174),"\",20) s PLIST(107)=$p(%mmmsqld(174),"\",21) s PLIST(108)=$p(%mmmsqld(174),"\",22) s PLIST(109)=$p(%mmmsqld(174),"\",26) s PLIST(110)=$p(%mmmsqld(174),"\",27) s PLIST(112)=$p(%mmmsqld(174),"\",28) s PLIST(113)=$p(%mmmsqld(174),"\",29) s PLIST(124)=$p(%mmmsqld(174),"\",34)
 s %mmmsqld(174)=$g(^TEPI(PLIST(2),7))
 s PLIST(54)=$p(%mmmsqld(174),"\",1) s PLIST(55)=$p(%mmmsqld(174),"\",2) s PLIST(56)=$p(%mmmsqld(174),"\",3) s PLIST(57)=$p(%mmmsqld(174),"\",4) s PLIST(58)=$p(%mmmsqld(174),"\",5) s PLIST(59)=$p(%mmmsqld(174),"\",6) s PLIST(87)=$p(%mmmsqld(174),"\",7) s PLIST(162)=$p(%mmmsqld(174),"\",8)
 s %mmmsqld(174)=$g(^TEPI(PLIST(2),8))
 s PLIST(30)=$p(%mmmsqld(174),"\",11) s PLIST(45)=$p(%mmmsqld(174),"\",12) s PLIST(48)=$p(%mmmsqld(174),"\",1) s PLIST(49)=$p(%mmmsqld(174),"\",2) s PLIST(76)=$p(%mmmsqld(174),"\",3) s PLIST(77)=$p(%mmmsqld(174),"\",4) s PLIST(78)=$p(%mmmsqld(174),"\",5) s PLIST(79)=$p(%mmmsqld(174),"\",6) s PLIST(80)=$p(%mmmsqld(174),"\",7) s PLIST(81)=$p(%mmmsqld(174),"\",8) s PLIST(82)=$p(%mmmsqld(174),"\",9) s PLIST(83)=$p(%mmmsqld(174),"\",10) s PLIST(114)=$p(%mmmsqld(174),"\",13) s PLIST(115)=$p(%mmmsqld(174),"\",14) s PLIST(116)=$p(%mmmsqld(174),"\",15) s PLIST(117)=$p(%mmmsqld(174),"\",16) s PLIST(118)=$p(%mmmsqld(174),"\",17)
 s %mmmsqld(174)=$g(^TEPI(PLIST(2)))
 s PLIST(3)=$p(%mmmsqld(174),"\",1) s PLIST(4)=$p(%mmmsqld(174),"\",2) s PLIST(5)=$p(%mmmsqld(174),"\",3) s PLIST(6)=$p(%mmmsqld(174),"\",4) s PLIST(7)=$p(%mmmsqld(174),"\",5) s PLIST(8)=$p(%mmmsqld(174),"\",6) s PLIST(9)=$p(%mmmsqld(174),"\",7) s PLIST(10)=$p(%mmmsqld(174),"\",8) s PLIST(11)=$p(%mmmsqld(174),"\",9) s PLIST(12)=$p(%mmmsqld(174),"\",10) s PLIST(13)=$p(%mmmsqld(174),"\",11) s PLIST(14)=$p(%mmmsqld(174),"\",12) s PLIST(15)=$p(%mmmsqld(174),"\",13) s PLIST(16)=$p(%mmmsqld(174),"\",14) s PLIST(17)=$p(%mmmsqld(174),"\",15) s PLIST(18)=$p(%mmmsqld(174),"\",16) s PLIST(19)=$p(%mmmsqld(174),"\",17) s PLIST(20)=$p(%mmmsqld(174),"\",18) s PLIST(21)=$p(%mmmsqld(174),"\",19) s PLIST(22)=$p(%mmmsqld(174),"\",20) s PLIST(23)=$p(%mmmsqld(174),"\",21) s PLIST(24)=$p(%mmmsqld(174),"\",23) s PLIST(25)=$p(%mmmsqld(174),"\",24) s PLIST(26)=$p(%mmmsqld(174),"\",25) s PLIST(27)=$p(%mmmsqld(174),"\",26) s PLIST(28)=$p(%mmmsqld(174),"\",27) s PLIST(29)=$p(%mmmsqld(174),"\",28) s PLIST(31)=$p(%mmmsqld(174),"\",30) s PLIST(60)=$p(%mmmsqld(174),"\",31) s PLIST(61)=$p(%mmmsqld(174),"\",32) s PLIST(62)=$p(%mmmsqld(174),"\",33) s PLIST(63)=$p(%mmmsqld(174),"\",34) s PLIST(64)=$p(%mmmsqld(174),"\",35) s PLIST(65)=$p(%mmmsqld(174),"\",37) s PLIST(66)=$p(%mmmsqld(174),"\",36) s PLIST(67)=$p(%mmmsqld(174),"\",38) s PLIST(70)=$p(%mmmsqld(174),"\",39) s PLIST(71)=$p(%mmmsqld(174),"\",40) s PLIST(72)=$p(%mmmsqld(174),"\",41) s PLIST(73)=$p(%mmmsqld(174),"\",42) s PLIST(74)=$p(%mmmsqld(174),"\",22) s PLIST(75)=$p(%mmmsqld(174),"\",43) s PLIST(85)=$p(%mmmsqld(174),"\",29) s PLIST(86)=$p(%mmmsqld(174),"\",44) s PLIST(88)=$p(%mmmsqld(174),"\",45) s PLIST(89)=$p(%mmmsqld(174),"\",46) s PLIST(92)=$p(%mmmsqld(174),"\",47) s PLIST(93)=$p(%mmmsqld(174),"\",48) s PLIST(94)=$p(%mmmsqld(174),"\",49) s PLIST(111)=$p(%mmmsqld(174),"\",50) s PLIST(120)=$p(%mmmsqld(174),"\",51) s PLIST(121)=$p(%mmmsqld(174),"\",53) s PLIST(122)=$p(%mmmsqld(174),"\",52) s PLIST(123)=$p(%mmmsqld(174),"\",54) s PLIST(125)=$p(%mmmsqld(174),"\",55) s PLIST(126)=$p(%mmmsqld(174),"\",56) s PLIST(127)=$p(%mmmsqld(174),"\",57) s PLIST(128)=$p(%mmmsqld(174),"\",58) s PLIST(129)=$p(%mmmsqld(174),"\",59) s PLIST(130)=$p(%mmmsqld(174),"\",60) s PLIST(161)=$p(%mmmsqld(174),"\",61) s PLIST(163)=$p(%mmmsqld(174),"\",62) s PLIST(164)=$p(%mmmsqld(174),"\",63) s PLIST(165)=$p(%mmmsqld(174),"\",64) s PLIST(166)=$p(%mmmsqld(174),"\",65) s PLIST(167)=$p(%mmmsqld(174),"\",66)
 s PLIST(119)="" f %irep=1:1:$g(^TEPI(PLIST(2),"SN",0)) s $li(PLIST(119),%irep)=$g(^(%irep))
 s %mmmsqld(174)=$g(^TEPI(PLIST(2),"pc"))
 s PLIST(131)=$p(%mmmsqld(174),"\",1) s PLIST(132)=$p(%mmmsqld(174),"\",2) s PLIST(133)=$p(%mmmsqld(174),"\",3) s PLIST(134)=$p(%mmmsqld(174),"\",4) s PLIST(135)=$p(%mmmsqld(174),"\",5) s PLIST(136)=$p(%mmmsqld(174),"\",6) s PLIST(137)=$p(%mmmsqld(174),"\",7) s PLIST(138)=$p(%mmmsqld(174),"\",8) s PLIST(139)=$p(%mmmsqld(174),"\",9) s PLIST(140)=$p(%mmmsqld(174),"\",10) s PLIST(141)=$p(%mmmsqld(174),"\",11) s PLIST(142)=$p(%mmmsqld(174),"\",12) s PLIST(143)=$p(%mmmsqld(174),"\",13) s PLIST(144)=$p(%mmmsqld(174),"\",14) s PLIST(145)=$p(%mmmsqld(174),"\",15) s PLIST(146)=$p(%mmmsqld(174),"\",16) s PLIST(147)=$p(%mmmsqld(174),"\",17) s PLIST(148)=$p(%mmmsqld(174),"\",18) s PLIST(149)=$p(%mmmsqld(174),"\",19) s PLIST(150)=$p(%mmmsqld(174),"\",20) s PLIST(151)=$p(%mmmsqld(174),"\",21) s PLIST(152)=$p(%mmmsqld(174),"\",22) s PLIST(153)=$p(%mmmsqld(174),"\",23) s PLIST(154)=$p(%mmmsqld(174),"\",24) s PLIST(155)=$p(%mmmsqld(174),"\",25) s PLIST(156)=$p(%mmmsqld(174),"\",26) s PLIST(157)=$p(%mmmsqld(174),"\",27) s PLIST(158)=$p(%mmmsqld(174),"\",28) s PLIST(159)=$p(%mmmsqld(174),"\",29) s PLIST(160)=$p(%mmmsqld(174),"\",30)
 s PLIST(52)="" f %irep=1:1:$g(^TEPI(PLIST(2),2,0)) s $li(PLIST(52),%irep)=$g(^(%irep))
 s PLIST(53)="" f %irep=1:1:$g(^TEPI(PLIST(2),3,0)) s $li(PLIST(53),%irep)=$g(^(%irep))
 s PLIST(69)=$$CT069^at42($g(PLIST(20)),$g(PLIST(2))) s PLIST(102)=$$CT091^at42($g(PLIST(99))) s PLIST(103)=$$CT091^at42($g(PLIST(100))) s PLIST(104)=$$CT091^at42($g(PLIST(101))) s PLIST(91)=$$CT091^at42($g(PLIST(4))) s PLIST(90)=$$CT090^at42($g(PLIST(3))) s PLIST(68)=$$CT068^at42($g(PLIST(2)))
 g:$zu(115,2)=0 %0GBuncommitted i $zu(115,2)=1 l +^TEPI($p(PLIST(2),"||",1))#"S":$zu(115,4) i $t { s %mmmsqld(170)=1,%mmmsqld(171)=$name(^TEPI($p(PLIST(2),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.EP_VisitNumber for RowID value: "_PLIST(2) ztrap "LOCK"  }
 ; asl MOD# 3
 i PLIST(2)'="",$d(^TEPI(PLIST(2)))
 e  g %0GCdun
 s %mmmsqld(177)=$g(^TEPI(PLIST(2),0))
 s PLIST(32)=$p(%mmmsqld(177),"\",1) s PLIST(33)=$p(%mmmsqld(177),"\",2) s PLIST(34)=$p(%mmmsqld(177),"\",3) s PLIST(35)=$p(%mmmsqld(177),"\",4) s PLIST(36)=$p(%mmmsqld(177),"\",5) s PLIST(37)=$p(%mmmsqld(177),"\",6) s PLIST(38)=$p(%mmmsqld(177),"\",7) s PLIST(39)=$p(%mmmsqld(177),"\",8) s PLIST(40)=$p(%mmmsqld(177),"\",9) s PLIST(41)=$p(%mmmsqld(177),"\",10) s PLIST(42)=$p(%mmmsqld(177),"\",11) s PLIST(43)=$p(%mmmsqld(177),"\",12) s PLIST(44)=$p(%mmmsqld(177),"\",13) s PLIST(46)=$p(%mmmsqld(177),"\",18) s PLIST(47)=$p(%mmmsqld(177),"\",30) s PLIST(50)=$p(%mmmsqld(177),"\",32) s PLIST(51)=$p(%mmmsqld(177),"\",33) s PLIST(84)=$p(%mmmsqld(177),"\",31) s PLIST(95)=$p(%mmmsqld(177),"\",14) s PLIST(96)=$p(%mmmsqld(177),"\",15) s PLIST(97)=$p(%mmmsqld(177),"\",16) s PLIST(98)=$p(%mmmsqld(177),"\",17) s PLIST(99)=$p(%mmmsqld(177),"\",23) s PLIST(100)=$p(%mmmsqld(177),"\",24) s PLIST(101)=$p(%mmmsqld(177),"\",25) s PLIST(105)=$p(%mmmsqld(177),"\",19) s PLIST(106)=$p(%mmmsqld(177),"\",20) s PLIST(107)=$p(%mmmsqld(177),"\",21) s PLIST(108)=$p(%mmmsqld(177),"\",22) s PLIST(109)=$p(%mmmsqld(177),"\",26) s PLIST(110)=$p(%mmmsqld(177),"\",27) s PLIST(112)=$p(%mmmsqld(177),"\",28) s PLIST(113)=$p(%mmmsqld(177),"\",29) s PLIST(124)=$p(%mmmsqld(177),"\",34)
 s %mmmsqld(177)=$g(^TEPI(PLIST(2),7))
 s PLIST(54)=$p(%mmmsqld(177),"\",1) s PLIST(55)=$p(%mmmsqld(177),"\",2) s PLIST(56)=$p(%mmmsqld(177),"\",3) s PLIST(57)=$p(%mmmsqld(177),"\",4) s PLIST(58)=$p(%mmmsqld(177),"\",5) s PLIST(59)=$p(%mmmsqld(177),"\",6) s PLIST(87)=$p(%mmmsqld(177),"\",7) s PLIST(162)=$p(%mmmsqld(177),"\",8)
 s %mmmsqld(177)=$g(^TEPI(PLIST(2),8))
 s PLIST(30)=$p(%mmmsqld(177),"\",11) s PLIST(45)=$p(%mmmsqld(177),"\",12) s PLIST(48)=$p(%mmmsqld(177),"\",1) s PLIST(49)=$p(%mmmsqld(177),"\",2) s PLIST(76)=$p(%mmmsqld(177),"\",3) s PLIST(77)=$p(%mmmsqld(177),"\",4) s PLIST(78)=$p(%mmmsqld(177),"\",5) s PLIST(79)=$p(%mmmsqld(177),"\",6) s PLIST(80)=$p(%mmmsqld(177),"\",7) s PLIST(81)=$p(%mmmsqld(177),"\",8) s PLIST(82)=$p(%mmmsqld(177),"\",9) s PLIST(83)=$p(%mmmsqld(177),"\",10) s PLIST(114)=$p(%mmmsqld(177),"\",13) s PLIST(115)=$p(%mmmsqld(177),"\",14) s PLIST(116)=$p(%mmmsqld(177),"\",15) s PLIST(117)=$p(%mmmsqld(177),"\",16) s PLIST(118)=$p(%mmmsqld(177),"\",17)
 s %mmmsqld(177)=$g(^TEPI(PLIST(2)))
 s PLIST(3)=$p(%mmmsqld(177),"\",1) s PLIST(4)=$p(%mmmsqld(177),"\",2) s PLIST(5)=$p(%mmmsqld(177),"\",3) s PLIST(6)=$p(%mmmsqld(177),"\",4) s PLIST(7)=$p(%mmmsqld(177),"\",5) s PLIST(8)=$p(%mmmsqld(177),"\",6) s PLIST(9)=$p(%mmmsqld(177),"\",7) s PLIST(10)=$p(%mmmsqld(177),"\",8) s PLIST(11)=$p(%mmmsqld(177),"\",9) s PLIST(12)=$p(%mmmsqld(177),"\",10) s PLIST(13)=$p(%mmmsqld(177),"\",11) s PLIST(14)=$p(%mmmsqld(177),"\",12) s PLIST(15)=$p(%mmmsqld(177),"\",13) s PLIST(16)=$p(%mmmsqld(177),"\",14) s PLIST(17)=$p(%mmmsqld(177),"\",15) s PLIST(18)=$p(%mmmsqld(177),"\",16) s PLIST(19)=$p(%mmmsqld(177),"\",17) s PLIST(20)=$p(%mmmsqld(177),"\",18) s PLIST(21)=$p(%mmmsqld(177),"\",19) s PLIST(22)=$p(%mmmsqld(177),"\",20) s PLIST(23)=$p(%mmmsqld(177),"\",21) s PLIST(24)=$p(%mmmsqld(177),"\",23) s PLIST(25)=$p(%mmmsqld(177),"\",24) s PLIST(26)=$p(%mmmsqld(177),"\",25) s PLIST(27)=$p(%mmmsqld(177),"\",26) s PLIST(28)=$p(%mmmsqld(177),"\",27) s PLIST(29)=$p(%mmmsqld(177),"\",28) s PLIST(31)=$p(%mmmsqld(177),"\",30) s PLIST(60)=$p(%mmmsqld(177),"\",31) s PLIST(61)=$p(%mmmsqld(177),"\",32) s PLIST(62)=$p(%mmmsqld(177),"\",33) s PLIST(63)=$p(%mmmsqld(177),"\",34) s PLIST(64)=$p(%mmmsqld(177),"\",35) s PLIST(65)=$p(%mmmsqld(177),"\",37) s PLIST(66)=$p(%mmmsqld(177),"\",36) s PLIST(67)=$p(%mmmsqld(177),"\",38) s PLIST(70)=$p(%mmmsqld(177),"\",39) s PLIST(71)=$p(%mmmsqld(177),"\",40) s PLIST(72)=$p(%mmmsqld(177),"\",41) s PLIST(73)=$p(%mmmsqld(177),"\",42) s PLIST(74)=$p(%mmmsqld(177),"\",22) s PLIST(75)=$p(%mmmsqld(177),"\",43) s PLIST(85)=$p(%mmmsqld(177),"\",29) s PLIST(86)=$p(%mmmsqld(177),"\",44) s PLIST(88)=$p(%mmmsqld(177),"\",45) s PLIST(89)=$p(%mmmsqld(177),"\",46) s PLIST(92)=$p(%mmmsqld(177),"\",47) s PLIST(93)=$p(%mmmsqld(177),"\",48) s PLIST(94)=$p(%mmmsqld(177),"\",49) s PLIST(111)=$p(%mmmsqld(177),"\",50) s PLIST(120)=$p(%mmmsqld(177),"\",51) s PLIST(121)=$p(%mmmsqld(177),"\",53) s PLIST(122)=$p(%mmmsqld(177),"\",52) s PLIST(123)=$p(%mmmsqld(177),"\",54) s PLIST(125)=$p(%mmmsqld(177),"\",55) s PLIST(126)=$p(%mmmsqld(177),"\",56) s PLIST(127)=$p(%mmmsqld(177),"\",57) s PLIST(128)=$p(%mmmsqld(177),"\",58) s PLIST(129)=$p(%mmmsqld(177),"\",59) s PLIST(130)=$p(%mmmsqld(177),"\",60) s PLIST(161)=$p(%mmmsqld(177),"\",61) s PLIST(163)=$p(%mmmsqld(177),"\",62) s PLIST(164)=$p(%mmmsqld(177),"\",63) s PLIST(165)=$p(%mmmsqld(177),"\",64) s PLIST(166)=$p(%mmmsqld(177),"\",65) s PLIST(167)=$p(%mmmsqld(177),"\",66)
 s PLIST(119)="" f %irep=1:1:$g(^TEPI(PLIST(2),"SN",0)) s $li(PLIST(119),%irep)=$g(^(%irep))
 s %mmmsqld(177)=$g(^TEPI(PLIST(2),"pc"))
 s PLIST(131)=$p(%mmmsqld(177),"\",1) s PLIST(132)=$p(%mmmsqld(177),"\",2) s PLIST(133)=$p(%mmmsqld(177),"\",3) s PLIST(134)=$p(%mmmsqld(177),"\",4) s PLIST(135)=$p(%mmmsqld(177),"\",5) s PLIST(136)=$p(%mmmsqld(177),"\",6) s PLIST(137)=$p(%mmmsqld(177),"\",7) s PLIST(138)=$p(%mmmsqld(177),"\",8) s PLIST(139)=$p(%mmmsqld(177),"\",9) s PLIST(140)=$p(%mmmsqld(177),"\",10) s PLIST(141)=$p(%mmmsqld(177),"\",11) s PLIST(142)=$p(%mmmsqld(177),"\",12) s PLIST(143)=$p(%mmmsqld(177),"\",13) s PLIST(144)=$p(%mmmsqld(177),"\",14) s PLIST(145)=$p(%mmmsqld(177),"\",15) s PLIST(146)=$p(%mmmsqld(177),"\",16) s PLIST(147)=$p(%mmmsqld(177),"\",17) s PLIST(148)=$p(%mmmsqld(177),"\",18) s PLIST(149)=$p(%mmmsqld(177),"\",19) s PLIST(150)=$p(%mmmsqld(177),"\",20) s PLIST(151)=$p(%mmmsqld(177),"\",21) s PLIST(152)=$p(%mmmsqld(177),"\",22) s PLIST(153)=$p(%mmmsqld(177),"\",23) s PLIST(154)=$p(%mmmsqld(177),"\",24) s PLIST(155)=$p(%mmmsqld(177),"\",25) s PLIST(156)=$p(%mmmsqld(177),"\",26) s PLIST(157)=$p(%mmmsqld(177),"\",27) s PLIST(158)=$p(%mmmsqld(177),"\",28) s PLIST(159)=$p(%mmmsqld(177),"\",29) s PLIST(160)=$p(%mmmsqld(177),"\",30)
 s PLIST(52)="" f %irep=1:1:$g(^TEPI(PLIST(2),2,0)) s $li(PLIST(52),%irep)=$g(^(%irep))
 s PLIST(53)="" f %irep=1:1:$g(^TEPI(PLIST(2),3,0)) s $li(PLIST(53),%irep)=$g(^(%irep))
 s PLIST(69)=$$CT069^at42($g(PLIST(20)),$g(PLIST(2))) s PLIST(102)=$$CT091^at42($g(PLIST(99))) s PLIST(103)=$$CT091^at42($g(PLIST(100))) s PLIST(104)=$$CT091^at42($g(PLIST(101))) s PLIST(91)=$$CT091^at42($g(PLIST(4))) s PLIST(90)=$$CT090^at42($g(PLIST(3))) s PLIST(68)=$$CT068^at42($g(PLIST(2)))
%0GBuncommitted ;
 s PLIST(1)=PLIST(2)
 s SQLCODE=0 g %0Gc
%0GCdun i $zu(115,2)=1,$g(%mmmsqld(170))=1 { l -@%mmmsqld(171) s %mmmsqld(170)=0 }
%0GBdun 
%0GAdun 
%0Gc s %ROWCOUNT='SQLCODE i $zu(115,2)=1,$g(%mmmsqld(170))=1 { l -@%mmmsqld(171) } q
%0Gerr s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) g %0Gc
%0Io n %mmmsqlc,%mmmsqld,%mmmsqlE,%mmmsqll,%mmmsqln,%mmmsqlp,%mmmsqlR,%mmmsqls,%mmmsqlt,%mmmsqlTS,%mmmsqlTS2,%mmmsqlZ s $zt="%0Ierr" s %mmmsqld(9)=0 s %mmmsqld(10)=""
 s %mmmsqld(2)=$g(RowID),%mmmsqld(5)=0
 s SQLCODE=100
 k:'$TLEVEL %0CacheLock If $zu(115,1)=2,'$TLEVEL { s %mmmsqlTS2=1 TSTART } If $zu(115,1) { s %mmmsqlTS=1 TSTART  }
 ; asl MOD# 2
 s %mmmsqld(1)=%mmmsqld(2)
 i %mmmsqld(1)'="",$d(^TEPI(%mmmsqld(1)))
 e  g %0IBdun
 s %mmmsqld(13)=$g(^TEPI(%mmmsqld(1)))
 s %mmmsqld(3)=$p(%mmmsqld(13),"\",44)
 s %mmmsqld(6)=$zu(28,%mmmsqld(3),7)
 g:'(((%mmmsqld(3)'="")&&(%mmmsqld(3)'=%mmmsqld(5)))||(%mmmsqld(6)=" ")) %0IBdun
 s %mmmsqld(14)=$$%getlock^User.EPVisitNumber.T1(%mmmsqld(1)) i '%mmmsqld(14) s SQLCODE=-110 g %0Ic
 ; asl MOD# 3
 s %mmmsqld(7)=$lb(""_%mmmsqld(3),""_%mmmsqld(6))
 i %mmmsqld(1)'="",$d(^TEPI(%mmmsqld(1)))
 e  g %0ICdun
 s %mmmsqld(17)=$g(^TEPI(%mmmsqld(1)))
 s %mmmsqld(3)=$p(%mmmsqld(17),"\",44)
 s %mmmsqld(6)=$zu(28,%mmmsqld(3),7)
 s %mmmsqld(8)=$lb(""_%mmmsqld(3),""_%mmmsqld(6))
 g:%mmmsqld(7)'=%mmmsqld(8) %0ICdun
 d %delete^User.EPVisitNumber.T1(%mmmsqld(1),$c(0,2,0,0),'$g(%mmmsqlTS))
 i 'SQLCODE i $i(%mmmsqld(9))'<$g(%0CacheRowLimit,9223372036854775807) d:%mmmsqld(14)=1 %ReleaseLock^User.EPVisitNumber.T1(%mmmsqld(1)) g %0Ic
%0ICdun 
 d:%mmmsqld(14)=1 %ReleaseLock^User.EPVisitNumber.T1(%mmmsqld(1)) g:SQLCODE<0 %0Ic
%0IBdun 
%0IAdun 
%0Ic s %ROWCOUNT=$s($g(SQLCODE)'<0:+$g(%mmmsqld(9)),1:0)
 If $zu(115,1),$g(%mmmsqlTS) { TCOMMIT:SQLCODE'<0  TROLLBACK:SQLCODE<0 1 } TCOMMIT:SQLCODE=100&&(%ROWCOUNT=0)&&($g(%mmmsqlTS2))&&($zu(115,1)=2)  q
%0Ierr s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) d:$g(%mmmsqld(14))=1 %ReleaseLock^User.EPVisitNumber.T1(%mmmsqld(1)) g %0Ic
%0Ko n %mmmsqlc,%mmmsqld,%mmmsqlE,%mmmsqll,%mmmsqln,%mmmsqlp,%mmmsqlR,%mmmsqls,%mmmsqlt,%mmmsqlTS,%mmmsqlTS2,%mmmsqlZ s $zt="%0Kerr" s %mmmsqld(3)=0 s %mmmsqld(4)=""
 s %mmmsqld(2)=$g(RowID)
 s SQLCODE=100
 k:'$TLEVEL %0CacheLock If $zu(115,1)=2,'$TLEVEL { s %mmmsqlTS2=1 TSTART } If $zu(115,1) { s %mmmsqlTS=1 TSTART  }
 ; asl MOD# 2
 s %mmmsqld(1)=%mmmsqld(2)
 i %mmmsqld(1)'="",$d(^TEPI(%mmmsqld(1)))
 e  g %0KBdun
 s %mmmsqld(7)=$$%getlock^User.EPVisitNumber.T1(%mmmsqld(1)) i '%mmmsqld(7) s SQLCODE=-110 g %0Kc
 ; asl MOD# 3
 i %mmmsqld(1)'="",$d(^TEPI(%mmmsqld(1)))
 e  g %0KCdun
 d %delete^User.EPVisitNumber.T1(%mmmsqld(1),$c(0,2,0,0),'$g(%mmmsqlTS))
 i 'SQLCODE i $i(%mmmsqld(3))'<$g(%0CacheRowLimit,9223372036854775807) d:%mmmsqld(7)=1 %ReleaseLock^User.EPVisitNumber.T1(%mmmsqld(1)) g %0Kc
%0KCdun 
 d:%mmmsqld(7)=1 %ReleaseLock^User.EPVisitNumber.T1(%mmmsqld(1)) g:SQLCODE<0 %0Kc
%0KBdun 
%0KAdun 
%0Kc s %ROWCOUNT=$s($g(SQLCODE)'<0:+$g(%mmmsqld(3)),1:0)
 If $zu(115,1),$g(%mmmsqlTS) { TCOMMIT:SQLCODE'<0  TROLLBACK:SQLCODE<0 1 } TCOMMIT:SQLCODE=100&&(%ROWCOUNT=0)&&($g(%mmmsqlTS2))&&($zu(115,1)=2)  q
%0Kerr s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) d:$g(%mmmsqld(7))=1 %ReleaseLock^User.EPVisitNumber.T1(%mmmsqld(1)) g %0Kc
%0Mo n %i,icol,ir
 f icol=0:1:167 i $d(PLIST(icol)) s %i(icol)=PLIST(icol)
 s %ROWID=$$%insert^User.EPVisitNumber.T1(.%i,$c(0,0,0,0)),%ROWCOUNT='SQLCODE
 q  // From %0Mo
%0Oo n %mmmsqlc,%mmmsqld,%mmmsqlE,%mmmsqll,%mmmsqln,%mmmsqlp,%mmmsqlR,%mmmsqls,%mmmsqlt,%mmmsqlTS,%mmmsqlTS2,%mmmsqlZ s $zt="%0Oerr" s %mmmsqld(4)=0 s %mmmsqld(5)=""
 s %mmmsqld(3)=$g(RowID)
 n %data,icol,ir
 s SQLCODE=100
 k:'$TLEVEL %0CacheLock If $zu(115,1)=2,'$TLEVEL { s %mmmsqlTS2=1 TSTART } If $zu(115,1) { s %mmmsqlTS=1 TSTART  }
 ; asl MOD# 2
 s %mmmsqld(2)=%mmmsqld(3)
 i %mmmsqld(2)'="",$d(^TEPI(%mmmsqld(2)))
 e  g %0OBdun
 s %mmmsqld(8)=$$%getlock^User.EPVisitNumber.T1(%mmmsqld(2)) i '%mmmsqld(8) s SQLCODE=-110 g %0Oc
 ; asl MOD# 3
 i %mmmsqld(2)'="",$d(^TEPI(%mmmsqld(2)))
 e  g %0OCdun
 k %data
 f icol=0:1:167 i $d(PLIST(icol)) s %data(icol)=PLIST(icol)
 d %update^User.EPVisitNumber.T1(%mmmsqld(2),$c(0,2,0,0),.%data,,'$g(%mmmsqlTS))
 i 'SQLCODE i $i(%mmmsqld(4))'<$g(%0CacheRowLimit,9223372036854775807) d:%mmmsqld(8)=1 %ReleaseLock^User.EPVisitNumber.T1(%mmmsqld(2)) g %0Oc
%0OCdun 
 d:%mmmsqld(8)=1 %ReleaseLock^User.EPVisitNumber.T1(%mmmsqld(2)) g:SQLCODE<0 %0Oc
%0OBdun 
%0OAdun 
%0Oc s %ROWCOUNT=$s($g(SQLCODE)'<0:+$g(%mmmsqld(4)),1:0)
 If $zu(115,1),$g(%mmmsqlTS) { TCOMMIT:SQLCODE'<0  TROLLBACK:SQLCODE<0 1 } TCOMMIT:SQLCODE=100&&(%ROWCOUNT=0)&&($g(%mmmsqlTS2))&&($zu(115,1)=2)  q
%0Oerr s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) d:$g(%mmmsqld(8))=1 %ReleaseLock^User.EPVisitNumber.T1(%mmmsqld(2)) g %0Oc
%0Qo n %mmmsqlc,%mmmsqld,%mmmsqlE,%mmmsqll,%mmmsqln,%mmmsqlp,%mmmsqlR,%mmmsqls,%mmmsqlt,%mmmsqlZ s $zt="%0Qerr" s %mmmsqld(10)=0,%mmmsqld(11)="",%mmmsqld(12)=0,%mmmsqld(13)=""
 s %mmmsqld(6)=$g(rowid)
 s SQLCODE=100
 ; asl MOD# 2
 s %mmmsqld(5)=%mmmsqld(6)
 s %mmmsqld(8)=$p(%mmmsqld(5),"||"),%mmmsqld(9)=$p(%mmmsqld(5),"||",2)
 i %mmmsqld(8)'="",%mmmsqld(9)'="",$d(^TBBP(%mmmsqld(8),%mmmsqld(9)))
 e  g %0QBdun
 s %mmmsqld(17)=$g(^TBBP(%mmmsqld(8),%mmmsqld(9)))
 s %mmmsqld(1)=$p(%mmmsqld(17),"\",8)
 g:$zu(115,2)=0 %0QBuncommitted i $zu(115,2)=1 l +^TBBP($p(%mmmsqld(5),"||",1),$p(%mmmsqld(5),"||",2))#"S":$zu(115,4) i $t { s %mmmsqld(10)=1,%mmmsqld(11)=$name(^TBBP($p(%mmmsqld(5),"||",1),$p(%mmmsqld(5),"||",2)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.BBP_PackDetails for RowID value: "_%mmmsqld(5) ztrap "LOCK"  }
 ; asl MOD# 3
 s %mmmsqld(8)=$p(%mmmsqld(5),"||"),%mmmsqld(9)=$p(%mmmsqld(5),"||",2)
 i %mmmsqld(8)'="",%mmmsqld(9)'="",$d(^TBBP(%mmmsqld(8),%mmmsqld(9)))
 e  g %0QCdun
 s %mmmsqld(21)=$g(^TBBP(%mmmsqld(8),%mmmsqld(9)))
 s %mmmsqld(1)=$p(%mmmsqld(21),"\",8)
%0QBuncommitted ;
 s %mmmsqld(2)=%mmmsqld(1)
 i %mmmsqld(2)'="",$d(^TTAB("BB-LOC",%mmmsqld(2)))
 e  s %mmmsqld(2)="",site="" g %0QCp5
 s %mmmsqld(26)=$g(^TTAB("BB-LOC",%mmmsqld(2)))
 s site=$p(%mmmsqld(26),"\",2)
%0QCp5 
 g:$zu(115,2)=0 %0QCuncommitted i $zu(115,2)=1 l +^TTAB("BB-LOC",$p(%mmmsqld(2),"||",1))#"S":$zu(115,4) i $t { s %mmmsqld(12)=1,%mmmsqld(13)=$name(^TTAB("BB-LOC",$p(%mmmsqld(2),"||",1)))_"#""SI""" } else { s SQLCODE=-114,%msg="Unable to acquire shared lock on table SQLUser.CTBB_Location for RowID value: "_%mmmsqld(2) ztrap "LOCK"  }
 ; asl MOD# 4
 i %mmmsqld(2)'="",$d(^TTAB("BB-LOC",%mmmsqld(2)))
 e  s %mmmsqld(2)="",site="" g %0QDp1
 s %mmmsqld(31)=$g(^TTAB("BB-LOC",%mmmsqld(2)))
 s site=$p(%mmmsqld(31),"\",2)
%0QDp1 
%0QCuncommitted ;
 s SQLCODE=0 g %0Qc
%0QDdun i $zu(115,2)=1,$g(%mmmsqld(12))=1 { l -@%mmmsqld(13) s %mmmsqld(12)=0 }
%0QCdun i $zu(115,2)=1,$g(%mmmsqld(10))=1 { l -@%mmmsqld(11) s %mmmsqld(10)=0 }
%0QBdun 
%0QAdun 
%0Qc s %ROWCOUNT='SQLCODE i $zu(115,2)=1,$g(%mmmsqld(10))=1 { l -@%mmmsqld(11) } i $zu(115,2)=1,$g(%mmmsqld(12))=1 { l -@%mmmsqld(13) } q
%0Qerr s $zt="" d SQLRunTimeError^%apiSQL($ze,.SQLCODE,.%msg) g %0Qc
]]></Routine>
</Export>
