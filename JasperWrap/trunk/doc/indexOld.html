<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=windows-1251" /> 
<h1><b>Создание отчетов с помощью jasperreports в ЛИС.</b></h1>

<style type="text/css">
body {
	font-family: "lucida sans unicode";
        font-size: 1.3em;
}
a {
	font-family: "lucida sans unicode";
        font-size: 1.3em;
}

table {
	font-family: "lucida sans unicode";
        font-size: 1.3em;
}

</style>

</head>

<body>
<br />
  <table>
    <tr>
       <td>
         <a href=#TutorForCustomer>Руководство для пользователя</a>
      </td>
    </tr>
    <tr>
       <td>
         <a href="Настройки для использования отчетов JasperReport.doc">Настройки сервера Cache для работы с Jasperreports</a>
      </td>
    </tr>  
     <tr>
       <td>
         <a href=#Structure>Описание внутренней структуры</a>
      </td>
    </tr>    
  </table>
<br />


<br />
<a name="TutorForCustomer"><b>Описание для пользователя</b></a>
  <br />
  <p>
     Процесс создания отчета состоит из трех шагов: двух вспомогательных - описание экрана для запроса параметров отчета, вставка отчета в меню ЛИС - 
  <br>
     и основной шаг - создание шаблона отчета в iReport.
  </p>
 <ol>
   <li> <b>Описание экрана для запроса параметров отчета </b></li>
    <ol type="a">
      <li>
        <p>
          Создаем новую программу (int) в Cache Studio с любым именем nameRoutine.int.
          Пример такой программы:
          <img src="exampleRoutine.png"   />
        </p>
      </li>
      <li>
        <p>
          <p><b>Структура глобали для описания параметров:</b> ^имя глобали($job,"имя параметра (english)")=строка описания параметра (например, ^temp($job,"param1")=$listbuild("Label",1,1,,,,,"Текст")</p>
          <a href=#StructureParamString><b>Структура строки для описания параметра</b> (структура $list)</a>
          <ol>
              <li>Тип параметра ( Label,Text,DateText,ComboBox,ListBox,CheckBox,RadioButton,Table ) </li>
              <li>Номер строки, в которой будет расположен параметр</li>
              <li>Номер столбца, в котором будет расположен параметр</li>
              <li>Ширина поля (неизвестно в чем)</li>
              <li>Зарезервировано</li>
              <li>Зарезервировано</li>
              <li>Зарезервировано</li>
              <li>Текст для параметра Label или начальное значение для остальных типов параметров</li>
              <li>sql запрос для типов ComboBox, ListBox, Table</li>
              <li>sql запрос для выбора одной записи по ее коду - нужно для того, чтобы работал поиск в ComboBox <a href=#ListBox>(подробнее)</a> </li>  
              <li>1-возможно выбрать несколько строк для ListBox </li>
          </ol>
          <p><b>Обязательные данные </b>: ^имя глобали($job)=$listbuild("Заголовок окна запроса параметров","имя шаблона jasper(например, rpt51.jasper)")</p>

          <p>Данные для параметров типа ComboBox, ListBox, Table возможно заполнять не только через sql запрос, но и напрямую в узлах ^temp($job,"param1","data",node)=value, где <br>
             где node - код, value - значение. Для типа параметра RadioButton это единственный способ определения данных. 
             <br>Пример:<br>  <img src="exampleRoutine3.png"   /> 
          </p>
          <p>Для параметров типа ComboBox, ListBox, Table, у которых задан sql запрос, возможно связать их содержимое со значением, выбранным в другом параметре.
          <br>Для этогов узлах ^temp($job,"param1","param",порядковый номер параметра для sql запроса (порядковый номер ?))=имя связанного параметра
          <br>Например, для связывания списка исследований (параметр testset) cо списком отделов (department) <img src="exampleRoutine2.png"   /> </p>

        </p>
      </li>
    </ol>

    <li><b><a name="InsertInMenu">Вставка отчета в меню ЛИС </b></a> </li>
      <ol type="a">
        <li>В ЛИС Классификатор->Система->Отчет-Описание Trak-программы вставить новую строку (в поле Код указать уникальный id вашего отчета (например, CLNRUS51),<br/>
            в поле Описание - название отчета, в поле Имя программы - имя программы с описанием окна запроса параметров (например PRTCLNRUS51) (без расширения), <br/>
            в поле Показ. поставить галочку. Для сохранения информации надо нажать кнопку Добавить   
        </li>
          <img src="insertInMenuLIS1.png"  />
        <li><p>В ЛИС Классификатор->Система->Отчет-Настройка отчетов в поле в левом нижнем углу ввести id отчета и нажать Tab, к уже имеющейся информации добавить: <br/>
            в поле DLL name - PRTCLNRUS.clsStart, в поле Группа отчетов - указать подменю, в котором будет вызываться данный отчет. <br/> Для сохранения надо нажать кнопку Обновить 
            </p>
        </li>
        <img src="insertInMenuLIS2.png" />   
      </ol>
  <br>


    <li><b> Создание шаблона отчета в Jasperreports </b></li>
     <ol type="a">
       <li>При первом запуске отчета, если файл с jasper шаблоном еще не создан, формируется jasper шаблон со всеми заданными параметрами и их значениями. 
       <br>(Поля с параметрами располагаются в Header и флаг When No Data = All Sections, No Details)</li>
       <li><a href="http://jasperforge.org/website/jasperreportswebsite/trunk/documentation.html?header=project&target=jasperreports">Руководство пользователя</a> </li>
       <li>Для создания шаблона отчета удобно пользоваться <a href="http://jasperforge.org/projects/ireport">iReport</a></li>       
       <li><p>
        В шаблоне отчета надо обязательно объявить параметры шаблона с именами параметров отчета, (например,DateFrom,DateTo,ExLab), в них при формировании отчета загрузятся выбранные пользователем значения параметров отчета.  
        Для типов параметров ListBox,ComboBox,Table надо дополнительно объявить параметры ИмяПараметраDisplay (например, ExLabDisplay)<br> Подробнее про ListBox, ComboBox и Table<a href=#ListBox>здесь</a> 
        </p></li>
      <li>
      <p>
       Для установки связи с БД Cache необходимо в iReport создать новый источник данных (см. рисунок)
      </p>
       <img src="ireport1.png"  />
       Параметры:
       <ul>
        <li>Datasourse type : Database JDBC connection
        <li>Name: любое (например, isc_DATA)
        <li>JDBC driver: com.intersys.jdbc.CacheDriver
        <li>JDBC URL: jdbc:Cache://localhost:номер порта супер сервера Cache/область Cache (например, jdbc:Cache://localhost:21025/DATA)
        <li>User Name : report
        <li>Password : report
       </ul>
       <img src="ireport2.png"  />
       <p>Для проверки связи можно нажать кнопочку Test</p>
      </li> 
     </ol> 


   
 </ol>


<br />
<a name="Structure"><b>Описание внутренней структуры работы программ</b></a>
  <br />
<ul>
  <li>
   ЛИС вызывает класс clsStart в PRTCLNRUS.dll (dll должна быть зарегистрирована на клиентской машине) (этот класс указываем в описании <a href=#InsertInMenu>Вставка отчета в меню ЛИС</a> ) 
  </li>
  <li> 
  <p>
  В dll делается вызов программы Cache для получения URL $$getReportURL^TCLEx.VBReport() (имя программы для обработки отчета берется из ^TMP("REPORTSPB",$j)) и с помощью ShellExecute запускается браузер
  </p> 
  <p>ErrorLevel = ShellExecute(vbNull, "open", reportURL, vbNull, vbNull, 1)  </p>
  </li>
  <li>
  <p>В качестве URL $$getReportURL^TCLEx.VBReport() возвращает строку вызова класса ReportZEN.genRpt.cls с двумя параметрами user=,reportRoutine= (например, http://lissrv:57772/csp/bion/ReportZEN.genRpt.cls?user=demo&reportRoutine=PRTCLNRUS51)</p>
  <p>Класс ReportZEN.genRpt.cls генерит окно для ввода параметров отчета по описанию, данному в программе reportRoutine</p>
  <p>При нажатии кнопочки Печать запускается программа запуска генерации отчета Jasperreports, в которую передается название шаблона отчета, массив параметров для отчета и имя и путь к сгенерированному файлу отчета</p>
  <p>После создания файла отчета с помощью класса ReportZEN.downloadFile.cls поток с содержимым файла отчета передается на компьютер клиента и открывается в браузере</p>
  </li>
<ul>

<br />

<a name="StructureParamString"><b>Структура строки для описания параметра</b></a>

<table border="solid">
 <tr>
  <td>
      Номер в $piece/$list
   </td>
  <td>
      Суть
   </td>
 </tr>
 <tr>
   <td colspan=2>
      <b>Для всех типов</b>
   </td>
 </tr>
 <tr>
  <td>
      1
   </td>
  <td>
      Тип параметра
  </td>
 </tr>
 <tr>
  <td>
      2
   </td>
  <td>
     Номер колонки, в которой будет расположен параметр 
  </td>
 </tr>
 <tr>
  <td>
      3
   </td>
  <td>
     Номер строки, в которой будет расположен параметр
  </td>
 </tr>
 <tr>
  <td>
      4
  </td>
  <td>
    Ширина поля (неизвестно в чем)
  </td>
 </tr>
 <tr>
  <td>
      5
   </td>
  <td>
    Зарезервировано
  </td>
 </tr>
 <tr>
 <tr>
  <td>
      6
   </td>
  <td>
    colspan
  </td>
 </tr>
 <tr>
 <tr>
  <td>
      7
   </td>
  <td>
    rowspan - предположительно
  </td>
 </tr>
 <tr>
  <td colspan=2>
      <b>Label</b>
   </td>
  <td>
  </td>
 </tr>
 <tr>
  <td>
      8
  </td>
  <td>
    Текст Label
  </td>
 </tr>

<tr>
  <td colspan=2>
      <b>DateText</b>
   </td>
  <td>
  </td>
 </tr>
 <tr>
  <td>
      8
   </td>
  <td>
   Начальное значение (t-текущая дата, t+n - n дней плюс к текущей дате, t-n - n дней минус от текущей даты)
  </td>
 </tr>
 <tr>
  <td colspan=2>
     <b>CheckBox</b>
   </td>
  <td>
  </td>
 </tr>
 <tr>
  <td>
      8
   </td>
  <td>
   Начальное значение (1-включен, 0-выключен)
  </td>
 </tr>
 <tr>
  <td>
      9
   </td>
  <td>
   Текст около
  </td>
 </tr>

  <tr>
  <td colspan=2>
     <b>ListBox</b>
   </td>
  <td>
  </td>
 </tr>
 <tr>
  <td>
      8
   </td>
  <td>
   Зарезервировано
  </td>
 </tr>
 <tr>
  <td>
     9
   </td>
  <td>
   sql запрос 
  </td>
 </tr>
 <tr>
  <td>
      10
   </td>
  <td>
   sql запрос для выбора одной записи по ее коду - нужно для того, чтобы работал поиск <a href=#ListBox>(подробнее)    
  </td>
 </tr>


  <tr>
  <td colspan=2>
     <b>ComboBox</b>
   </td>
  <td>
  </td>
 </tr>
 <tr>
  <td>
      8
   </td>
  <td>
   Зарезервировано
  </td>
 </tr>
 <tr>
  <td>
      9
   </td>
  <td>
   sql запрос 
  </td>
 </tr>
 <tr>
  <td>
      10
   </td>
  <td>
   sql запрос для выбора одной записи по ее коду - нужно для того, чтобы работал поиск <a href=#ListBox>(подробнее)   
  </td>
 </tr>
 <tr>
  <td>
      11
   </td>
  <td>
    valueColumn - столбец, который попадает в jasperreport как значение этого параметра (по умолчанию = "1") (работает только, если задан sql запрос) 
  </td>
 </tr>
 <tr>
  <td>
      12
   </td>
  <td>
    displayColumns - строка, в которой через запятую перечислены столбцы, которые должны быть показаны в окне  (по умолчанию = "2") (работает только, если задан sql запрос) 
  </td>
 </tr>

  <tr>
  <td colspan=2>
     <b>Table</b>
   </td>
  <td>
  </td>
 </tr>
 <tr>
  <td>
      8
   </td>
  <td>
   Зарезервировано
  </td>
 </tr>
 <tr>
  <td>
     9
   </td>
  <td>
   sql запрос 
  </td>
 </tr>
<tr>
  <td>
      10
   </td>
  <td>
     
  </td>
 </tr>
</tr>
 <tr>
  <td>
      11
   </td>
  <td>
  </td>
 </tr>
 <tr>
  <td>
      12
   </td>
  <td>
 
  </td>
 </tr>


</table>
 
<br />
<a name="ListBox"><b>Описание параметров отчета типа ListBox и ComboBox</b></a>
  <br />
<p>
 Рассмотрим параметр с именем ExLab типа ComboBox (sql: select CTRL_Code,CTRL_Description from SQLUser.CT_ReferralLaboratory)
</p>
<p>
  Первое поле в sql запросе - это ключ (valueColumn) для массива строк (передается в jasperreports как параметр ExLab)
</p>
<p>
  Второе поле - то, что выводится на экран (displayColumns) (передается в jasperreports как параметр ExLabDisplay)
</p>
<p>
  То есть в шаблоне для отчета надо описать параметры ExLab, ExLabDisplay и пользоваться ими в sql Запросе к базе данных (ExLab) и при выводе на экран (ExLabDisplay)
</p>
<p>
 Для того чтобы работал поиск необходимо написать два sql запроса на 7 и 8 месте в строке описания параметра (через ":")
 <br>
Пример: sql (7 место) select CTRL_Code,CTRL_Description from SQLUser.CT_ReferralLaboratory where CTRL_Description %STARTSWITH ? ORDER BY CTRL_Description
<br>
   sql (8 место) select CTRL_Description from SQLUser.CT_ReferralLaboratory where CTRL_Code = ? 
</p>

</body>
</html>
