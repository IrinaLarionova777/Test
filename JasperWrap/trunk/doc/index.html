<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=windows-1251" /> 
<h1><b>Создание отчетов с помощью jasperreports в ЛИС.</b></h1>

<style type="text/css">
body {
	font-family: "lucida sans unicode";
        font-size: 1.3em;
}
a {
	font-family: "lucida sans unicode";
        font-size: 1.3em;
}

table {
	font-family: "lucida sans unicode";
        font-size: 1.3em;
}

</style>

</head>

<body>
<br />
  <table>
    <tr>
       <td>
         <a href=#TutorForCustomer>Руководство для пользователя</a>
      </td>
    </tr>
    <tr>
       <td>
         <a href="Настройки для использования отчетов JasperReport.doc">Настройки сервера Cache для работы с Jasperreports</a>
      </td>
    </tr>  
     <tr>
       <td>
         <a href=#Structure>Описание внутренней структуры</a>
      </td>
    </tr>    
  </table>
<br />


<br />
<a name="TutorForCustomer"><b>Описание для пользователя</b></a>
  <br />
  <p>
     Для создания отчета необходимо:
<ol>
   <li> Cоздать шаблон отчета для jasperreports (<a href=#iReport>например, с помощью iReport</a>).</li>
   <li> Если перед созданием отчета какие-то параметры из шаблона надо запросить у пользователя, то в описание этих параметров необходимо добавить дополнительные свойства.(<a href=#ParamDescription>Описание</a>) 
   <li> <a href=#InsertInMenu>Вставить отчет в меню ЛИС.</a>
</ol>

<ol> 
   <br>


    <li><b><a name="iReport"> Создание шаблона отчета в iReport </b></li>
     <ol type="a">
       <li><a href="http://jasperforge.org/website/ireportwebsite/IR%20Website/ir_download.html?header=project&target=ireport">download iReport</a> </li> 
       <li><a href="http://jasperforge.org/website/jasperreportswebsite/trunk/documentation.html?header=project&target=jasperreports">Руководство пользователя</a> </li>
       <li>Для создания шаблона отчета удобно пользоваться <a href="http://jasperforge.org/projects/ireport">iReport</a></li>       
      <li>
      <p>
       В настройках iReport (Tools->Options-Classpath: добавить jar-библиотеку <path cache>\dev\java\lib\JDK16\CacheDB.jar 
      </p>
      <p>
       Для установки связи с БД Cache необходимо в iReport создать новый источник данных (см. рисунок)
      </p>
       <img src="ireport1.png"  />
       Параметры:
       <ul>
        <li>Datasourse type : Database JDBC connection
        <li>Name: любое (например, isc_DATA)
        <li>JDBC driver: com.intersys.jdbc.CacheDriver
        <li>JDBC URL: jdbc:Cache://localhost:номер порта супер сервера Cache/область Cache (например, jdbc:Cache://localhost:21025/DATA)
        <li>User Name : report
        <li>Password : report
       </ul>
       <img src="ireport2.png"  />
       <p>Для проверки связи можно нажать кнопочку Test</p>
      </li> 
     </ol> 

<li><b><a name="ParamDescription">Описание параметров шаблона для запроса их у пользователя </b></a> </li>
      <ol type="a">
        Для того чтобы параметр попал в экран запроса , надо у этого параметра ввести Description и определить свойтво typeElement (not case sensetive) одним из следующих значений
        <br>
        (text,checkbox,radiobutton,combobox,listbox,table (not case sensetive)). Тогда в экране запроса параметров появится строка - Description : поле для ввода соответсвующего типа.
        <br>
        
        <br><br>
        Особенности :
        <ul>
          <li>Если у параметра тип Java.util.Date, то определять свойство typeElement не надо (параметр выводится автоматически)\
          <li>Если Description введен, а свойство typeElement не определено, то на экране появляется поле для ввода текста (typeElement=text) 
          <li>Для typeElement=combobox,listbox,table значение параметра=код выбранной строки (первое поле из sql запроса в случае sql). 
             <br>Одновременно определяется дополнительный параметр <nameParameter>Display c соответсвующей строкой (со второго и далее поля из sql запроса в случае sql)   
        </ul>
        <br>
        Если в списке свойств параметра определить любое свойство соответсвующего ZEN-компонента, то оно проинициализируется у ZEN-компонента.
        <br><br>
        Для некоторых typeElement существуют обязательные свойства для заполнения:
        <ul>
          <li>Для typeElement=combobox,listbox,table обязательно определить или поле sql или несколько полей типа (data_key=value, часть data_ обязательна)
          <li>Для typeElement=radiobutton обязательно определить одно или несколько полей типа ("data_key=value)
        </ul>
        <br>
        Возможные свойства:
        <ul>
          <li>Для всех элементов (пока не работает для combobox, listbox, table с sql) можно определить свойство initValue (not case sensetive)
          <br>Для Date типа t+-n - текущая дата +- n дней, также возможно определелить функцию или метод класса для инициализации параметра типа Date (должна возвращаться дата в формате gggg-mm-dd).
          <ul>
           <li>
             Например, для инициализации параметра типа Date датой начала предыдущего месяца
             <br>getFirstDate() {
                <br>$zd($$FirstDateOfMonthH^KSUTIL1($$PreviousMonth^KSUTIL1($$CurrentMonth^KSUTIL1())),3)
             <br>}
           <li>
             Например, для инициализации параметра типа Date датой окончания предыдущего месяца
                 <br>getLastDate() {
                 <br>$zd($$LastDateOfMonthH^KSUTIL1($$PreviousMonth^KSUTIL1($$CurrentMonth^KSUTIL1())),3)
                 <br> } 
          </ul>
            <br>для checkbox 1/0 - включено/выключено, для остальных очевидно
          <li>Для tyleElement=table с определенным свойством sql multiSelect=1 включает режим выбора нескольких записей в списке. Значение параметра при этом - список выбранных кодов через запятую (кодом считается первое поле в sql запросе)
          <li>Возможно определить binding для параметров typeElement=combobox,listbox,table с sql запросом. 
          <br>Для этого в sql запросе надо сделать запрос параметра через ? и определить свойство bind_(имя параметра, от которого данный параметр зависит) (часть bind_ обязательна)
          <li>Возможно определить заголовки и ширины столбцов для параметра typeElement=table с sql запросом. 
          <br>Для этого надо определить свойства column_(имя столбца в sql запросе)=заголовок столбца^ширина столбца (часть column_ обязательна)
          
       </ol>
  <br>
  <br>Возможно проверить введенные параметры перед формированием отчета. Для этого надо определить метод Validate (ClassMethod Validate(ByRef params As %String) As %String) 
  <br>у класса Report.Jasper.(имя отчета) (имя отчета заглавными буквами, так как Trak всегда переводит его в заглавные).
  <br> Метод Validate() должен возвращать строку: 1/0(ok/ошибка)_$char(0)_сообщение об ошибке
   <br> Пример метода Validate
        <br>ClassMethod Validate(ByRef params As %String) As %String
          <br>{
	     <br>set date1=$piece($get(params("DateFrom")),$char(0),1)
	     <br>set date2=$piece($get(params("DateTo")),$char(0),1)
	     <br>if date1>date2 quit 0_$c(0)_"Дата начала больше даты окончания"
	<br>if $get(params("ExternalLab2"))="" quit 0_$c(0)_"Не определена внешняя лаборатория"
	<br>quit 1
        <br>}

<li><b><a name="InsertInMenu">Вставка отчета в меню ЛИС </b></a> </li>
      <ol type="a">
        <li>В ЛИС Классификатор->Система->Отчет-Описание Trak-программы вставить новую строку: в поле Код указать имя файла jrxml без расширения,<br/>
            в поле Описание - название отчета, в поле Показ. поставить галочку. Для сохранения информации надо нажать кнопку Добавить   
        </li>
          <img src="insertInMenuLIS1new.png"  />
        <li><p>В ЛИС Классификатор->Система->Отчет-Настройка отчетов в поле в левом нижнем углу ввести Код отчета (имя файла jrxml без расширения) и нажать Tab, 
               к уже имеющейся информации добавить: <br/>
            в поле DLL name - PRTCLNRUS.clsStart, в поле Группа отчетов - указать подменю, в котором будет вызываться данный отчет. <br/> Для сохранения надо нажать кнопку Обновить 
            </p>
        </li>
        <img src="insertInMenuLIS2new.png" />   
      </ol>
  <br>


   
 </ol>


<br />
<a name="Structure"><b>Описание внутренней структуры работы программ</b></a>
  <br />
<ul>
  <li>
   ЛИС вызывает класс clsStart в PRTCLNRUS.dll (dll должна быть зарегистрирована на клиентской машине) (этот класс указываем в описании <a href=#InsertInMenu>Вставка отчета в меню ЛИС</a> ) 
  </li>
  <li> 
  <p>
  В dll делается вызов программы Cache для получения URL $$getReportURL^TCLEx.VBReport() (имя программы для обработки отчета берется из ^TMP("REPORTSPB",$j)) и с помощью ShellExecute запускается браузер
  </p> 
  <p>ErrorLevel = ShellExecute(vbNull, "open", reportURL, vbNull, vbNull, 1)  </p>
  </li>
  <li>
  <p>В качестве URL $$getReportURL^TCLEx.VBReport() возвращает строку вызова класса ReportZEN.genRpt.cls с параметрами user=,fileJRXML=,reportKey= (например, http://localhost:57772/csp/BION/ReportZEN.genReportJasper.cls?user=demo&fileJRXML=REPORT22.jrxml&reportKey=REPORT22)</p>
  <p>Класс ReportZEN.genJasperReport.cls генерит окно для ввода параметров отчета по описанию, данному в шаблоне fileJRXML</p>
  <p>При нажатии кнопочки Печать запускается программа запуска генерации отчета Jasperreports, в которую передается название шаблона отчета, массив параметров для отчета и имя и путь к сгенерированному файлу отчета</p>
  <p>После создания файла отчета с помощью класса ReportZEN.downloadFile.cls поток с содержимым файла отчета передается на компьютер клиента и открывается в браузере</p>
  </li>
<ul>

<br />


</body>
</html>
