<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="24">
<Class name="TCLEx.Utils.bion">
<Super>%RegisteredObject</Super>
<TimeCreated>63368,48799.908966</TimeCreated>

<Method name="CorrectDateOfReason">
<Description>
В версии 2012 когда причина отмены набора тестов пустая, записывается дата, время и user отмены - корректировка
Обновились до версии 2012 где-то в 04.2014, ошибку обнаружили 06.2014</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	 set epis="" 
	 for {
	 set epis=$order(^TEPI(epis)) if epis="" quit
	 
     set ts=""
     for {
	  set ts=$order(^TEPI(epis,1,ts)) if ts="" quit
	  set tscnt=""
	  for {
		  set tscnt=$o(^TEPI(epis,1,ts,tscnt),1,rects) if tscnt="" quit 
		  set reason=$p(rects,"\",52)
		  set dateOfreason=$p(rects,"\",54)  
	      if (reason="")&&(dateOfreason'="") {
		      set rowid=epis_"||"_ts_"||"_tscnt
		      set obj=##class(User.EPVisitTestSet).%OpenId(rowid)
		      set obj.VISTSDateOfReason=""
		      set obj.VISTSTimeOfReason=""
		      set obj.VISTSUserReasonDR=""
		      do obj.%SetModified(1)
		      set ok=obj.%Save()
		      if ok { set ^log("correctDateOfReason","ok",rowid)="" }
		      else { set ^log("correctDateOfReason","notok",rowid)=$system.Status.GetErrorText(ok) }
	      }
	  }
     }
	 }
]]></Implementation>
</Method>

<Method name="CorrectCTTestSet">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set horolog=$h
	set ts=""
    for {
	   set ts=$order(^TTAB("TS",ts),1,rec) if ts="" quit
	   set name=$piece(rec,"\",1),reportname=$piece(rec,"\",17)
	   if reportname="" continue
	   set ^TTAB("TS",ts,"LAN",20)=reportname
	   set $piece(^TTAB("TS",ts),"\",17)="*"
	   set ^log("correctTestSet",horolog,ts)="reportname="_reportname
    }
]]></Implementation>
</Method>
</Class>
</Export>
